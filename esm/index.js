import*as e from"three";import{Box3 as t,Vector3 as n,InstancedBufferGeometry as i,Float32BufferAttribute as o,InstancedInterleavedBuffer as s,InterleavedBufferAttribute as a,WireframeGeometry as r,Sphere as l,UniformsLib as c,Vector2 as h,ShaderLib as u,UniformsUtils as d,ShaderMaterial as p,Vector4 as f,Matrix4 as m,Line3 as b,Mesh as y,MathUtils as x,Loader as v,FileLoader as g,ShapePath as w,ExtrudeGeometry as k,BufferGeometry as E}from"three";import{ElMessageBox as S,ElInput as P,ElMessage as M}from"element-plus";import{ref as L,h as D}from"vue";import{Text as T}from"troika-three-text";const A=(t,n,i)=>{let o=new e.Vector2;o.x=t/window.innerWidth*2-1,o.y=-n/window.innerHeight*2+1;let s=new e.Vector3(o.x,o.y,0);return s.unproject(i),s};let O=0;const C=(e,t)=>{(new Date).getTime()-O>t&&(e(),O=(new Date).getTime())},N=(e,t,n)=>{if(void 0===e||void 0===t||void 0===n)return;const i=e=>{const t=e.toString(16);return 1===t.length?"0"+t:t};return`#${i(e)}${i(t)}${i(n)}`},I=e=>{e=e.replace(/^#/,"");return{r:parseInt(e.substring(0,2),16),g:parseInt(e.substring(2,4),16),b:parseInt(e.substring(4,6),16)}};let j,z,V,F,R=0,B=0,_=0,H=0,Y=!1;const X=e=>{Y=!0,R=e.clientX,B=e.clientY,j||(j=document.createElement("div"),j.id="selectBox",document.body.appendChild(j)),j.style.cssText="\n        position: absolute;\n        width: 0;\n        height: 0;\n        margin: 0;\n        padding: 0;\n        border: 1px dashed #eee;\n        z-index: 1000;\n        opacity: 0.6;\n        display: none;\n    ",j.style.left=R+"px",j.style.top=B+"px"},U=e=>{Y&&(_=e.clientX,H=e.clientY,j.style.display="block",j.style.left=Math.min(_,R)+"px",j.style.top=Math.min(H,B)+"px",j.style.width=Math.abs(_-R)+"px",j.style.height=Math.abs(H-B)+"px")},W=e=>{_=e.clientX,H=e.clientY;const t=_-R,n=H-B;if(Math.abs(t)<2||Math.abs(n)<2)return void G();const i=((e,t)=>{const n=window.innerWidth/Math.abs(e),i=window.innerHeight/Math.abs(t);return Math.min(n,i)})(t,n),o={x:R+t/2,y:B+n/2};F(o.x,o.y,i),G(),$()},G=()=>{Y=!1,R=0,B=0,j.style.display="none"},q=()=>{V(),document.addEventListener("mousedown",X,!1),document.addEventListener("mousemove",U,!1),document.addEventListener("mouseup",W,!1)},$=()=>{document.removeEventListener("mousedown",X,!1),document.removeEventListener("mousemove",U,!1),document.removeEventListener("mouseup",W,!1),z()};let J=0;let K=0;let Z,Q,ee;function te(t,n){this.object=t,this.domElement=void 0!==n?n:document,Z=n,this.enabled=!0,this.target=new e.Vector3,this.center=this.target,this.noZoom=!1,this.zoomSpeed=1,this.minDistance=0,this.maxDistance=1/0,this.noRotate=!1,this.rotateSpeed=1,this.noPan=!1,this.keyPanSpeed=7,this.autoRotate=!1,this.autoRotateSpeed=2,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.noKeys=!1,this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40};var i=this,o=new e.Vector2,s=new e.Vector2,a=new e.Vector2,r=new e.Vector2,l=new e.Vector2,c=new e.Vector2,h=new e.Vector3,u=new e.Vector3,d=new e.Vector2,p=new e.Vector2,f=new e.Vector2,m=1,b=new e.Vector3;new e.Vector3;var y={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_DOLLY:4,TOUCH_PAN:5},x=y.NONE;this.target0=this.target.clone(),this.position0=this.object.position.clone();var v={type:"change"},g={type:"start"},w={type:"end"};function k(){return 2*Math.PI/60/60*i.autoRotateSpeed}function E(){return Math.pow(.95,i.zoomSpeed)}function S(e){((e,t)=>{(new Date).getTime()-K>t&&(e(),K=(new Date).getTime())})((()=>{P(e)}),20)}function P(t){if(!1!==i.enabled&&(t.preventDefault(),x===y.PAN)){if(!0===i.noPan)return;let n=new e.Vector2;n.x=t.clientX/window.innerWidth*2-1,n.y=-t.clientY/window.innerHeight*2+1;let o=new e.Vector3(n.x,n.y,0);o.unproject(i.object),l.set(o.x,o.y),c.subVectors(l,r),i.object.position.sub(new e.Vector3(c.x,c.y,0)),i.dispatchEvent(v)}}function M(){!1!==i.enabled&&(i.domElement.removeEventListener("mousemove",P,!1),i.domElement.removeEventListener("mouseup",M,!1),i.dispatchEvent(w),x=y.NONE)}this.rotateLeft=function(e){void 0===e&&(e=k())},this.rotateUp=function(e){void 0===e&&(e=k())},this.panLeft=function(e){var t=this.object.matrix.elements;h.set(t[0],t[1],t[2]),h.multiplyScalar(-e),b.add(h)},this.panUp=function(e){var t=this.object.matrix.elements;h.set(t[4],t[5],t[6]),h.multiplyScalar(e),b.add(h)},this.pan=function(e,t){var n=i.domElement===document?i.domElement.body:i.domElement;void 0!==i.object.top&&(console.log("正交相机",e,i.object.right-i.object.left,n.clientWidth),i.panLeft(e*(i.object.right-i.object.left)/n.clientWidth),i.panUp(t*(i.object.top-i.object.bottom)/n.clientHeight))},this.dollyIn=function(e){void 0===e&&(e=E()),m/=e},this.dollyOut=function(e){void 0===e&&(e=E()),m*=e},this.update=function(){void 0!==i.object.top&&(this.object.top=m*this.object.top,this.object.bottom=m*this.object.bottom,this.object.left=m*this.object.left,this.object.right=m*this.object.right,this.object.updateProjectionMatrix());var e=this.object.position;u.copy(e).sub(this.target),this.target.add(b),e.copy(this.target).add(u),this.object.lookAt(this.target),this.dispatchEvent(v),m=1,b.set(0,0,0)},this.reset=function(){x=y.NONE,this.target.copy(this.target0),this.object.position.copy(this.position0),this.update()},Q=t=>{if(!1!==i.enabled){if(t.preventDefault(),0!==t.button&&2!==t.button)return;{x=y.PAN;let n=new e.Vector2;n.x=t.clientX/window.innerWidth*2-1,n.y=-t.clientY/window.innerHeight*2+1;let o=new e.Vector3(n.x,n.y,0);o.unproject(i.object),r.set(o.x,o.y)}i.domElement.addEventListener("mousemove",S,!1),i.domElement.addEventListener("mouseup",M,!1),i.dispatchEvent(g)}},ee=t=>{if(!1===i.enabled||!0===i.noZoom)return;t.preventDefault();let n=new e.Vector2,o=0;n.x=t.clientX/window.innerWidth*2-1,n.y=-t.clientY/window.innerHeight*2+1,o=t.deltaY>0?10:-10;const s=1+.01*o,a=new e.Vector3(n.x,n.y,.5).unproject(i.object);i.object.zoom/=s,i.object.updateProjectionMatrix();const r=new e.Vector3(n.x,n.y,.5).unproject(i.object);i.object.position.add(a.clone().sub(r)),i.dispatchEvent(v)},this.domElement.addEventListener("contextmenu",(function(e){e.preventDefault()}),!1),ne(),this.domElement.addEventListener("touchstart",(function(e){if(!1!==i.enabled){switch(e.touches.length){case 1:if(!0===i.noRotate)return;x=y.TOUCH_ROTATE,o.set(e.touches[0].pageX,e.touches[0].pageY);break;case 2:if(!0===i.noZoom)return;x=y.TOUCH_DOLLY;var t=e.touches[0].pageX-e.touches[1].pageX,n=e.touches[0].pageY-e.touches[1].pageY,s=Math.sqrt(t*t+n*n);d.set(0,s);break;case 3:if(!0===i.noPan)return;x=y.TOUCH_PAN,r.set(e.touches[0].pageX,e.touches[0].pageY);break;default:x=y.NONE}i.dispatchEvent(g)}}),!1),this.domElement.addEventListener("touchend",(function(){!1!==i.enabled&&(i.dispatchEvent(w),x=y.NONE)}),!1),this.domElement.addEventListener("touchmove",(function(e){if(!1!==i.enabled){e.preventDefault(),e.stopPropagation();var t=i.domElement===document?i.domElement.body:i.domElement;switch(e.touches.length){case 1:if(!0===i.noRotate||x!==y.TOUCH_ROTATE)return;s.set(e.touches[0].pageX,e.touches[0].pageY),a.subVectors(s,o),i.rotateLeft(2*Math.PI*a.x/t.clientWidth*i.rotateSpeed),i.rotateUp(2*Math.PI*a.y/t.clientHeight*i.rotateSpeed),o.copy(s),i.update();break;case 2:if(!0===i.noZoom||x!==y.TOUCH_DOLLY)return;var n=e.touches[0].pageX-e.touches[1].pageX,h=e.touches[0].pageY-e.touches[1].pageY,u=Math.sqrt(n*n+h*h);p.set(0,u),f.subVectors(p,d),f.y>0?i.dollyOut():i.dollyIn(),d.copy(p),i.update();break;case 3:if(!0===i.noPan||x!==y.TOUCH_PAN)return;l.set(e.touches[0].pageX,e.touches[0].pageY),c.subVectors(l,r),i.pan(c.x,c.y),r.copy(l),i.update();break;default:x=y.NONE}}}),!1),window.addEventListener("keydown",(function(e){if(!1!==i.enabled&&!0!==i.noKeys&&!0!==i.noPan)switch(e.keyCode){case i.keys.UP:i.pan(0,i.keyPanSpeed),i.update();break;case i.keys.BOTTOM:i.pan(0,-i.keyPanSpeed),i.update();break;case i.keys.LEFT:i.pan(i.keyPanSpeed,0),i.update();break;case i.keys.RIGHT:i.pan(-i.keyPanSpeed,0),i.update()}}),!1)}const ne=()=>{Z.addEventListener("mousedown",Q,!1),Z.addEventListener("mousewheel",ee,!1),Z.addEventListener("DOMMouseScroll",ee,!1)};te.prototype=Object.create(e.EventDispatcher.prototype);const ie=e=>{let t=0,n=0;const i=e[0]+"",o=e[1]+"";if(i.split(".").length>1){const e=i.split(".")[0];0!==i.split(".")[1].length&&(t=100*Number(e))}if(o.split(".").length>1){const e=o.split(".")[0];0!==o.split(".")[1].length&&(n=100*Number(e))}return{offsetX:t,offsetY:n}},oe=(e,t,n)=>e.map(((e,i)=>i%3==0?100*e-t:i%3==1?100*e-n:e)),se=(t,n,i)=>{let o=new e.Vector2;o.x=t/window.innerWidth*2-1,o.y=-n/window.innerHeight*2+1;let s=new e.Vector3(o.x,o.y,0);return s.unproject(i),s},ae=new t,re=new n;class le extends i{constructor(){super(),this.isLineSegmentsGeometry=!0,this.type="LineSegmentsGeometry";this.setIndex([0,2,1,2,3,1,2,4,3,4,5,3,4,6,5,6,7,5]),this.setAttribute("position",new o([-1,2,0,1,2,0,-1,1,0,1,1,0,-1,0,0,1,0,0,-1,-1,0,1,-1,0],3)),this.setAttribute("uv",new o([-1,2,1,2,-1,1,1,1,-1,-1,1,-1,-1,-2,1,-2],2))}applyMatrix4(e){const t=this.attributes.instanceStart,n=this.attributes.instanceEnd;return void 0!==t&&(t.applyMatrix4(e),n.applyMatrix4(e),t.needsUpdate=!0),null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this}setPositions(e){let t;e instanceof Float32Array?t=e:Array.isArray(e)&&(t=new Float32Array(e));const n=new s(t,6,1);return this.setAttribute("instanceStart",new a(n,3,0)),this.setAttribute("instanceEnd",new a(n,3,3)),this.computeBoundingBox(),this.computeBoundingSphere(),this}setColors(e){let t;e instanceof Float32Array?t=e:Array.isArray(e)&&(t=new Float32Array(e));const n=new s(t,6,1);return this.setAttribute("instanceColorStart",new a(n,3,0)),this.setAttribute("instanceColorEnd",new a(n,3,3)),this}fromWireframeGeometry(e){return this.setPositions(e.attributes.position.array),this}fromEdgesGeometry(e){return this.setPositions(e.attributes.position.array),this}fromMesh(e){return this.fromWireframeGeometry(new r(e.geometry)),this}fromLineSegments(e){const t=e.geometry;return this.setPositions(t.attributes.position.array),this}computeBoundingBox(){null===this.boundingBox&&(this.boundingBox=new t);const e=this.attributes.instanceStart,n=this.attributes.instanceEnd;void 0!==e&&void 0!==n&&(this.boundingBox.setFromBufferAttribute(e),ae.setFromBufferAttribute(n),this.boundingBox.union(ae))}computeBoundingSphere(){null===this.boundingSphere&&(this.boundingSphere=new l),null===this.boundingBox&&this.computeBoundingBox();const e=this.attributes.instanceStart,t=this.attributes.instanceEnd;if(void 0!==e&&void 0!==t){const n=this.boundingSphere.center;this.boundingBox.getCenter(n);let i=0;for(let o=0,s=e.count;o<s;o++)re.fromBufferAttribute(e,o),i=Math.max(i,n.distanceToSquared(re)),re.fromBufferAttribute(t,o),i=Math.max(i,n.distanceToSquared(re));this.boundingSphere.radius=Math.sqrt(i),isNaN(this.boundingSphere.radius)&&console.error("THREE.LineSegmentsGeometry.computeBoundingSphere(): Computed radius is NaN. The instanced position data is likely to have NaN values.",this)}}toJSON(){}applyMatrix(e){return console.warn("THREE.LineSegmentsGeometry: applyMatrix() has been renamed to applyMatrix4()."),this.applyMatrix4(e)}}c.line={worldUnits:{value:1},linewidth:{value:1},resolution:{value:new h(1,1)},dashOffset:{value:0},dashScale:{value:1},dashSize:{value:1},gapSize:{value:1}},u.line={uniforms:d.merge([c.common,c.fog,c.line]),vertexShader:"\n\t\t#include <common>\n\t\t#include <color_pars_vertex>\n\t\t#include <fog_pars_vertex>\n\t\t#include <logdepthbuf_pars_vertex>\n\t\t#include <clipping_planes_pars_vertex>\n\n\t\tuniform float linewidth;\n\t\tuniform vec2 resolution;\n\n\t\tattribute vec3 instanceStart;\n\t\tattribute vec3 instanceEnd;\n\n\t\tattribute vec3 instanceColorStart;\n\t\tattribute vec3 instanceColorEnd;\n\n\t\t#ifdef WORLD_UNITS\n\n\t\t\tvarying vec4 worldPos;\n\t\t\tvarying vec3 worldStart;\n\t\t\tvarying vec3 worldEnd;\n\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tvarying vec2 vUv;\n\n\t\t\t#endif\n\n\t\t#else\n\n\t\t\tvarying vec2 vUv;\n\n\t\t#endif\n\n\t\t#ifdef USE_DASH\n\n\t\t\tuniform float dashScale;\n\t\t\tattribute float instanceDistanceStart;\n\t\t\tattribute float instanceDistanceEnd;\n\t\t\tvarying float vLineDistance;\n\n\t\t#endif\n\n\t\tvoid trimSegment( const in vec4 start, inout vec4 end ) {\n\n\t\t\t// trim end segment so it terminates between the camera plane and the near plane\n\n\t\t\t// conservative estimate of the near plane\n\t\t\tfloat a = projectionMatrix[ 2 ][ 2 ]; // 3nd entry in 3th column\n\t\t\tfloat b = projectionMatrix[ 3 ][ 2 ]; // 3nd entry in 4th column\n\t\t\tfloat nearEstimate = - 0.5 * b / a;\n\n\t\t\tfloat alpha = ( nearEstimate - start.z ) / ( end.z - start.z );\n\n\t\t\tend.xyz = mix( start.xyz, end.xyz, alpha );\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\t#ifdef USE_COLOR\n\n\t\t\t\tvColor.xyz = ( position.y < 0.5 ) ? instanceColorStart : instanceColorEnd;\n\n\t\t\t#endif\n\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tvLineDistance = ( position.y < 0.5 ) ? dashScale * instanceDistanceStart : dashScale * instanceDistanceEnd;\n\t\t\t\tvUv = uv;\n\n\t\t\t#endif\n\n\t\t\tfloat aspect = resolution.x / resolution.y;\n\n\t\t\t// camera space\n\t\t\tvec4 start = modelViewMatrix * vec4( instanceStart, 1.0 );\n\t\t\tvec4 end = modelViewMatrix * vec4( instanceEnd, 1.0 );\n\n\t\t\t#ifdef WORLD_UNITS\n\n\t\t\t\tworldStart = start.xyz;\n\t\t\t\tworldEnd = end.xyz;\n\n\t\t\t#else\n\n\t\t\t\tvUv = uv;\n\n\t\t\t#endif\n\n\t\t\t// special case for perspective projection, and segments that terminate either in, or behind, the camera plane\n\t\t\t// clearly the gpu firmware has a way of addressing this issue when projecting into ndc space\n\t\t\t// but we need to perform ndc-space calculations in the shader, so we must address this issue directly\n\t\t\t// perhaps there is a more elegant solution -- WestLangley\n\n\t\t\tbool perspective = ( projectionMatrix[ 2 ][ 3 ] == - 1.0 ); // 4th entry in the 3rd column\n\n\t\t\tif ( perspective ) {\n\n\t\t\t\tif ( start.z < 0.0 && end.z >= 0.0 ) {\n\n\t\t\t\t\ttrimSegment( start, end );\n\n\t\t\t\t} else if ( end.z < 0.0 && start.z >= 0.0 ) {\n\n\t\t\t\t\ttrimSegment( end, start );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\t// clip space\n\t\t\tvec4 clipStart = projectionMatrix * start;\n\t\t\tvec4 clipEnd = projectionMatrix * end;\n\n\t\t\t// ndc space\n\t\t\tvec3 ndcStart = clipStart.xyz / clipStart.w;\n\t\t\tvec3 ndcEnd = clipEnd.xyz / clipEnd.w;\n\n\t\t\t// direction\n\t\t\tvec2 dir = ndcEnd.xy - ndcStart.xy;\n\n\t\t\t// account for clip-space aspect ratio\n\t\t\tdir.x *= aspect;\n\t\t\tdir = normalize( dir );\n\n\t\t\t#ifdef WORLD_UNITS\n\n\t\t\t\t// get the offset direction as perpendicular to the view vector\n\t\t\t\tvec3 worldDir = normalize( end.xyz - start.xyz );\n\t\t\t\tvec3 offset;\n\t\t\t\tif ( position.y < 0.5 ) {\n\n\t\t\t\t\toffset = normalize( cross( start.xyz, worldDir ) );\n\n\t\t\t\t} else {\n\n\t\t\t\t\toffset = normalize( cross( end.xyz, worldDir ) );\n\n\t\t\t\t}\n\n\t\t\t\t// sign flip\n\t\t\t\tif ( position.x < 0.0 ) offset *= - 1.0;\n\n\t\t\t\tfloat forwardOffset = dot( worldDir, vec3( 0.0, 0.0, 1.0 ) );\n\n\t\t\t\t// don't extend the line if we're rendering dashes because we\n\t\t\t\t// won't be rendering the endcaps\n\t\t\t\t#ifndef USE_DASH\n\n\t\t\t\t\t// extend the line bounds to encompass  endcaps\n\t\t\t\t\tstart.xyz += - worldDir * linewidth * 0.5;\n\t\t\t\t\tend.xyz += worldDir * linewidth * 0.5;\n\n\t\t\t\t\t// shift the position of the quad so it hugs the forward edge of the line\n\t\t\t\t\toffset.xy -= dir * forwardOffset;\n\t\t\t\t\toffset.z += 0.5;\n\n\t\t\t\t#endif\n\n\t\t\t\t// endcaps\n\t\t\t\tif ( position.y > 1.0 || position.y < 0.0 ) {\n\n\t\t\t\t\toffset.xy += dir * 2.0 * forwardOffset;\n\n\t\t\t\t}\n\n\t\t\t\t// adjust for linewidth\n\t\t\t\toffset *= linewidth * 0.5;\n\n\t\t\t\t// set the world position\n\t\t\t\tworldPos = ( position.y < 0.5 ) ? start : end;\n\t\t\t\tworldPos.xyz += offset;\n\n\t\t\t\t// project the worldpos\n\t\t\t\tvec4 clip = projectionMatrix * worldPos;\n\n\t\t\t\t// shift the depth of the projected points so the line\n\t\t\t\t// segments overlap neatly\n\t\t\t\tvec3 clipPose = ( position.y < 0.5 ) ? ndcStart : ndcEnd;\n\t\t\t\tclip.z = clipPose.z * clip.w;\n\n\t\t\t#else\n\n\t\t\t\tvec2 offset = vec2( dir.y, - dir.x );\n\t\t\t\t// undo aspect ratio adjustment\n\t\t\t\tdir.x /= aspect;\n\t\t\t\toffset.x /= aspect;\n\n\t\t\t\t// sign flip\n\t\t\t\tif ( position.x < 0.0 ) offset *= - 1.0;\n\n\t\t\t\t// endcaps\n\t\t\t\tif ( position.y < 0.0 ) {\n\n\t\t\t\t\toffset += - dir;\n\n\t\t\t\t} else if ( position.y > 1.0 ) {\n\n\t\t\t\t\toffset += dir;\n\n\t\t\t\t}\n\n\t\t\t\t// adjust for linewidth\n\t\t\t\toffset *= linewidth;\n\n\t\t\t\t// adjust for clip-space to screen-space conversion // maybe resolution should be based on viewport ...\n\t\t\t\toffset /= resolution.y;\n\n\t\t\t\t// select end\n\t\t\t\tvec4 clip = ( position.y < 0.5 ) ? clipStart : clipEnd;\n\n\t\t\t\t// back to clip space\n\t\t\t\toffset *= clip.w;\n\n\t\t\t\tclip.xy += offset;\n\n\t\t\t#endif\n\n\t\t\tgl_Position = clip;\n\n\t\t\tvec4 mvPosition = ( position.y < 0.5 ) ? start : end; // this is an approximation\n\n\t\t\t#include <logdepthbuf_vertex>\n\t\t\t#include <clipping_planes_vertex>\n\t\t\t#include <fog_vertex>\n\n\t\t}\n\t\t",fragmentShader:"\n\t\tuniform vec3 diffuse;\n\t\tuniform float opacity;\n\t\tuniform float linewidth;\n\n\t\t#ifdef USE_DASH\n\n\t\t\tuniform float dashOffset;\n\t\t\tuniform float dashSize;\n\t\t\tuniform float gapSize;\n\n\t\t#endif\n\n\t\tvarying float vLineDistance;\n\n\t\t#ifdef WORLD_UNITS\n\n\t\t\tvarying vec4 worldPos;\n\t\t\tvarying vec3 worldStart;\n\t\t\tvarying vec3 worldEnd;\n\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tvarying vec2 vUv;\n\n\t\t\t#endif\n\n\t\t#else\n\n\t\t\tvarying vec2 vUv;\n\n\t\t#endif\n\n\t\t#include <common>\n\t\t#include <color_pars_fragment>\n\t\t#include <fog_pars_fragment>\n\t\t#include <logdepthbuf_pars_fragment>\n\t\t#include <clipping_planes_pars_fragment>\n\n\t\tvec2 closestLineToLine(vec3 p1, vec3 p2, vec3 p3, vec3 p4) {\n\n\t\t\tfloat mua;\n\t\t\tfloat mub;\n\n\t\t\tvec3 p13 = p1 - p3;\n\t\t\tvec3 p43 = p4 - p3;\n\n\t\t\tvec3 p21 = p2 - p1;\n\n\t\t\tfloat d1343 = dot( p13, p43 );\n\t\t\tfloat d4321 = dot( p43, p21 );\n\t\t\tfloat d1321 = dot( p13, p21 );\n\t\t\tfloat d4343 = dot( p43, p43 );\n\t\t\tfloat d2121 = dot( p21, p21 );\n\n\t\t\tfloat denom = d2121 * d4343 - d4321 * d4321;\n\n\t\t\tfloat numer = d1343 * d4321 - d1321 * d4343;\n\n\t\t\tmua = numer / denom;\n\t\t\tmua = clamp( mua, 0.0, 1.0 );\n\t\t\tmub = ( d1343 + d4321 * ( mua ) ) / d4343;\n\t\t\tmub = clamp( mub, 0.0, 1.0 );\n\n\t\t\treturn vec2( mua, mub );\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\t#include <clipping_planes_fragment>\n\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tif ( vUv.y < - 1.0 || vUv.y > 1.0 ) discard; // discard endcaps\n\n\t\t\t\tif ( mod( vLineDistance + dashOffset, dashSize + gapSize ) > dashSize ) discard; // todo - FIX\n\n\t\t\t#endif\n\n\t\t\tfloat alpha = opacity;\n\n\t\t\t#ifdef WORLD_UNITS\n\n\t\t\t\t// Find the closest points on the view ray and the line segment\n\t\t\t\tvec3 rayEnd = normalize( worldPos.xyz ) * 1e5;\n\t\t\t\tvec3 lineDir = worldEnd - worldStart;\n\t\t\t\tvec2 params = closestLineToLine( worldStart, worldEnd, vec3( 0.0, 0.0, 0.0 ), rayEnd );\n\n\t\t\t\tvec3 p1 = worldStart + lineDir * params.x;\n\t\t\t\tvec3 p2 = rayEnd * params.y;\n\t\t\t\tvec3 delta = p1 - p2;\n\t\t\t\tfloat len = length( delta );\n\t\t\t\tfloat norm = len / linewidth;\n\n\t\t\t\t#ifndef USE_DASH\n\n\t\t\t\t\t#ifdef USE_ALPHA_TO_COVERAGE\n\n\t\t\t\t\t\tfloat dnorm = fwidth( norm );\n\t\t\t\t\t\talpha = 1.0 - smoothstep( 0.5 - dnorm, 0.5 + dnorm, norm );\n\n\t\t\t\t\t#else\n\n\t\t\t\t\t\tif ( norm > 0.5 ) {\n\n\t\t\t\t\t\t\tdiscard;\n\n\t\t\t\t\t\t}\n\n\t\t\t\t\t#endif\n\n\t\t\t\t#endif\n\n\t\t\t#else\n\n\t\t\t\t#ifdef USE_ALPHA_TO_COVERAGE\n\n\t\t\t\t\t// artifacts appear on some hardware if a derivative is taken within a conditional\n\t\t\t\t\tfloat a = vUv.x;\n\t\t\t\t\tfloat b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;\n\t\t\t\t\tfloat len2 = a * a + b * b;\n\t\t\t\t\tfloat dlen = fwidth( len2 );\n\n\t\t\t\t\tif ( abs( vUv.y ) > 1.0 ) {\n\n\t\t\t\t\t\talpha = 1.0 - smoothstep( 1.0 - dlen, 1.0 + dlen, len2 );\n\n\t\t\t\t\t}\n\n\t\t\t\t#else\n\n\t\t\t\t\tif ( abs( vUv.y ) > 1.0 ) {\n\n\t\t\t\t\t\tfloat a = vUv.x;\n\t\t\t\t\t\tfloat b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;\n\t\t\t\t\t\tfloat len2 = a * a + b * b;\n\n\t\t\t\t\t\tif ( len2 > 1.0 ) discard;\n\n\t\t\t\t\t}\n\n\t\t\t\t#endif\n\n\t\t\t#endif\n\n\t\t\tvec4 diffuseColor = vec4( diffuse, alpha );\n\n\t\t\t#include <logdepthbuf_fragment>\n\t\t\t#include <color_fragment>\n\n\t\t\tgl_FragColor = vec4( diffuseColor.rgb, alpha );\n\n\t\t\t#include <tonemapping_fragment>\n\t\t\t#include <encodings_fragment>\n\t\t\t#include <fog_fragment>\n\t\t\t#include <premultiplied_alpha_fragment>\n\n\t\t}\n\t\t"};class ce extends p{constructor(e){super({type:"LineMaterial",uniforms:d.clone(u.line.uniforms),vertexShader:u.line.vertexShader,fragmentShader:u.line.fragmentShader,clipping:!0}),this.isLineMaterial=!0,Object.defineProperties(this,{color:{enumerable:!0,get:function(){return this.uniforms.diffuse.value},set:function(e){this.uniforms.diffuse.value=e}},worldUnits:{enumerable:!0,get:function(){return"WORLD_UNITS"in this.defines},set:function(e){!0===e?this.defines.WORLD_UNITS="":delete this.defines.WORLD_UNITS}},linewidth:{enumerable:!0,get:function(){return this.uniforms.linewidth.value},set:function(e){this.uniforms.linewidth.value=e}},dashed:{enumerable:!0,get:function(){return"USE_DASH"in this.defines},set(e){!!e!="USE_DASH"in this.defines&&(this.needsUpdate=!0),!0===e?this.defines.USE_DASH="":delete this.defines.USE_DASH}},dashScale:{enumerable:!0,get:function(){return this.uniforms.dashScale.value},set:function(e){this.uniforms.dashScale.value=e}},dashSize:{enumerable:!0,get:function(){return this.uniforms.dashSize.value},set:function(e){this.uniforms.dashSize.value=e}},dashOffset:{enumerable:!0,get:function(){return this.uniforms.dashOffset.value},set:function(e){this.uniforms.dashOffset.value=e}},gapSize:{enumerable:!0,get:function(){return this.uniforms.gapSize.value},set:function(e){this.uniforms.gapSize.value=e}},opacity:{enumerable:!0,get:function(){return this.uniforms.opacity.value},set:function(e){this.uniforms.opacity.value=e}},resolution:{enumerable:!0,get:function(){return this.uniforms.resolution.value},set:function(e){this.uniforms.resolution.value.copy(e)}},alphaToCoverage:{enumerable:!0,get:function(){return"USE_ALPHA_TO_COVERAGE"in this.defines},set:function(e){!!e!="USE_ALPHA_TO_COVERAGE"in this.defines&&(this.needsUpdate=!0),!0===e?(this.defines.USE_ALPHA_TO_COVERAGE="",this.extensions.derivatives=!0):(delete this.defines.USE_ALPHA_TO_COVERAGE,this.extensions.derivatives=!1)}}}),this.setValues(e)}}const he=new n,ue=new n,de=new f,pe=new f,fe=new f,me=new n,be=new m,ye=new b,xe=new n,ve=new t,ge=new l,we=new f;let ke,Ee;function Se(e,t,n){return we.set(0,0,-t,1).applyMatrix4(e.projectionMatrix),we.multiplyScalar(1/we.w),we.x=Ee/n.width,we.y=Ee/n.height,we.applyMatrix4(e.projectionMatrixInverse),we.multiplyScalar(1/we.w),Math.abs(Math.max(we.x,we.y))}class Pe extends y{constructor(e=new le,t=new ce({color:16777215*Math.random()})){super(e,t),this.isLineSegments2=!0,this.type="LineSegments2"}computeLineDistances(){const e=this.geometry,t=e.attributes.instanceStart,n=e.attributes.instanceEnd,i=new Float32Array(2*t.count);for(let e=0,o=0,s=t.count;e<s;e++,o+=2)he.fromBufferAttribute(t,e),ue.fromBufferAttribute(n,e),i[o]=0===o?0:i[o-1],i[o+1]=i[o]+he.distanceTo(ue);const o=new s(i,2,1);return e.setAttribute("instanceDistanceStart",new a(o,1,0)),e.setAttribute("instanceDistanceEnd",new a(o,1,1)),this}raycast(e,t){const i=this.material.worldUnits,o=e.camera;null===o&&!i&&console.error('LineSegments2: "Raycaster.camera" needs to be set in order to raycast against LineSegments2 while worldUnits is set to false.');const s=void 0!==e.params.Line2&&e.params.Line2.threshold||0;ke=e.ray;const a=this.matrixWorld,r=this.geometry,l=this.material;let c,h;if(Ee=l.linewidth+s,null===r.boundingSphere&&r.computeBoundingSphere(),ge.copy(r.boundingSphere).applyMatrix4(a),i)c=.5*Ee;else{c=Se(o,Math.max(o.near,ge.distanceToPoint(ke.origin)),l.resolution)}if(ge.radius+=c,!1!==ke.intersectsSphere(ge)){if(null===r.boundingBox&&r.computeBoundingBox(),ve.copy(r.boundingBox).applyMatrix4(a),i)h=.5*Ee;else{h=Se(o,Math.max(o.near,ve.distanceToPoint(ke.origin)),l.resolution)}ve.expandByScalar(h),!1!==ke.intersectsBox(ve)&&(i?function(e,t){const i=e.matrixWorld,o=e.geometry,s=o.attributes.instanceStart,a=o.attributes.instanceEnd;for(let r=0,l=Math.min(o.instanceCount,s.count);r<l;r++){ye.start.fromBufferAttribute(s,r),ye.end.fromBufferAttribute(a,r),ye.applyMatrix4(i);const o=new n,l=new n;ke.distanceSqToSegment(ye.start,ye.end,l,o),l.distanceTo(o)<.5*Ee&&t.push({point:l,pointOnLine:o,distance:ke.origin.distanceTo(l),object:e,face:null,faceIndex:r,uv:null,uv2:null})}}(this,t):function(e,t,i){const o=t.projectionMatrix,s=e.material.resolution,a=e.matrixWorld,r=e.geometry,l=r.attributes.instanceStart,c=r.attributes.instanceEnd,h=Math.min(r.instanceCount,l.count),u=-t.near;ke.at(1,fe),fe.w=1,fe.applyMatrix4(t.matrixWorldInverse),fe.applyMatrix4(o),fe.multiplyScalar(1/fe.w),fe.x*=s.x/2,fe.y*=s.y/2,fe.z=0,me.copy(fe),be.multiplyMatrices(t.matrixWorldInverse,a);for(let t=0,r=h;t<r;t++){if(de.fromBufferAttribute(l,t),pe.fromBufferAttribute(c,t),de.w=1,pe.w=1,de.applyMatrix4(be),pe.applyMatrix4(be),de.z>u&&pe.z>u)continue;if(de.z>u){const e=de.z-pe.z,t=(de.z-u)/e;de.lerp(pe,t)}else if(pe.z>u){const e=pe.z-de.z,t=(pe.z-u)/e;pe.lerp(de,t)}de.applyMatrix4(o),pe.applyMatrix4(o),de.multiplyScalar(1/de.w),pe.multiplyScalar(1/pe.w),de.x*=s.x/2,de.y*=s.y/2,pe.x*=s.x/2,pe.y*=s.y/2,ye.start.copy(de),ye.start.z=0,ye.end.copy(pe),ye.end.z=0;const r=ye.closestPointToPointParameter(me,!0);ye.at(r,xe);const h=x.lerp(de.z,pe.z,r),d=h>=-1&&h<=1,p=me.distanceTo(xe)<.5*Ee;if(d&&p){ye.start.fromBufferAttribute(l,t),ye.end.fromBufferAttribute(c,t),ye.start.applyMatrix4(a),ye.end.applyMatrix4(a);const o=new n,s=new n;ke.distanceSqToSegment(ye.start,ye.end,s,o),i.push({point:s,pointOnLine:o,distance:ke.origin.distanceTo(s),object:e,face:null,faceIndex:t,uv:null,uv2:null})}}}(this,o,t))}}}let Me,Le,De,Te,Ae,Oe=new e.WebGLRenderer({antialias:!0}),Ce=new e.Scene,Ne=new e.WebGLRenderTarget(1,1),Ie=new e.Scene,je={},ze={},Ve={};const Fe=e=>{if(e.length>6){const t=e.length/3;let n=0;for(let i=1;i<t-1;i++){const t=3*i+3*n;e.splice(t,0,e[t],e[t+1],e[t+2]),n++}}else if(3===e.length)return[];return e},Re=(e,t)=>{let n=[];for(let i=0;i<e.length/3;i++)n.push(t.r,t.g,t.b);return n};let Be=new e.LineBasicMaterial({vertexColors:!0}),_e=new e.LineBasicMaterial({vertexColors:!0});const He={};let Ye={};const Xe=()=>{Ye={};for(let t=0;t<Ue.length;t++){const n=Ue[t];if(!n)continue;Ve[n.pixelIndex]?Ve[n.pixelIndex].push(t):Ve[n.pixelIndex]=[t],ze[n.layer]?ze[n.layer].push(t):ze[n.layer]=[t];let i=[],o=[],s=[];if("object"==typeof n.positions[0]?n.positions.forEach((a=>{i=Fe(a.positions),o=Re(i,new e.Color(n.color)),s=Re(i,new e.Color(t))})):(i=Fe(n.positions),o=Re(i,new e.Color(n.color)),s=Re(i,new e.Color(t))),!Te||!Ae){const{offsetX:e,offsetY:t}=ie(i);Te=e,Ae=t}const a=oe(i,Te,Ae);He[t]={positions:a,colors:o,pickColors:s},Ye[n.layer]?(Ye[n.layer].positions.push(...a),Ye[n.layer].colors.push(...o),Ye[n.layer].pickColors.push(...s)):Ye[n.layer]={positions:[...a],colors:[...o],pickColors:[...s]}}};let Ue,We,Ge={};const qe=(t,n)=>{console.log("解析数据",t),Ue=t.models,t.models.length,We=n,De=t.box,Ce.background=new e.Color(3289655),(()=>{Xe();for(let t in Ye){const{positions:n,colors:i,pickColors:o}=Ye[t];let s=new e.BufferGeometry,a=new e.BufferGeometry;if(Te&&Ae){let t=new e.Float32BufferAttribute(n,3);s.setAttribute("position",t),a.setAttribute("position",t)}s.setAttribute("color",new e.Float32BufferAttribute(i,3)),a.setAttribute("color",new e.Float32BufferAttribute(o,3));let r=new e.LineSegments(s,_e),l=new e.LineSegments(a,Be);if(Te&&Ae){let e=Te?Te/100:0,t=Ae?Ae/100:0;r.position.set(e,t,0),l.position.set(e,t,0);const n=.01;r.scale.set(n,n,n),l.scale.set(n,n,n)}Ce.add(r),Ie.add(l),je[t]={objects:r,pickObjects:l}}Ye=null})(),t.group.forEach((e=>{Ge[e.layer]?Ge[e.layer].push(e):Ge[e.layer]=[e],Ce.add(e)})),ut();const i=window.innerWidth/window.innerHeight,o=De.max.x,s=De.max.y,a=De.min.x,r=De.min.y;let l=o-a,c=s-r,h={x:l/2+a,y:c/2+r};const u=Math.abs(l/c);i>u?l=c*i:c=l/i;const d={bottom:-c/2,left:-l/2,top:c/2,right:l/2,center:{x:h.x,y:h.y}},p=1.3;Me=new e.OrthographicCamera(d.left*p,d.right*p,d.top*p,d.bottom*p,1,19),Me.position.z=10,Me.position.x=d.center.x,Me.position.y=d.center.y,Oe.setSize(window.innerWidth,window.innerHeight),Oe.setPixelRatio(window.devicePixelRatio),Oe.setClearColor(268435455,1),We.appendChild(Oe.domElement),We.style.display="block",Le=new te(Me,We),Le.target.x=Me.position.x,Le.target.y=Me.position.y,Le.target.z=0,Le.zoomSpeed=3,Le.addEventListener("change",Ke),Ke(),Le.update();window.addEventListener("resize",(()=>{const t=Le.object.position,n=Le.object.zoom,i=window.innerWidth/window.innerHeight;i>u?l=c*i:c=l/i;const o=-c/2,s=-l/2,a=c/2,r=l/2;Me=new e.OrthographicCamera(s*p,r*p,a*p,o*p,1,19),Me.position.set(t.x,t.y,t.z),Me.zoom=n,Le.object=Me,Le.object.updateProjectionMatrix(),Oe.setSize(window.innerWidth,window.innerHeight),Oe.setPixelRatio(window.devicePixelRatio),Oe.render(Ce,Me)})),$e(),window.addEventListener("mousedown",Je,!1),window.addEventListener("mouseup",$e,!1),We.addEventListener("click",lt)},$e=()=>{We.addEventListener("pointermove",Qe,!1)},Je=()=>{We.removeEventListener("pointermove",Qe,!1)},Ke=()=>{Oe.setRenderTarget(null),Oe.render(Ce,Me)};let Ze=new e.Vector2;const Qe=e=>{Ze.x=e.clientX,Ze.y=e.clientY,tt(),Ke()};let et;const tt=()=>{Me.setViewOffset(window.innerWidth,window.innerHeight,Ze.x*window.devicePixelRatio|0,Ze.y*window.devicePixelRatio|0,1,1),Oe.setRenderTarget(Ne),Oe.render(Ie,Me),Me.clearViewOffset();const e=new Uint8Array(4);Oe.readRenderTargetPixels(Ne,0,0,1,1,e);const t=e[0]<<16|e[1]<<8|e[2];if(et=t,16777215!==t){{const e=Ue[t].pixelIndex;st(Ve[e])}}else et=null,st([]);Ke()};let nt=new le;const it=new ce({linewidth:.0015,vertexColors:!0,dashed:!1,alphaToCoverage:!0,transparent:!0,depthTest:!1});let ot=new Pe(nt,it);const st=(e,t)=>{let n=[];e.forEach((e=>{n.push(...He[e].positions)}));let i={max:{x:0,y:0},min:{x:0,y:0}};if(t){i.max.x=n[0],i.min.x=n[0],i.min.y=n[1],i.max.y=n[1];for(let e=0;e<n.length;e+=3)i.max.x<n[e]&&(i.max.x=n[e]),i.min.x>n[e]&&(i.min.x=n[e]),i.max.y<n[e+1]&&(i.max.y=n[e+1]),i.min.y>n[e+1]&&(i.min.y=n[e+1])}rt.forEach((e=>{n.push(...He[e].positions)}));let o=new le;o.setPositions(n);let s=[];for(let e=0;e<n.length;e+=3)s.push(1),s.push(.4),s.push(0);o.setColors(s),ot.geometry=o,ot.computeLineDistances(),ot.scale.set(1,1,1);let a=Te?Te/100:0,r=Ae?Ae/100:0;ot.position.set(a,r,0);const l=.01;if(ot.scale.set(l,l,l),Ce.add(ot),t)return i};let at,rt=[];const lt=()=>{et?(at=Ue[et].pixelIndex,rt=[...Ve[at]],st(Ve[at])):(rt=[],at=null,st([])),Ke()};let ct=[],ht=[];const ut=()=>{let e=[];for(let t in Ge)e.push(t);for(let t in je)e.push(t);e.sort(((e,t)=>e.localeCompare(t))),ct=[...new Set(e)],ht=[...new Set(e)]},dt=(e,t)=>{let n=[];"string"==typeof e?n.push(e):n=e,t?ht.push(...n):ht=ht.filter((e=>!n.includes(e)));for(let e in je)n.includes(e)&&(je[e].objects.visible=t,je[e].pickObjects.visible=t);n.forEach((e=>{Ge[e]&&Ge[e].forEach((e=>e.visible=t))})),Ke()},pt=e=>{ht=e?ct:[];for(let t in je)je[t].objects.visible=e,je[t].pickObjects.visible=e;for(let t in Ge)Ge[t].forEach((t=>t.visible=e));Ke()},ft=()=>{ne()},mt=()=>{Z.removeEventListener("mousedown",Q,!1),Z.removeEventListener("mousewheel",ee,!1),Z.removeEventListener("DOMMouseScroll",ee,!1)};let bt={};let yt,xt,vt,gt,wt,kt,Et="";const St=(t,n,i,o,s,a)=>{let r=[];for(let l=0;l<=o;l++){let c=l/o*Math.PI*2;const h=new e.Vector3;h.x=t+i*Math.sin(c)*s,h.y=n+i*Math.cos(c)*a,h.z=0,r.push(h)}return r};let Pt,Mt;const Lt=()=>{Pt(),document.addEventListener("mousedown",gt,!1),document.addEventListener("mousemove",wt,!1),document.addEventListener("mouseup",kt,!1)},Dt=()=>{document.removeEventListener("mousedown",gt,!1),document.removeEventListener("mousemove",wt,!1),document.removeEventListener("mouseup",kt,!1),Mt()};let Tt,At,Ot;const Ct=()=>{At(),document.addEventListener("mousedown",Tt,!1)},Nt=()=>{document.removeEventListener("mousedown",Tt,!1),Ot()};let It,jt,zt,Vt,Ft;const Rt=()=>{It(),document.addEventListener("mousedown",zt,!1),document.addEventListener("mousemove",Vt,!1),document.addEventListener("mouseup",Ft,!1)},Bt=()=>{document.removeEventListener("mousedown",zt,!1),document.removeEventListener("mousemove",Vt,!1),document.removeEventListener("mouseup",Ft,!1),jt()};class _t extends v{constructor(e){super(e)}load(e,t,n,i){const o=this,s=new g(this.manager);s.setPath(this.path),s.setRequestHeader(this.requestHeader),s.setWithCredentials(this.withCredentials),s.load(e,(function(e){const n=o.parse(JSON.parse(e));t&&t(n)}),n,i)}parse(e){return new Ht(e)}}class Ht{constructor(e){this.isFont=!0,this.type="Font",this.data=e}generateShapes(e,t=100){const n=[],i=function(e,t,n){const i=Array.from(e),o=t/n.resolution,s=(n.boundingBox.yMax-n.boundingBox.yMin+n.underlineThickness)*o,a=[];let r=0,l=0;for(let e=0;e<i.length;e++){const t=i[e];if("\n"===t)r=0,l-=s;else{const e=Yt(t,o,r,l,n);r+=e.offsetX,a.push(e.path)}}return a}(e,t,this.data);for(let e=0,t=i.length;e<t;e++)n.push(...i[e].toShapes());return n}}function Yt(e,t,n,i,o){const s=o.glyphs[e]||o.glyphs["?"];if(!s)return void console.error('THREE.Font: character "'+e+'" does not exists in font family '+o.familyName+".");const a=new w;let r,l,c,h,u,d,p,f;if(s.o){const e=s._cachedOutline||(s._cachedOutline=s.o.split(" "));for(let o=0,s=e.length;o<s;)switch(e[o++]){case"m":r=e[o++]*t+n,l=e[o++]*t+i,a.moveTo(r,l);break;case"l":r=e[o++]*t+n,l=e[o++]*t+i,a.lineTo(r,l);break;case"q":c=e[o++]*t+n,h=e[o++]*t+i,u=e[o++]*t+n,d=e[o++]*t+i,a.quadraticCurveTo(u,d,c,h);break;case"b":c=e[o++]*t+n,h=e[o++]*t+i,u=e[o++]*t+n,d=e[o++]*t+i,p=e[o++]*t+n,f=e[o++]*t+i,a.bezierCurveTo(u,d,p,f,c,h)}}return{offsetX:s.ha*t,path:a}}class Xt extends k{constructor(e,t={}){const n=t.font;if(void 0===n)super();else{const i=n.generateShapes(e,t.size);t.depth=void 0!==t.height?t.height:50,void 0===t.bevelThickness&&(t.bevelThickness=10),void 0===t.bevelSize&&(t.bevelSize=8),void 0===t.bevelEnabled&&(t.bevelEnabled=!1),super(i,t)}this.type="TextGeometry"}}const Ut="https://api.ourbim.com:8181/CADFile/";var Wt="https://api.ourbim.com:8181/CAD/",Gt=Ut,qt=`${Ut}FZYaoTi_Regular.json`,$t=`${Ut}SJQY.ttf`,Jt=`${Ut}FZYTK.TTF`;let Kt,Zt,Qt,en,tn,nn,on,sn=L("");const an=()=>new Promise(((e,t)=>{const n=`${qt}`;(new _t).load(n,(t=>{on=t,e()}))})),rn=()=>{tn(),document.addEventListener("mousedown",Qt,!1)},ln=()=>{document.removeEventListener("mousedown",Qt,!1),nn()};let cn,hn,un,dn,pn,fn,mn,bn,yn="";const xn=()=>{mn(),document.addEventListener("mousedown",un,!1),document.addEventListener("mousemove",dn,!1),document.addEventListener("mouseup",pn,!1)},vn=()=>{document.removeEventListener("mousedown",un,!1),document.removeEventListener("mousemove",dn,!1),document.removeEventListener("mouseup",pn,!1),bn()};let gn,wn,kn=new e.Raycaster,En=new e.Vector2,Sn=!1;const Pn=async e=>{let{camera:t,scene:n,renderer:i}=gn;En.x=e.clientX/window.innerWidth*2-1,En.y=-e.clientY/window.innerHeight*2+1;const o=Cn.getInstance(gn);if(kn.setFromCamera(En,t),o.commentArr){let e=[];for(let t in o.commentCollecter)"length"!=t&&o.commentCollecter[t].forEach((t=>e.push(t)));let t=kn.intersectObjects(e);if(t.length>0){const e=Cn.getInstance(gn),n=e.commentArr.findIndex((e=>e.id===t[0].object.uuid));wn=e.commentArr[n]}else wn=null;Sn=!0}},Mn=(e,t)=>{gn=e,window.addEventListener("click",Pn)};var Ln=Object.defineProperty,Dn=(e,t,n)=>(((e,t,n)=>{t in e?Ln(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);const Tn={line:(e,t)=>new Promise(((n,i)=>{let{camera:o,scene:s,renderer:a}=e;At=e.deleteMoveEvent,Ot=e.addMoveEvent;let r=[];Tt=e=>{let t=A(e.clientX,e.clientY,o);r.push(t),2===r.length&&l()};const l=()=>{const e=t.linewidth?.0015*t.linewidth:.0015,i=new ce({linewidth:e,vertexColors:!0,dashed:!1,alphaToCoverage:!0,transparent:!0,depthTest:!1}),l=new le,c=t.color?I(t.color):{r:255,g:255,b:255};let h=[],u=[];for(let e=0;e<r.length;e++)u.push(r[e].x,r[e].y,0),h.push(c.r/255,c.g/255,c.b/255);l.setPositions(u),l.setColors(h);let d=new Pe(l,i);d.computeLineDistances(),d.scale.set(1,1,1),s.add(d),a.render(s,o),Nt(),n({type:"line",comment:d,commentData:{positions:u,colors:h,color:c,lineWidth:t.linewidth}})};Ct()})),ellipse:(e,t)=>new Promise(((n,i)=>{let o,{camera:s,scene:a,renderer:r}=e;Pt=e.deleteMoveEvent,Mt=e.addMoveEvent;let l=[],c=[];const h=new ce({linewidth:.0015,vertexColors:!0,dashed:!1,alphaToCoverage:!0,transparent:!0,depthTest:!1}),u=new le,d=t.linewidth?.0015*t.linewidth:.0015;h.linewidth=d;const p=t.color?I(t.color):{r:255,g:255,b:255};xt=null,yt=(e,t,n)=>A(e,t,n),gt=e=>{xt=yt(e.clientX,e.clientY,s)},wt=e=>{if(!xt)return;vt=yt(e.clientX,e.clientY,s);const t=xt.x+(vt.x-xt.x)/2,n=xt.y+(vt.y-xt.y)/2,i=Math.abs(xt.x-vt.x),d=Math.abs(xt.y-vt.y),f=Math.max(i,d)/2,m=St(t,n,f,50,i/2/f,d/2/f);"drawing"===Et&&a.remove(o),l=[],c=[];for(let e=0;e<m.length;e++)c.push(m[e].x,m[e].y,0),l.push(p.r/255,p.g/255,p.b/255),0!==e&&e!==m.length-1&&(c.push(m[e].x,m[e].y,0),l.push(p.r/255,p.g/255,p.b/255));const b=m.length-1;c.push(m[b].x,m[b].y,0,m[0].x,m[0].y,0),l.push(p.r/255,p.g/255,p.b/255,p.r/255,p.g/255,p.b/255),u.setPositions(c),u.setColors(l),o=new Pe(u,h),o.computeLineDistances(),o.scale.set(1,1,1),a.add(o),Et="drawing",C((()=>{r.render(a,s)}),40)},kt=()=>{Et="",Dt(),n({type:"ellipse",comment:o,commentData:{startPoint:xt,endPoint:vt,color:p,lineWidth:t.linewidth}})},Lt()})),pointerLine:(e,t)=>new Promise(((n,i)=>{let{camera:o,scene:s,renderer:a}=e;It=e.deleteMoveEvent,jt=e.addMoveEvent;let r,l=!1,c=!1,h=[];const u=new ce({linewidth:.0015,vertexColors:!0,dashed:!1,alphaToCoverage:!0,transparent:!0,depthTest:!1}),d=t.linewidth?.0015*t.linewidth:.0015;u.linewidth=d;const p=t.color?I(t.color):{r:255,g:255,b:255};zt=()=>{l=!0},Vt=e=>{if(!l)return;const t=A(e.clientX,e.clientY,o);if(h.push(t),h.length<2)return;c&&s.remove(r);let n=[],i=[];for(let e=0;e<h.length;e++)i.push(h[e].x,h[e].y,0),n.push(p.r/255,p.g/255,p.b/255),0!==e&&e!==h.length-1&&(i.push(h[e].x,h[e].y,0),n.push(p.r/255,p.g/255,p.b/255));let d=new le;d.setPositions(i),d.setColors(n),r=new Pe(d,u),r.computeLineDistances(),r.scale.set(1,1,1),s.add(r),c=!0,C((()=>{a.render(s,o)}),30)},Ft=()=>{l=!1,c=!1,Bt(),n({type:"pointerLine",comment:r,commentData:{pointArr:h,color:p,lineWidth:t.linewidth}})},Rt()})),word:(t,n)=>new Promise(((i,o)=>{let{camera:s,scene:a,renderer:r}=t;tn=t.deleteMoveEvent,nn=t.addMoveEvent;const l=n.linewidth?n.linewidth:1,c=n.color?n.color:"#ffffff",h=new e.MeshBasicMaterial({color:c});sn.value="",Qt=e=>{Kt=A(e.clientX,e.clientY,s),Zt=A(e.clientX+50,e.clientY,s),S({title:"请输入文字标注内容",message:()=>D("div",[D(P,{modelValue:sn.value,"onUpdate:modelValue":e=>{sn.value=e}})]),showCancelButton:!0,confirmButtonText:"确定",cancelButtonText:"取消"}).then((()=>{en()})).catch((()=>{})),ln()},en=async()=>{const t=.3*(Zt.x-Kt.x),n=t*l;on||await an();const o=new Xt(sn.value,{font:on,size:n,height:0});let u=new e.Mesh(o,h);u.position.set(Kt.x,Kt.y,0),a.add(u),r.render(a,s),i({type:"word",comment:u,commentData:{position:Kt,text:sn.value,color:c,basicHeight:t,lineWidth:l}})},rn()})),rect:(t,n)=>new Promise(((i,o)=>{let{camera:s,scene:a,renderer:r}=t;mn=t.deleteMoveEvent,bn=t.addMoveEvent,cn=null;let l=[],c=[];const h=new ce({linewidth:.0015,vertexColors:!0,dashed:!1,alphaToCoverage:!0,transparent:!0,depthTest:!1}),u=new le,d=n.linewidth?.0015*n.linewidth:.0015;h.linewidth=d;const p=n.color?I(n.color):{r:255,g:255,b:255};un=e=>{cn=A(e.clientX,e.clientY,s)},dn=t=>{if(!cn)return;hn=A(t.clientX,t.clientY,s);const n=[new e.Vector3(cn.x,cn.y,0),new e.Vector3(hn.x,cn.y,0),new e.Vector3(hn.x,cn.y,0),new e.Vector3(hn.x,hn.y,0),new e.Vector3(hn.x,hn.y,0),new e.Vector3(cn.x,hn.y,0),new e.Vector3(cn.x,hn.y,0),new e.Vector3(cn.x,cn.y,0)];"drawing"===yn&&a.remove(fn),l=[],c=[];for(let e=0;e<n.length;e++)c.push(n[e].x,n[e].y,0),l.push(p.r/255,p.g/255,p.b/255);u.setPositions(c),u.setColors(l),fn=new Pe(u,h),fn.computeLineDistances(),fn.scale.set(1,1,1),a.add(fn),yn="drawing",C((()=>{r.render(a,s)}),40)},pn=()=>{yn="",vn(),i({type:"rect",comment:fn,commentData:{positions:c,colors:l,color:p,lineWidth:n.linewidth}})},xn()}))},An={line:(e,t)=>{let{camera:n,scene:i,renderer:o}=e;const s=new ce({linewidth:.0015*t.lineWidth,vertexColors:!0,dashed:!1,alphaToCoverage:!0,transparent:!0,depthTest:!1}),a=new le;a.setPositions(t.positions),a.setColors(t.colors);let r=new Pe(a,s);return r.computeLineDistances(),r.scale.set(1,1,1),i.add(r),o.render(i,n),r},ellipse:(e,t)=>{let{camera:n,scene:i,renderer:o}=e;const{startPoint:s,endPoint:a}=t,r=new ce({linewidth:.0015,vertexColors:!0,dashed:!1,alphaToCoverage:!0,transparent:!0,depthTest:!1}),l=new le,c=s.x+(a.x-s.x)/2,h=s.y+(a.y-s.y)/2,u=Math.abs(s.x-a.x),d=Math.abs(s.y-a.y),p=Math.max(u,d)/2,f=St(c,h,p,50,u/2/p,d/2/p),m=t.color?t.color:{r:255,g:255,b:255,a:1};r.linewidth=t.lineWidth?.0015*t.lineWidth:.0015;let b=[],y=[];for(let e=0;e<f.length;e++)y.push(f[e].x,f[e].y,0),b.push(m.r/255,m.g/255,m.b/255),0!==e&&e!==f.length-1&&(y.push(f[e].x,f[e].y,0),b.push(m.r/255,m.g/255,m.b/255));const x=f.length-1;y.push(f[x].x,f[x].y,0,f[0].x,f[0].y,0),b.push(m.r/255,m.g/255,m.b/255,m.r/255,m.g/255,m.b/255),l.setPositions(y),l.setColors(b);let v=new Pe(l,r);return v.computeLineDistances(),v.scale.set(1,1,1),i.add(v),o.render(i,n),v},pointerLine:(e,t)=>{let{camera:n,scene:i,renderer:o}=e;const s=new ce({linewidth:.0015,vertexColors:!0,dashed:!1,alphaToCoverage:!0,transparent:!0,depthTest:!1});let a=new le;const r=t.color?t.color:{r:255,g:255,b:255,a:1};s.linewidth=t.lineWidth?.0015*t.lineWidth:.0015;let l=[],c=[];const h=t.pointArr;for(let e=0;e<h.length;e++)c.push(h[e].x,h[e].y,0),l.push(r.r/255,r.g/255,r.b/255),0!==e&&e!==h.length-1&&(c.push(h[e].x,h[e].y,0),l.push(r.r/255,r.g/255,r.b/255));a.setPositions(c),a.setColors(l);let u=new Pe(a,s);return i.add(u),o.render(i,n),u},word:async(t,n)=>{let{camera:i,scene:o,renderer:s}=t;const{text:a,position:r,basicHeight:l,lineWidth:c}=n,h=l*c;"string"!=typeof n.color&&(n.color=N(n.color.r,n.color.g,n.color.b));const u=n.color?n.color:"#ffffff",d=new e.MeshBasicMaterial({color:u});on||await an();const p=new Xt(a,{font:on,size:h,height:0});let f=new e.Mesh(p,d);return f.position.set(r.x,r.y,0),o.add(f),s.render(o,i),f},rect:(e,t)=>{let{camera:n,scene:i,renderer:o}=e;const s=new ce({linewidth:.0015,vertexColors:!0,dashed:!1,alphaToCoverage:!0,transparent:!0,depthTest:!1}),a=new le;s.linewidth=.0015*t.lineWidth,a.setPositions(t.positions),a.setColors(t.colors);let r=new Pe(a,s);return r.computeLineDistances(),r.scale.set(1,1,1),i.add(r),o.render(i,n),r}},On=class e{constructor(e){Dn(this,"Viewer"),Dn(this,"commentArr",[]),Dn(this,"commentCollecter",{length:0}),this.Viewer=e}static getInstance(t){return e.instance||(e.instance=new e(t)),e.instance}draw(e){Tn[e.type]?Tn[e.type](this.Viewer,e).then((e=>{const{type:t,comment:n,commentData:i}=e;this.collecter(t,n,i),Mn(this.Viewer)})):console.log("暂不支持该类型批注")}editComment(e){const{id:t}=e,{scene:n}=this.Viewer;let i=[];for(let e in this.commentCollecter)"length"!=e&&this.commentCollecter[e].forEach((e=>i.push(e)));const o=i.findIndex((e=>e.uuid===t));-1!==o?(n.remove(i[o]),this.commentArr.some((n=>{if(n.id===t){if(n.commentData.colors&&e.color){const t=I(e.color);let i=[];for(let e=0;e<n.commentData.positions.length;e++)e%3==0&&i.push(t.r/255),e%3==1&&i.push(t.g/255),e%3==2&&i.push(t.b/255);n.commentData.colors=i,n.commentData.color=e.color}else e.color&&(n.commentData.color=I(e.color));return e.linewidth&&(n.commentData.lineWidth=e.linewidth),this.reShowComment([n],e.id),!0}}))):console.log("批注不存在，修改失败"),this.deleteComment(t)}deleteComment(e){const{scene:t,camera:n,renderer:i}=this.Viewer;for(let o in this.commentCollecter)"length"!=o&&this.commentCollecter[o].forEach(((s,a)=>{s.uuid===e&&(t.remove(s),i.render(t,n),this.commentCollecter[o].splice(a,1))}));this.commentArr=this.commentArr.filter((t=>t.id!==e))}deleteAllComment(){let{camera:e,scene:t,renderer:n}=this.Viewer;for(let e in this.commentCollecter)"length"!==e&&this.commentCollecter[e].forEach((e=>{t.remove(e)}));this.commentCollecter={length:0},this.commentArr=[],n.render(t,e)}reShowComment(e,t){e.forEach((async e=>{if(An[e.type]){const n=await An[e.type](this.Viewer,e.commentData);t&&(n.uuid=t),this.collecter(e.type,n,e.commentData),Mn(this.Viewer)}else console.log("暂不支持该类型批注",e.type)}))}showOrHidden(){let{camera:e,scene:t,renderer:n}=this.Viewer;for(let e in this.commentCollecter)"length"!==e&&this.commentCollecter[e].forEach((e=>{e.visible=!e.visible}));n.render(t,e)}collecter(e,t,n){this.commentCollecter[e]?this.commentCollecter[e].push(t):(this.commentCollecter[e]=[t],this.commentCollecter.length++),this.commentArr.push({id:t.uuid,type:e,commentData:n})}};Dn(On,"instance",null);let Cn=On;var Nn=Object.defineProperty,In=(e,t,n)=>(((e,t,n)=>{t in e?Nn(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);let jn=class{constructor(e){In(this,"Viewer"),In(this,"comment"),this.Viewer=e,this.comment=Cn.getInstance(e),this.Viewer.isLoadingLocal||zn(this.Viewer.cadUrl).then((e=>{e&&this.reShowComment(JSON.parse(e))}))}reShowComment(e){this.Viewer.camera?this.comment.reShowComment(e):setTimeout((()=>{this.reShowComment(e)}),500)}HomeView(){this.Viewer.update();const{renderer:e,scene:t,camera:n,controls:i}=this.Viewer;i.target.copy(i.target0),i.object.position.copy(i.position0),i.object.zoom=1,i.object.updateProjectionMatrix(),e.render(t,n)}selectBox(t,n){this.Viewer.update();const{renderer:i,scene:o,camera:s,controls:a,addMoveEvent:r,deleteMoveEvent:l}=this.Viewer;((t,n,i,o,s,a,r=(()=>{}),l=(()=>{}))=>{z=s,V=a,r(),q(),F=(s,a,r)=>{const c=A(s,a,o.object),h=A(window.innerWidth/2,window.innerHeight/2,o.object),u=(new e.Vector3).subVectors(h,c);o.object.position.sub(u),o.object.zoom=o.object.zoom*r,o.object.updateProjectionMatrix(),t.render(n,i),l()}})(i,o,s,a,r,l,t,n)}cancelSelectBox(){$()}changeBackground(){this.Viewer.update();const{renderer:t,scene:n,camera:i}=this.Viewer;((t,n,i)=>{const o=[new e.Color(3289655),new e.Color(16777215)];J++,n.background=o[J%o.length],t.render(n,i)})(t,n,i)}fullScreen(e){var t;t=e,document.fullscreenElement?console.warn("已经是全屏状态"):t.requestFullscreen()}exitFullScreen(){document.fullscreenElement?document.exitFullscreen():console.warn("当前不是全屏状态")}getLayerList(){const{Allkeys:e,visibleKeys:t}={Allkeys:ct,visibleKeys:ht};return{Allkeys:e,visibleKeys:t}}showLayerBykeys(e){dt(e,!0)}hiddenLayerBykeys(e){dt(e,!1)}showAllLayer(){pt(!0)}hiddenAllLayer(){pt(!1)}getSearchList(e){const{textData:t}=this.Viewer;return((e,t)=>{let n=[];return e.forEach(((e,i)=>{e.text.includes(t)&&(bt[i]=e,n.push({index:i,text:e.text}))})),n})(t,e)}positionByText(t){const{renderer:n,scene:i,camera:o,controls:s}=this.Viewer;((t,n,i,o,s)=>{let{x:a,y:r}=bt[s].position;const l=bt[s].boundingBox;((s,a,r)=>{const l=new e.Vector3(s,a,0),c=A(window.innerWidth/2,window.innerHeight/2,o.object),h=(new e.Vector3).subVectors(c,l);o.object.position.sub(h),o.object.zoom=o.object.zoom*r,o.object.updateProjectionMatrix(),t.render(n,i)})(a+Math.abs(l.max.x-l.min.x)/2,r-Math.abs(l.max.y-l.min.y)/2,(()=>{const t=A(0,0,o.object),n=A(0,window.innerHeight/6,o.object),i=(new e.Vector3).subVectors(n,t),a=bt[s].boundingBox,r=a.max.y-a.min.y;return Math.abs(i.y/r)})())})(n,i,o,s,t)}addComment(e){this.comment.draw(e)}showOrHiddenComment(){this.comment.showOrHidden()}saveComment(){this.Viewer.isLoadingLocal?console.warn("本地图纸无法保存批注，请先上传图纸到ourbim"):0!==this.comment.commentArr.length?Vn(this.Viewer.cadUrl,this.comment.commentArr):console.warn("请先添加批注再保存")}getSelectedPixelId(){return at}focusByPixelId(t){(t=>{if(t&&Ve[t]){rt=[...Ve[t]];const n=st(Ve[t],!0);n.max.x=(n.max.x+Te)/100,n.min.x=(n.min.x+Te)/100,n.max.y=(n.max.y+Ae)/100,n.min.y=(n.min.y+Ae)/100;const i=se(0,0,Le.object),o=6,s=se(0,window.innerHeight/o,Le.object),a=(new e.Vector3).subVectors(s,i);let r=n.max.y-n.min.y;const l=n.max.x-n.min.x,c=l/r,h=window.innerWidth/window.innerHeight;c>h&&(r=l/h);const u=Math.abs(a.y/r),d=(n.max.x+n.min.x)/2,p=(n.max.y+n.min.y)/2,f=new e.Vector3(d,p,0),m=se(window.innerWidth/2,window.innerHeight/2,Le.object),b=(new e.Vector3).subVectors(m,f);Le.object.position.sub(b),Le.object.zoom=Le.object.zoom*u,Le.object.updateProjectionMatrix(),Oe.render(Ce,Me)}else console.log(t?`id为:${t}的图元不存在!`:"请传递正确的参数")})(t)}getSelectedCommentMessage(){return new Promise(((e,t)=>{if(Sn=!1,Sn)e({commentSelectedStatus:!!wn,color:"string"==typeof wn?.commentData.color?wn?.commentData.color:N(wn?.commentData.color.r,wn?.commentData.color.g,wn?.commentData.color.b),lineWidth:wn?.commentData.lineWidth,type:wn?.type,id:wn?.id});else{let t=setInterval((()=>{Sn&&(clearInterval(t),e({commentSelectedStatus:!!wn,color:"string"==typeof wn?.commentData.color?wn?.commentData.color:N(wn?.commentData.color.r,wn?.commentData.color.g,wn?.commentData.color.b),lineWidth:wn?.commentData.lineWidth,type:wn?.type,id:wn?.id}))}),200)}}))}updateComment(e){return this.comment.editComment(e)}deleteCommentById(e){this.comment.deleteComment(e)}deleteAllComment(){this.comment.deleteAllComment()}};const zn=e=>new Promise((async(t,n)=>{if(!await(e=>new Promise(((t,n)=>{const i={fileName:e};fetch(`${Wt}isExistComment`,{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)}).then((e=>e.json())).then((e=>{t(e.message)}))})))(e))return;fetch(`${Gt}${e}/comment.json`).then((e=>e.text())).then((e=>{t(e)}))})),Vn=(e,t)=>{const n={fileName:e,commentData:JSON.stringify(t)};fetch(`${Wt}addComment`,{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}).then((e=>e.json())).then((e=>{200===e.code&&M({message:"保存成功",type:"success"})}))};let Fn=[];var Rn=Object.defineProperty,Bn=(e,t,n)=>(((e,t,n)=>{t in e?Rn(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);function _n(e,t){return e<=9?t:e>=10&&e<=59?parseFloat(t):e>=60&&e<=99?parseInt(t):e>=100&&e<=109?t:e>=110&&e<=149?parseFloat(t):e>=160&&e<=179?parseInt(t):e>=210&&e<=239?parseFloat(t):e>=270&&e<=289?parseInt(t):e>=290&&e<=299?function(e){if("0"===e)return!1;if("1"===e)return!0;throw TypeError("String '"+e+"' cannot be cast to Boolean type")}(t):e>=300&&e<=369?t:e>=370&&e<=389?parseInt(t):e>=390&&e<=399?t:e>=400&&e<=409?parseInt(t):e>=410&&e<=419?t:e>=420&&e<=429?parseInt(t):e>=430&&e<=439?t:e>=440&&e<=459?parseInt(t):e>=460&&e<=469?parseFloat(t):e>=470&&e<=481||999===e||e>=1e3&&e<=1009?t:e>=1010&&e<=1059?parseFloat(t):e>=1060&&e<=1071?parseInt(t):(console.log("WARNING: Group code does not have a defined type: %j",{code:e,value:t}),t)}var Hn=[0,16711680,16776960,65280,65535,255,16711935,16777215,8421504,12632256,16711680,16744319,13369344,13395558,10027008,10046540,8323072,8339263,4980736,4990502,16727808,16752511,13382400,13401958,10036736,10051404,8331008,8343359,4985600,4992806,16744192,16760703,13395456,13408614,10046464,10056268,8339200,8347455,4990464,4995366,16760576,16768895,13408512,13415014,10056192,10061132,8347392,8351551,4995328,4997670,16776960,16777087,13421568,13421670,10000384,10000460,8355584,8355647,5000192,5000230,12582656,14679935,10079232,11717734,7510016,8755276,6258432,7307071,3755008,4344870,8388352,12582783,6736896,10079334,5019648,7510092,4161280,6258495,2509824,3755046,4194048,10485631,3394560,8375398,2529280,6264908,2064128,5209919,1264640,3099686,65280,8388479,52224,6736998,38912,5019724,32512,4161343,19456,2509862,65343,8388511,52275,6737023,38950,5019743,32543,4161359,19475,2509871,65407,8388543,52326,6737049,38988,5019762,32575,4161375,19494,2509881,65471,8388575,52377,6737074,39026,5019781,32607,4161391,19513,2509890,65535,8388607,52428,6737100,39064,5019800,32639,4161407,19532,2509900,49151,8380415,39372,6730444,29336,5014936,24447,4157311,14668,2507340,32767,8372223,26316,6724044,19608,5010072,16255,4153215,9804,2505036,16383,8364031,13260,6717388,9880,5005208,8063,4149119,4940,2502476,255,8355839,204,6710988,152,5000344,127,4145023,76,2500172,4129023,10452991,3342540,8349388,2490520,6245528,2031743,5193599,1245260,3089996,8323327,12550143,6684876,10053324,4980888,7490712,4128895,6242175,2490444,3745356,12517631,14647295,10027212,11691724,7471256,8735896,6226047,7290751,3735628,4335180,16711935,16744447,13369548,13395660,9961624,9981080,8323199,8339327,4980812,4990540,16711871,16744415,13369497,13395634,9961586,9981061,8323167,8339311,4980793,4990530,16711807,16744383,13369446,13395609,9961548,9981042,8323135,8339295,4980774,4990521,16711743,16744351,13369395,13395583,9961510,9981023,8323103,8339279,4980755,4990511,3355443,5987163,8684676,11382189,14079702,16777215];function Yn(e){const t={};e.rewind();let n=e.next(),i=n.code;if(t.x=n.value,i+=10,n=e.next(),n.code!=i)throw new Error("Expected code for point value to be "+i+" but got "+n.code+".");return t.y=n.value,i+=10,n=e.next(),n.code!=i?(e.rewind(),t):(t.z=n.value,t)}function Xn(e,t){e.rewind();const n=[];for(let i=0;i<16;i++){const i=e.next();if(i.code!==t)throw new Error("Expected code for matrix value to be "+t+" but got "+i.code+".");n.push(i.value)}return n}function Un(e,t,n){switch(t.code){case 0:e.type=t.value;break;case 5:e.handle=t.value;break;case 6:e.lineType=t.value;break;case 8:e.layer=t.value;break;case 48:e.lineTypeScale=t.value;break;case 60:e.visible=0===t.value;break;case 62:e.colorIndex=t.value,e.color=function(e){return Hn[e]}(Math.abs(t.value));break;case 67:e.inPaperSpace=0!==t.value;break;case 100:break;case 101:for(;0!=t.code;)t=n.next();n.rewind();break;case 330:e.ownerHandle=t.value;break;case 347:e.materialObjectHandle=t.value;break;case 370:e.lineweight=t.value;break;case 420:e.color=t.value;break;case 1e3:e.extendedData=e.extendedData||{},e.extendedData.customStrings=e.extendedData.customStrings||[],e.extendedData.customStrings.push(t.value);break;case 1001:e.extendedData=e.extendedData||{},e.extendedData.applicationName=t.value;break;default:return!1}return!0}var Wn=Object.defineProperty,Gn=(e,t,n)=>(((e,t,n)=>{t in e?Wn(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);let qn=class{constructor(){Gn(this,"ForEntityName","3DFACE")}parseEntity(e,t){const n={type:t.value,vertices:[]};for(t=e.next();!e.isEOF()&&0!==t.code;){switch(t.code){case 70:n.shape=1==(1&t.value),n.hasContinuousLinetypePattern=128==(128&t.value);break;case 10:n.vertices=$n(e,t),t=e.lastReadGroup;break;default:Un(n,t,e)}t=e.next()}return n}};function $n(e,t){var n=[],i=!1,o=!1;for(let a=0;a<=4;a++){for(var s={};!e.isEOF()&&0!==t.code&&!o;){switch(t.code){case 10:case 11:case 12:case 13:if(i){o=!0;continue}s.x=t.value,i=!0;break;case 20:case 21:case 22:case 23:s.y=t.value;break;case 30:case 31:case 32:case 33:s.z=t.value;break;default:return n}t=e.next()}n.push(s),i=!1,o=!1}return e.rewind(),n}var Jn=Object.defineProperty,Kn=(e,t,n)=>(((e,t,n)=>{t in e?Jn(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);let Zn=class{constructor(){Kn(this,"ForEntityName","ARC")}parseEntity(e,t){const n={type:t.value};for(t=e.next();!e.isEOF()&&0!==t.code;){switch(t.code){case 10:n.center=Yn(e);break;case 40:n.radius=t.value;break;case 50:n.startAngle=Math.PI/180*t.value;break;case 51:n.endAngle=Math.PI/180*t.value,n.angleLength=n.endAngle-n.startAngle;break;case 210:n.extrusionDirectionX=t.value;break;case 220:n.extrusionDirectionY=t.value;break;case 230:n.extrusionDirectionZ=t.value;break;default:Un(n,t,e)}t=e.next()}return n}};var Qn=Object.defineProperty,ei=(e,t,n)=>(((e,t,n)=>{t in e?Qn(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);let ti=class{constructor(){ei(this,"ForEntityName","ATTDEF")}parseEntity(e,t){var n={type:t.value,scale:1,textStyle:"STANDARD"};for(t=e.next();!e.isEOF()&&0!==t.code;){switch(t.code){case 1:n.text=t.value;break;case 2:n.tag=t.value;break;case 3:n.prompt=t.value;break;case 7:n.textStyle=t.value;break;case 10:n.startPoint=Yn(e);break;case 11:n.endPoint=Yn(e);break;case 39:n.thickness=t.value;break;case 40:n.textHeight=t.value;break;case 41:n.scale=t.value;break;case 50:n.rotation=t.value;break;case 51:n.obliqueAngle=t.value;break;case 70:n.invisible=!!(1&t.value),n.constant=!!(2&t.value),n.verificationRequired=!!(4&t.value),n.preset=!!(8&t.value);break;case 71:n.backwards=!!(2&t.value),n.mirrored=!!(4&t.value);break;case 72:n.horizontalJustification=t.value;break;case 73:n.fieldLength=t.value;break;case 74:n.verticalJustification=t.value;break;case 100:break;case 210:n.extrusionDirectionX=t.value;break;case 220:n.extrusionDirectionY=t.value;break;case 230:n.extrusionDirectionZ=t.value;break;default:Un(n,t,e)}t=e.next()}return n}};var ni=Object.defineProperty,ii=(e,t,n)=>(((e,t,n)=>{t in e?ni(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);let oi=class{constructor(){ii(this,"ForEntityName","CIRCLE")}parseEntity(e,t){const n={type:t.value};for(t=e.next();!e.isEOF()&&0!==t.code;){switch(t.code){case 10:n.center=Yn(e);break;case 40:n.radius=t.value;break;case 50:n.startAngle=Math.PI/180*t.value;break;case 51:const i=Math.PI/180*t.value;i<n.startAngle?n.angleLength=i+2*Math.PI-n.startAngle:n.angleLength=i-n.startAngle,n.endAngle=i;break;default:Un(n,t,e)}t=e.next()}return n}};var si=Object.defineProperty,ai=(e,t,n)=>(((e,t,n)=>{t in e?si(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);let ri=class{constructor(){ai(this,"ForEntityName","DIMENSION")}parseEntity(e,t){const n={type:t.value};for(t=e.next();!e.isEOF()&&0!==t.code;){switch(t.code){case 2:n.block=t.value;break;case 10:n.anchorPoint=Yn(e);break;case 11:n.middleOfText=Yn(e);break;case 12:n.insertionPoint=Yn(e);break;case 13:n.linearOrAngularPoint1=Yn(e);break;case 14:n.linearOrAngularPoint2=Yn(e);break;case 15:n.diameterOrRadiusPoint=Yn(e);break;case 16:n.arcPoint=Yn(e);break;case 70:n.dimensionType=t.value;break;case 71:n.attachmentPoint=t.value;break;case 42:n.actualMeasurement=t.value;break;case 1:n.text=t.value;break;case 50:n.angle=t.value;break;default:Un(n,t,e)}t=e.next()}return n}};var li=Object.defineProperty,ci=(e,t,n)=>(((e,t,n)=>{t in e?li(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);class hi{constructor(){ci(this,"ForEntityName","MULTILEADER")}parseEntity(e,t){const n={type:t.value};function i(){for(;!e.isEOF();){switch(t.code){case 40:n.contextData.contentScale=t.value;break;case 10:n.contextData.contentBasePosition=Yn(e);break;case 145:n.contextData.landingGap=t.value;break;case 290:n.contextData.hasMText=t.value;break;case 304:n.contextData.defaultTextContents=t.value;break;case 11:n.contextData.textNormalDirection=Yn(e);break;case 12:n.contextData.textLocation=Yn(e);break;case 13:n.contextData.textDirection=Yn(e);break;case 140:n.contextData.arrowHeadSize=t.value;break;case 41:case 44:n.contextData.textHeight=t.value;break;case 42:n.contextData.textRotation=t.value;break;case 43:n.contextData.textWidth=t.value;break;case 45:n.contextData.textLineSpacingFactor=t.value;break;case 90:n.contextData.textColor=t.value;break;case 170:n.contextData.textLineSpacingStyle=t.value;break;case 171:n.contextData.textAttachment=t.value;break;case 172:n.contextData.textFlowDirection=t.value;break;case 141:n.contextData.textBackgroundScaleFactor=t.value;break;case 92:n.contextData.textBackgroundTransparency=t.value;break;case 291:n.contextData.textBackgroundColorOn=t.value;break;case 292:n.contextData.textBackgroundFillOn=t.value;break;case 293:n.contextData.textUseAutoHeight=t.value;break;case 173:n.contextData.textColumnType=t.value;break;case 142:n.contextData.textColumnWidth=t.value;break;case 143:n.contextData.textColumnGutterWidth=t.value;break;case 144:n.contextData.textColumnHeight=t.value;break;case 295:n.contextData.textUseWordBreak=t.value;break;case 296:n.contextData.hasBlock=t.value;break;case 341:n.contextData.blockContentId=t.value;break;case 14:n.contextData.blockContentNormalDirection=Yn(e);break;case 15:n.contextData.blockContentPosition=Yn(e);break;case 16:n.contextData.blockContentScale=t.value;break;case 46:n.contextData.blockContentRotation=t.value;break;case 93:n.contextData.blockContentColor=t.value;break;case 47:n.contextData.blockTransformationMatrix=Xn(e,47);break;case 110:n.contextData.planeOriginPoint=Yn(e);break;case 111:n.contextData.planeXAxisDirection=Yn(e);break;case 112:n.contextData.planeYAxisDirection=Yn(e);break;case 297:n.contextData.planeNormalReversed=t.value;break;case 301:return;case 302:o()}t=e.next()}}function o(){const i={leaderLines:[]};for(n.contextData.leaders.push(i);!e.isEOF();){switch(t.code){case 290:i.hasSetLastLeaderLinePoint=t.value;break;case 291:i.hasSetDoglegVector=t.value;break;case 10:i.lastLeaderLinePoint=Yn(e);break;case 11:i.doglegVector=Yn(e);break;case 90:i.leaderBranchIndex=t.value;break;case 40:i.doglegLength=t.value;break;case 303:return;case 304:s()}t=e.next()}}function s(){const i={vertices:[[]]};for(n.contextData.leaders[n.contextData.leaders.length-1].leaderLines.push(i);!e.isEOF();){switch(t.code){case 10:i.vertices[0].push(Yn(e));break;case 305:return}t=e.next()}}return n.contextData={leaders:[]},t=e.next(),function(){for(;!e.isEOF();){switch(t.code){case 0:return;case 340:n.leaderStyleId=t.value;break;case 170:n.leaderLineType=t.value;break;case 91:n.leaderLineColor=t.value;break;case 341:n.leaderLineTypeId=t.value;break;case 171:n.leaderLineWeight=t.value;break;case 41:n.doglegLength=t.value;break;case 290:n.enableLanding=t.value;break;case 291:n.enableDogLeg=t.value;break;case 342:n.arrowHeadId=t.value;break;case 42:n.arrowHeadSize=t.value;break;case 172:n.contentType=t.value;break;case 173:case 95:n.textLeftAttachmentType=t.value;break;case 174:n.textAngleType=t.value;break;case 175:n.textAlignmentType=t.value;break;case 343:n.textStyleId=t.value;break;case 92:n.textColor=t.value;break;case 292:n.enableFrameText=t.value;break;case 344:n.blockContentId=t.value;break;case 93:n.blockContentColor=t.value;break;case 10:n.blockContentScale=Yn(e);break;case 43:n.blockContentRotation=t.value;break;case 176:n.blockContentConnectionType=t.value;break;case 293:n.enableAnotationScale=t.value;break;case 94:n.arrowHeadIndex=t.value;break;case 330:n.blockAttributeId=t.value;break;case 177:n.blockAttributeIndex=t.value;break;case 44:n.blockAttributeWidth=t.value;break;case 302:n.blockAttributeTextString=t.value;break;case 294:n.textDirectionNegative=t.value;break;case 178:n.textAlignInIPE=t.value;break;case 179:n.textAttachmentPoint=t.value;break;case 271:n.textAttachmentDirectionMText=t.value;break;case 272:n.textAttachmentDirectionBottom=t.value;break;case 273:n.textAttachmentDirectionTop=t.value;break;case 300:i();break;default:Un(n,t,e)}t=e.next()}}(),n}}var ui=Object.defineProperty,di=(e,t,n)=>(((e,t,n)=>{t in e?ui(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);let pi=class{constructor(){di(this,"ForEntityName","ELLIPSE")}parseEntity(e,t){const n={type:t.value};for(t=e.next();!e.isEOF()&&0!==t.code;){switch(t.code){case 10:n.center=Yn(e);break;case 11:n.majorAxisEndPoint=Yn(e);break;case 40:n.axisRatio=t.value;break;case 41:n.startAngle=t.value;break;case 42:n.endAngle=t.value;break;case 2:n.name=t.value;break;case 210:n.extrusionDirection=Yn(e);break;default:Un(n,t,e)}t=e.next()}return n}};var fi=Object.defineProperty,mi=(e,t,n)=>(((e,t,n)=>{t in e?fi(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);let bi=class{constructor(){mi(this,"ForEntityName","INSERT")}parseEntity(e,t){const n={type:t.value};for(t=e.next();!e.isEOF()&&0!==t.code;){switch(t.code){case 2:n.name=t.value;break;case 41:n.xScale=t.value;break;case 42:n.yScale=t.value;break;case 43:n.zScale=t.value;break;case 10:n.position=Yn(e);break;case 50:n.rotation=t.value;break;case 70:n.columnCount=t.value;break;case 71:n.rowCount=t.value;break;case 44:n.columnSpacing=t.value;break;case 45:n.rowSpacing=t.value;break;case 210:n.extrusionDirection=Yn(e);break;default:Un(n,t,e)}t=e.next()}return n.extrusionDirection&&-1===n.extrusionDirection.z&&(n.position.x=-n.position.x),n}};var yi=Object.defineProperty,xi=(e,t,n)=>(((e,t,n)=>{t in e?yi(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);let vi=class{constructor(){xi(this,"ForEntityName","LINE")}parseEntity(e,t){const n={type:t.value,vertices:[]};for(t=e.next();!e.isEOF()&&0!==t.code;){switch(t.code){case 10:n.vertices.unshift(Yn(e));break;case 11:n.vertices.push(Yn(e));break;case 210:n.extrusionDirection=Yn(e);break;case 100:break;default:Un(n,t,e)}0!==n.vertices.length&&n.vertices.forEach(((e,t)=>{if(0===t){const t=e.x+"",i=e.y+"";if(t.split(".").length>1){const e=t.split(".")[0];if(0!==t.split(".")[1].length){const t=100*Number(e);n.offsetX=t}}if(i.split(".").length>1){const e=i.split(".")[0];if(0!==i.split(".")[1].length){const t=100*Number(e);n.offsetY=t}}}})),t=e.next()}return n}};var gi=Object.defineProperty,wi=(e,t,n)=>(((e,t,n)=>{t in e?gi(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);let ki=class{constructor(){wi(this,"ForEntityName","LWPOLYLINE")}parseEntity(e,t){const n={type:t.value,vertices:[]};let i=0;for(t=e.next();!e.isEOF()&&0!==t.code;){switch(t.code){case 38:n.elevation=t.value;break;case 39:n.depth=t.value;break;case 70:n.shape=1==(1&t.value),n.hasContinuousLinetypePattern=128==(128&t.value);break;case 90:i=t.value;break;case 10:n.vertices=Ei(i,e);break;case 43:0!==t.value&&(n.width=t.value);break;case 210:n.extrusionDirectionX=t.value;break;case 220:n.extrusionDirectionY=t.value;break;case 230:n.extrusionDirectionZ=t.value;break;default:Un(n,t,e)}if(0!==n.vertices.length){let e=null,t=null;n.vertices.forEach(((n,i)=>{const o=n.x+"",s=n.y+"";if(o.split(".").length>1){const t=o.split(".")[0];0!==o.split(".")[1].length&&(!e||e<100*Number(t))&&(e=100*Number(t))}if(s.split(".").length>1){const e=s.split(".")[0];0!==s.split(".")[1].length&&(!t||t<100*Number(e))&&(t=100*Number(e))}})),n.offsetX=e,n.offsetY=t}t=e.next()}return n}};function Ei(e,t){if(!e||e<=0)throw Error("n must be greater than 0 verticies");const n=[];let i=!1,o=!1,s=t.lastReadGroup;for(let a=0;a<e;a++){const e={};for(;!t.isEOF()&&0!==s.code&&!o;){switch(s.code){case 10:if(i){o=!0;continue}e.x=s.value,i=!0;break;case 20:e.y=s.value;break;case 30:e.z=s.value;break;case 40:e.startWidth=s.value;break;case 41:e.endWidth=s.value;break;case 42:0!=s.value&&(e.bulge=s.value);break;default:return t.rewind(),i&&n.push(e),t.rewind(),n}s=t.next()}n.push(e),i=!1,o=!1}return t.rewind(),n}var Si=Object.defineProperty,Pi=(e,t,n)=>(((e,t,n)=>{t in e?Si(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);let Mi=class{constructor(){Pi(this,"ForEntityName","MTEXT")}parseEntity(e,t){const n={type:t.value};for(t=e.next();!e.isEOF()&&0!==t.code;){switch(t.code){case 3:case 1:n.text?n.text+=t.value:n.text=t.value;break;case 7:n.textStyleName=t.value;break;case 10:n.position=Yn(e);break;case 11:n.directionVector=Yn(e);break;case 40:n.height=t.value;break;case 41:n.width=t.value;break;case 50:n.rotation=t.value;break;case 71:n.attachmentPoint=t.value;break;case 72:n.drawingDirection=t.value;break;case 90:n.backgroundFillSetting=t.value;break;case 100:n.subClassMarker=t.value;break;case 210:n.extrusionDirection=Yn(e);break;default:Un(n,t,e)}t=e.next()}return n}};var Li=Object.defineProperty,Di=(e,t,n)=>(((e,t,n)=>{t in e?Li(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);let Ti=class{constructor(){Di(this,"ForEntityName","POINT")}parseEntity(e,t){const n={type:t.value};for(t=e.next();!e.isEOF()&&0!==t.code;){switch(t.code){case 10:n.position=Yn(e);break;case 39:n.thickness=t.value;break;case 210:n.extrusionDirection=Yn(e);break;case 100:break;default:Un(n,t,e)}t=e.next()}return n}};var Ai=Object.defineProperty,Oi=(e,t,n)=>(((e,t,n)=>{t in e?Ai(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);var Ci=Object.defineProperty,Ni=(e,t,n)=>(((e,t,n)=>{t in e?Ci(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);let Ii=class{constructor(){Ni(this,"ForEntityName","POLYLINE")}parseEntity(e,t){var n={type:t.value,vertices:[]};for(t=e.next();!e.isEOF()&&0!==t.code;){switch(t.code){case 10:case 20:case 30:case 40:case 41:case 71:case 72:case 73:case 74:case 75:break;case 39:n.thickness=t.value;break;case 70:n.shape=0!=(1&t.value),n.includesCurveFitVertices=0!=(2&t.value),n.includesSplineFitVertices=0!=(4&t.value),n.is3dPolyline=0!=(8&t.value),n.is3dPolygonMesh=0!=(16&t.value),n.is3dPolygonMeshClosed=0!=(32&t.value),n.isPolyfaceMesh=0!=(64&t.value),n.hasContinuousLinetypePattern=0!=(128&t.value);break;case 210:n.extrusionDirection=Yn(e);break;default:Un(n,t,e)}0!==n.vertices.length&&n.vertices.some(((e,t)=>{if(0===t){const t=e.x+"",i=e.y+"";if(t.split(".").length>1){const e=t.split(".")[0];if(0!==t.split(".")[1].length){const t=100*Number(e);n.offsetX=t}}if(i.split(".").length>1){const e=i.split(".")[0];if(0!==i.split(".")[1].length){const t=100*Number(e);n.offsetY=t}}}if(e.bulge)return n.offsetX=null,n.offsetY=null,!0})),t=e.next()}return n.vertices=function(e,t){const n=new class{constructor(){Oi(this,"ForEntityName","VERTEX")}parseEntity(e,t){var n={type:t.value};for(t=e.next();!e.isEOF()&&0!==t.code;){switch(t.code){case 10:n.x=t.value;break;case 20:n.y=t.value;break;case 30:n.z=t.value;break;case 40:case 41:case 50:break;case 42:0!=t.value&&(n.bulge=t.value);break;case 70:n.curveFittingVertex=0!=(1&t.value),n.curveFitTangent=0!=(2&t.value),n.splineVertex=0!=(8&t.value),n.splineControlPoint=0!=(16&t.value),n.threeDPolylineVertex=0!=(32&t.value),n.threeDPolylineMesh=0!=(64&t.value),n.polyfaceMeshVertex=0!=(128&t.value);break;case 71:n.faceA=t.value;break;case 72:n.faceB=t.value;break;case 73:n.faceC=t.value;break;case 74:n.faceD=t.value;break;default:Un(n,t,e)}t=e.next()}return n}},i=[];for(;!e.isEOF();)if(0===t.code)if("VERTEX"===t.value)i.push(n.parseEntity(e,t)),t=e.lastReadGroup;else if("SEQEND"===t.value){ji(e,t);break}return i}(e,t),n}};function ji(e,t){const n={type:t.value};for(t=e.next();!e.isEOF()&&0!=t.code;)Un(n,t,e),t=e.next();return n}var zi=Object.defineProperty,Vi=(e,t,n)=>(((e,t,n)=>{t in e?zi(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);let Fi=class{constructor(){Vi(this,"ForEntityName","SOLID")}parseEntity(e,t){const n={type:t.value,points:[]};for(t=e.next();!e.isEOF()&&0!==t.code;){switch(t.code){case 10:n.points[0]=Yn(e);break;case 11:n.points[1]=Yn(e);break;case 12:n.points[2]=Yn(e);break;case 13:n.points[3]=Yn(e);break;case 210:n.extrusionDirection=Yn(e);break;default:Un(n,t,e)}t=e.next()}return n}};var Ri=Object.defineProperty,Bi=(e,t,n)=>(((e,t,n)=>{t in e?Ri(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);let _i=class{constructor(){Bi(this,"ForEntityName","SPLINE")}parseEntity(e,t){const n={type:t.value};for(t=e.next();!e.isEOF()&&0!==t.code;){switch(t.code){case 10:n.controlPoints||(n.controlPoints=[]),n.controlPoints.push(Yn(e));break;case 11:n.fitPoints||(n.fitPoints=[]),n.fitPoints.push(Yn(e));break;case 12:n.startTangent=Yn(e);break;case 13:n.endTangent=Yn(e);break;case 40:n.knotValues||(n.knotValues=[]),n.knotValues.push(t.value);break;case 70:1&t.value&&(n.closed=!0),2&t.value&&(n.periodic=!0),4&t.value&&(n.rational=!0),8&t.value&&(n.planar=!0),16&t.value&&(n.planar=!0,n.linear=!0);break;case 71:n.degreeOfSplineCurve=t.value;break;case 72:n.numberOfKnots=t.value;break;case 73:n.numberOfControlPoints=t.value;break;case 74:n.numberOfFitPoints=t.value;break;case 210:n.normalVector=Yn(e);break;default:Un(n,t,e)}t=e.next()}return n}};var Hi=Object.defineProperty,Yi=(e,t,n)=>(((e,t,n)=>{t in e?Hi(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);let Xi=class{constructor(){Yi(this,"ForEntityName","TEXT")}parseEntity(e,t){const n={type:t.value};for(t=e.next();!e.isEOF()&&0!==t.code;){switch(t.code){case 10:n.startPoint=Yn(e);break;case 11:n.endPoint=Yn(e);break;case 40:n.textHeight=t.value;break;case 41:n.xScale=t.value;break;case 50:n.rotation=t.value;break;case 1:n.text=t.value;break;case 72:n.halign=t.value;break;case 73:n.valign=t.value;break;default:Un(n,t,e)}t=e.next()}return n}};var Ui=Object.defineProperty,Wi=(e,t,n)=>(((e,t,n)=>{t in e?Ui(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);let Gi=class{constructor(){Wi(this,"ForEntityName","MLINE")}parseEntity(e,t){const n={type:t.value,startPoint:[],vertices:[],directionVector:[],miterDirectionVector:[]};for(t=e.next();!e.isEOF()&&0!==t.code;){switch(t.code){case 2:n.mlineStype=t.value;break;case 10:n.startPoint.push(Yn(e));break;case 11:n.vertices.push(Yn(e));break;case 12:n.directionVector.push(Yn(e));break;case 13:n.miterDirectionVector.push(Yn(e));break;case 40:n.scaleFactor=t.value;break;case 70:n.justification=t.value;break;case 71:n.flags=t.value;break;case 72:n.verticesNum=t.value;break;case 73:n.elementsNum=t.value;break;case 210:n.extrusionDirection=Yn(e);break;case 100:break;default:Un(n,t,e)}0!==n.vertices.length&&n.vertices.forEach(((e,t)=>{if(0===t){const t=e.x+"",i=e.y+"";if(t.split(".").length>1){const e=t.split(".")[0];if(0!==t.split(".")[1].length){const t=100*Number(e);n.offsetX=t}}if(i.split(".").length>1){const e=i.split(".")[0];if(0!==i.split(".")[1].length){const t=100*Number(e);n.offsetY=t}}}})),t=e.next()}return n}};var qi=Object.defineProperty,$i=(e,t,n)=>(((e,t,n)=>{t in e?qi(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);function Ji(e){e.registerEntityHandler(qn),e.registerEntityHandler(Zn),e.registerEntityHandler(ti),e.registerEntityHandler(oi),e.registerEntityHandler(ri),e.registerEntityHandler(hi),e.registerEntityHandler(pi),e.registerEntityHandler(bi),e.registerEntityHandler(vi),e.registerEntityHandler(ki),e.registerEntityHandler(Mi),e.registerEntityHandler(Ti),e.registerEntityHandler(Ii),e.registerEntityHandler(Fi),e.registerEntityHandler(_i),e.registerEntityHandler(Xi),e.registerEntityHandler(Gi)}class Ki{constructor(){$i(this,"_entityHandlers",{}),Ji(this)}parse(e){return"string"==typeof e?this._parse(e):(console.error("Cannot read dxf source of type `"+typeof e),null)}registerEntityHandler(e){const t=new e;this._entityHandlers[t.ForEntityName]=t}parseSync(e){return this.parse(e)}parseStream(e){let t="";const n=this;return new Promise(((i,o)=>{e.on("data",(e=>{t+=e})),e.on("end",(()=>{try{i(n._parse(t))}catch(e){o(e)}})),e.on("error",(e=>{o(e)}))}))}_parse(e){const t={};let n=0;const i=e.split(/\r\n|\r|\n/g),o=new class{constructor(e){Bn(this,"_pointer",0),Bn(this,"_eof",!1),Bn(this,"lastReadGroup"),Bn(this,"_data"),this._data=e}next(){if(!this.hasNext())throw this._eof?new Error("Cannot call 'next' after EOF group has been read"):new Error("Unexpected end of input: EOF group not read before end of file. Ended on code "+this._data[this._pointer]);const e={code:parseInt(this._data[this._pointer])};return this._pointer++,e.value=_n(e.code,this._data[this._pointer].trim()),this._pointer++,0===e.code&&"EOF"===e.value&&(this._eof=!0),this.lastReadGroup=e,e}peek(){if(!this.hasNext())throw this._eof?new Error("Cannot call 'next' after EOF group has been read"):new Error("Unexpected end of input: EOF group not read before end of file. Ended on code "+this._data[this._pointer]);const e={code:parseInt(this._data[this._pointer])};return e.value=_n(e.code,this._data[this._pointer+1].trim()),e}rewind(e=1){this._pointer=this._pointer-2*e}hasNext(){return!(this._eof||this._pointer>this._data.length-2)}isEOF(){return this._eof}}(i);if(!o.hasNext())throw Error("Empty file");const s=this;let a;function r(){let e=null,t=null;const n={};for(a=o.next();;){if(Zi(a,0,"ENDSEC")){e&&(n[e]=t);break}9===a.code?(e&&(n[e]=t),e=a.value):10===a.code?t={x:a.value}:20===a.code?t.y=a.value:30===a.code?t.z=a.value:t=a.value,a=o.next()}return a=o.next(),n}function l(){const e={mlineStyle:{}};for(a=o.next();"ENDSEC"!==a.value;)if(Zi(a,0,"MLINESTYLE")){a=o.next();let t={mlineData:[]};for(;;){switch(a.code){case 2:t.mlineStyleName=a.value;break;case 49:t.mlineData.push(c(a));break;case 51:t.startAngle=a.value;break;case 52:t.endAngle=a.value;break;case 70:t.flags=a.value}if(0===a.code){e.mlineStyle[t.mlineStyleName]=t;break}a=o.next()}}else a=o.next();return e}function c(e){let t={};return e.code,t.elementOffset=e.value,e=o.next(),t.fillColor=e.value,e=o.next(),t.lineType=e.value,t}function h(){const e={};for(a=o.next();"EOF"!==a.value&&!Zi(a,0,"ENDSEC");)if(Zi(a,0,"BLOCK")){const t=u();x(t),t.name?e[t.name]=t:console.log('block with handle "'+t.handle+'" is missing a name.')}else a=o.next();return e}function u(){const e={};for(a=o.next();"EOF"!==a.value;){switch(a.code){case 1:e.xrefPath=a.value,a=o.next();break;case 2:e.name=a.value,a=o.next();break;case 3:e.name2=a.value,a=o.next();break;case 5:e.handle=a.value,a=o.next();break;case 8:e.layer=a.value,a=o.next();break;case 10:e.position=y(a),a=o.next();break;case 67:e.paperSpace=!(!a.value||1!=a.value),a=o.next();break;case 70:0!=a.value&&(e.type=a.value),a=o.next();break;case 100:default:a=o.next();break;case 330:e.ownerHandle=a.value,a=o.next();break;case 0:if("ENDBLK"==a.value)break;e.entities=b(!0)}if(Zi(a,0,"ENDBLK")){a=o.next();break}}for(let t=0;t<e.entities?.length;t++)if(e.position&&0!==e.position.x){const n={x:e.position.x,y:e.position.y};e.entities[t].vertices&&e.entities[t].vertices.forEach((e=>{e.x=n.x-e.x,e.y=n.y-e.y,e.z=n.z-e.z})),e.entities[t].center&&(e.entities[t].center.x=n.x-e.entities[t].center.x,e.entities[t].center.y=n.y-e.entities[t].center.y)}return e}function d(){const e={};for(a=o.next();"EOF"!==a.value&&!Zi(a,0,"ENDSEC");)Zi(a,0,"TABLE")?(a=o.next(),m[a.value]&&(e[m[a.value].tableName]=f(a))):a=o.next();return a=o.next(),e}const p="ENDTAB";function f(e){const t=m[e.value],n={};for(a=o.next();!Zi(a,0,p);)switch(a.code){case 5:n.handle=a.value,a=o.next();break;case 330:n.ownerHandle=a.value,a=o.next();break;case 100:case 70:a.value,a=o.next();break;case 0:a.value===t.dxfSymbolName?n[t.tableRecordsProperty]=t.parseTableRecords():a=o.next();break;default:a=o.next()}const i=n[t.tableRecordsProperty];return i&&(i.constructor===Array?i.length:"object"==typeof i&&Object.keys(i).length),a=o.next(),n}const m={VPORT:{tableRecordsProperty:"viewPorts",tableName:"viewPort",dxfSymbolName:"VPORT",parseTableRecords:function(){const e=[];let t={};for(a=o.next();!Zi(a,0,p);)switch(a.code){case 2:t.name=a.value,a=o.next();break;case 10:t.lowerLeftCorner=y(a),a=o.next();break;case 11:t.upperRightCorner=y(a),a=o.next();break;case 12:t.center=y(a),a=o.next();break;case 13:t.snapBasePoint=y(a),a=o.next();break;case 14:t.snapSpacing=y(a),a=o.next();break;case 15:t.gridSpacing=y(a),a=o.next();break;case 16:t.viewDirectionFromTarget=y(a),a=o.next();break;case 17:t.viewTarget=y(a),a=o.next();break;case 42:t.lensLength=a.value,a=o.next();break;case 43:t.frontClippingPlane=a.value,a=o.next();break;case 44:t.backClippingPlane=a.value,a=o.next();break;case 45:t.viewHeight=a.value,a=o.next();break;case 50:t.snapRotationAngle=a.value,a=o.next();break;case 51:t.viewTwistAngle=a.value,a=o.next();break;case 79:t.orthographicType=a.value,a=o.next();break;case 110:t.ucsOrigin=y(a),a=o.next();break;case 111:t.ucsXAxis=y(a),a=o.next();break;case 112:t.ucsYAxis=y(a),a=o.next();break;case 281:t.renderMode=a.value,a=o.next();break;case 282:t.defaultLightingType=a.value,a=o.next();break;case 292:t.defaultLightingOn=a.value,a=o.next();break;case 330:t.ownerHandle=a.value,a=o.next();break;case 63:case 421:case 431:t.ambientColor=a.value,a=o.next();break;case 0:"VPORT"===a.value&&(e.push(t),t={},a=o.next());break;default:a=o.next()}return e.push(t),e}},LTYPE:{tableRecordsProperty:"lineTypes",tableName:"lineType",dxfSymbolName:"LTYPE",parseTableRecords:function(){const e={};let t,n={},i=0;for(a=o.next();!Zi(a,0,"ENDTAB");)switch(a.code){case 2:n.name=a.value,t=a.value,a=o.next();break;case 3:n.description=a.value,a=o.next();break;case 73:i=a.value,i>0&&(n.pattern=[]),a=o.next();break;case 40:n.patternLength=a.value,a=o.next();break;case 49:n.pattern.push(a.value),a=o.next();break;case 0:i>0&&i!==n.pattern.length&&console.log("lengths do not match on LTYPE pattern"),e[t]=n,n={},a=o.next();break;default:a=o.next()}return e[t]=n,e}},LAYER:{tableRecordsProperty:"layers",tableName:"layer",dxfSymbolName:"LAYER",parseTableRecords:function(){const e={};let t,n={};for(a=o.next();!Zi(a,0,"ENDTAB");)switch(a.code){case 2:n.name=a.value,t=a.value,a=o.next();break;case 62:n.visible=a.value>=0,n.colorIndex=Math.abs(a.value),n.color=(i=n.colorIndex,Hn[i]),a=o.next();break;case 70:n.frozen=0!=(1&a.value)||0!=(2&a.value),a=o.next();break;case 420:n.color=Math.abs(a.value),a=o.next();break;case 0:"LAYER"===a.value&&(e[t]=n,n={},t=void 0,a=o.next());break;default:a=o.next()}var i;return e[t]=n,e}}};function b(e){const t=[],n=e?"ENDBLK":"ENDSEC";for(e||(a=o.next());;)if(0===a.code){if(a.value===n)break;const e=s._entityHandlers[a.value];if(null==e){a=o.next();continue}{const n=e.parseEntity(o,a);a=o.lastReadGroup,x(n),t.push(n)}}else a=o.next();return"ENDSEC"==n&&(a=o.next()),t}function y(e){const t={};let n=e.code;if(t.x=e.value,n+=10,(e=o.next()).code!=n)throw new Error("Expected code for point value to be "+n+" but got "+e.code+".");return t.y=e.value,n+=10,(e=o.next()).code!=n?(o.rewind(),t):(t.z=e.value,t)}function x(e){if(!e)throw new TypeError("entity cannot be undefined or null");e.handle||(e.handle=n++)}return function(){for(a=o.next();!o.isEOF();)if(0===a.code&&"SECTION"===a.value){if(a=o.next(),2!==a.code){console.error("Unexpected code %s after 0:SECTION",(e=a).code+":"+e.value),a=o.next();continue}"HEADER"===a.value?t.header=r():"BLOCKS"===a.value?t.blocks=h():"ENTITIES"===a.value?t.entities=b(!1):"TABLES"===a.value?t.tables=d():"EOF"===a.value?console.log("EOF"):"OBJECTS"===a.value&&(t.objects=l())}else a=o.next();var e}(),t}}function Zi(e,t,n){return e.code===t&&e.value===n}const Qi=e=>{let t=new Float32Array(16);var n=Math.sin(e),i=Math.cos(e);return t[0]=i,t[1]=n,t[2]=0,t[3]=0,t[4]=-n,t[5]=i,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},eo=(e,t)=>{let n=[];for(let i=0;i<e.length;i+=3){let o=e[i],s=e[i+1],a=e[i+2];if(null!==o&&null!==s&&null!==a){let e=[];e.push(t[0]*o+t[4]*s+t[8]*a+1*t[12]),e.push(t[1]*o+t[5]*s+t[9]*a+1*t[13]),e.push(t[2]*o+t[6]*s+t[10]*a+1*t[14]),n.push(...e)}}return n};var to=Object.defineProperty,no=(e,t,n)=>(((e,t,n)=>{t in e?to(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);const io=(e,t)=>{let n=null;if(e.color)n=e.color;else if(0===e.colorIndex)n=16777215;else if(t.tables&&t.tables.layer&&t.tables.layer.layers[e.layer]){const{visible:i,frozen:o}=t.tables.layer.layers[e.layer];if(!i||o)return null;n=t.tables.layer.layers[e.layer].color}const{type:i,extendColor:o,blockColor:s,layerColor:a,layer:r}=e;return(0===e.color||"MTEXT"===i)&&(o&&"byBlock"===o?n=s:o&&"byLayer"===o&&(n=a)),void 0===e.color&&void 0===e.colorIndex&&"0"===r&&a&&(n=a),n};class oo{constructor(e=0,t=0){no(this,"x"),no(this,"y"),this.x=e,this.y=t}distanceTo(e){return Math.sqrt(this.distanceToSquared(e))}distanceToSquared(e){const t=this.x-e.x,n=this.y-e.y;return t*t+n*n}sub(e){return this.x-=e.x,this.y-=e.y,this}normalize(){return this.divideScalar(this.length()||1)}divideScalar(e){return this.multiplyScalar(1/e)}multiplyScalar(e){return this.x*=e,this.y*=e,this}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}}class so extends oo{constructor(e=0,t=0,n=0){super(e,t),no(this,"z"),this.z=n}distanceTo(e){return Math.sqrt(this.distanceToSquared(e))}distanceToSquared(e){const t=this.x-e.x,n=this.y-e.y,i=this.z-e.z;return t*t+n*n+i*i}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this}normalize(){return this.divideScalar(this.length()||1)}divideScalar(e){return this.multiplyScalar(1/e)}multiplyScalar(e){return this.x*=e,this.y*=e,this.z*=e,this}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this}cross(e){return this.crossVectors(this,e)}crossVectors(e,t){const n=e.x,i=e.y,o=e.z,s=t.x,a=t.y,r=t.z;return this.x=i*r-o*a,this.y=o*s-n*r,this.z=n*a-i*s,this}}var ao=Object.defineProperty,ro=(e,t,n)=>(((e,t,n)=>{t in e?ao(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);let lo=class{constructor(){ro(this,"position",[]),ro(this,"color",16777215),ro(this,"positions",[]),ro(this,"colors",[])}flatPosition(e){let t=[];return e.forEach((e=>{t.push(e.x,e.y,0)})),t}changeToLineSegments(e){if(e.length>6){const t=e.length/3;let n=0;for(let i=1;i<t-1;i++){const t=3*i+3*n;e.splice(t,0,e[t],e[t+1],e[t+2]),n++}}else if(3===e.length)return[];return e}fillColor(e,t){this.colors=[];for(let n=0;n<e.length/3;n++)this.colors.push(t.r,t.g,t.b)}getMaxOrMinPositionArray(){if(1===this.position.length)return null;let e={max:new oo(0,0),min:new oo(0,0)};return this.position.forEach(((t,n)=>{0===n?(e.max.x=t.x,e.min.x=t.x,e.max.y=t.y,e.min.y=t.y):(e.min.x>t.x&&(e.min.x=t.x),e.min.y>t.y&&(e.min.y=t.y),e.max.x<t.x&&(e.max.x=t.x),e.max.y<t.y&&(e.max.y=t.y))})),e}};var co=Object.defineProperty,ho=(e,t,n)=>(((e,t,n)=>{t in e?co(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);const uo=(e,t)=>{let n=new oo(e.x,e.y),i=new oo(t.x,t.y);return i.sub(n),i.normalize(),i.y<0?-Math.acos(i.x):Math.acos(i.x)},po=(e,t,n)=>{let i=new oo;return i.x=e.x+t*Math.cos(n),i.y=e.y+t*Math.sin(n),i},fo=(e,t,n,i)=>{let o=e?new so(e.x,e.y,0):new so(0,0,0),s=t?new so(t.x,t.y,0):new so(1,0,0);n=n||1;let a=4*Math.atan(n),r=o.distanceTo(s)/2/Math.sin(a/2),l=po(e,r,uo(o,s)+(Math.PI/2-a/2));i=i||Math.max(Math.abs(Math.ceil(a/(Math.PI/18))),6);let c=uo(l,o),h=a/i,u=[];u.push(new so(o.x,o.y,0));for(let e=1;e<=i-1;e++){let t=po(l,Math.abs(r),c+h*e);u.push(new so(t.x,t.y,0))}return[e,...u,t]};let mo=class extends lo{constructor(t,n,i){if(super(),ho(this,"type","Line"),ho(this,"color",16777215),ho(this,"layer","0"),ho(this,"position",[]),ho(this,"positions",[]),ho(this,"isDashed",!1),ho(this,"box"),ho(this,"offsetX"),ho(this,"offsetY"),ho(this,"lineTypeScale"),ho(this,"lineTypeData"),ho(this,"shape"),ho(this,"mlineOffset",1),ho(this,"scaleFactor"),"MLINE"===t.type){const e=n.objects.mlineStyle[t.mlineStype];t.mlineOffset=Math.abs(e.mlineData[0].elementOffset-e.mlineData[1].elementOffset)}if(this.color=io(t,n),this.type=t.type,this.offsetX=t.offsetX,this.offsetY=t.offsetY,this.layer=t.layer,this.lineTypeScale=t.lineTypeScale,this.shape=t.shape,this.mlineOffset=t.mlineOffset,this.scaleFactor=t.scaleFactor,t.vertices)for(let e=0;e<t.vertices.length;e++){let n=t.vertices[e];if("number"==typeof n.x&&"number"==typeof n.y)if(-1===t.extrusionDirection?.z&&t.vertices[e].type&&(n.x=-n.x),n.bulge){let i=n.bulge;if(e+1===t.vertices.length&&!t.shape)break;let o=new so(n.x,n.y,0),s=e+1<t.vertices.length?t.vertices[e+1]:t.vertices[0];s.z=0;let a=fo(o,s,i);this.position.push.apply(this.position,a)}else this.position.push(new so(n.x,n.y,0))}let o;if(t.shape&&0!==this.position.length&&this.position.push(this.position[0]),t.lineType&&(o=n.tables.lineType.lineTypes[t.lineType]),o&&o.pattern&&0!==o.pattern.length&&(this.lineTypeData=o,this.isDashed=!0),"MLINE"===this.type){const t=new e.Vector3(1,0,0),n=new e.Vector3(this.position[1].x-this.position[0].x,this.position[1].y-this.position[0].y,this.position[1].z-this.position[0].z);let i=Math.PI/2-t.angleTo(n);const o=this.scaleFactor;let s=this.mlineOffset*Math.cos(i)*o,a=-this.mlineOffset*Math.sin(i)*o;this.position[1].y-this.position[0].y<0&&(s=-s,a=-a);let r=[];this.position.forEach((e=>{r.push(new so(e.x+s,e.y+a,0))}));const l=this.flatPosition(r),c=this.flatPosition(this.position);this.positions.push({index:0,positions:c}),this.positions.push({index:1,positions:l}),this.box=this.getMaxOrMinPositionArray()}else this.box=this.getMaxOrMinPositionArray(),this.positions=this.flatPosition(this.position)}};var bo=Object.defineProperty,yo=(e,t,n)=>(((e,t,n)=>{t in e?bo(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);let xo=class{constructor(e,t,n){yo(this,"type","Text"),yo(this,"color",16777215),yo(this,"layer","0"),yo(this,"position"),yo(this,"rotation",0),yo(this,"text"),yo(this,"textHeight",12),yo(this,"box"),yo(this,"insertNum",-1),this.color=io(e,t),this.type=e.type,this.insertNum=n,this.layer=e.layer,e.rotation&&(this.rotation=e.rotation*Math.PI/180),"ATTDEF"===this.type?this.text=e.tag:this.text=e.text,this.textHeight=e.textHeight,this.position=e.startPoint,this.box=this.getMaxOrMinPosition()}getMaxOrMinPosition(){let e={max:new oo(0,0),min:new oo(0,0)};return e.max.x=this.position.x,e.min.x=this.position.x,e.max.y=this.position.y,e.min.y=this.position.y,e}};var vo=Object.defineProperty,go=(e,t,n)=>(((e,t,n)=>{t in e?vo(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);class wo extends lo{constructor(e,t,n){let i,o;super(),go(this,"type","Arc"),go(this,"color",16777215),go(this,"layer","0"),go(this,"position",[]),go(this,"offsetX"),go(this,"offsetY"),go(this,"box"),this.color=io(e,t),this.type=e.type,this.offsetX=e.offsetX,this.offsetY=e.offsetY,this.layer=e.layer,"CIRCLE"===this.type?(i=e.startAngle||0,o=i+2*Math.PI):(i=e.startAngle,o=e.endAngle);let s=new class{constructor(e=0,t=0,n=1,i=1,o=0,s=2*Math.PI){go(this,"aX"),go(this,"aY"),go(this,"xRadius"),go(this,"yRadius"),go(this,"aStartAngle"),go(this,"aEndAngle"),this.aX=e,this.aY=t,this.xRadius=n,this.yRadius=i,this.aStartAngle=o,this.aEndAngle=s}getPoint(e){const t=2*Math.PI;let n=this.aEndAngle-this.aStartAngle;const i=Math.abs(n)<Number.EPSILON;for(;n<0;)n+=t;for(;n>t;)n-=t;n<Number.EPSILON&&(n=i?0:t);const o=this.aStartAngle+e*n;let s=this.aX+this.xRadius*Math.cos(o),a=this.aY+this.yRadius*Math.sin(o);return new so(s,a)}getPoints(e=5){const t=[];for(let n=0;n<=e;n++)t.push(this.getPoint(n/e));return t}}(0,0,e.radius,e.radius,i,o);this.position=s.getPoints(50),this.position.forEach((t=>{e.center&&(t.x=t.x+e.center.x,t.y=t.y+e.center.y),-1===e.extrusionDirectionZ&&(t.x=-t.x)})),this.box=this.getMaxOrMinPositionArray(),this.positions=this.flatPosition(this.position)}}var ko=Object.defineProperty,Eo=(e,t,n)=>(((e,t,n)=>{t in e?ko(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);const So=(e,t,n,i)=>{let o=new so,s=new so;o.subVectors(n,t),s.subVectors(i,t),o.cross(s);let a=new so(t.x,t.y,t.z),r=new so(n.x,n.y,n.z),l=new so(i.x,i.y,i.z);o.z<0?e.push(l,r,a):e.push(a,r,l)};var Po=Object.defineProperty,Mo=(e,t,n)=>(((e,t,n)=>{t in e?Po(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);var Lo=Object.defineProperty,Do=(e,t,n)=>(((e,t,n)=>{t in e?Lo(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);const To=(e,t)=>typeof t>"u"||0==+t?Math.round(e):(e=+e,t=+t,isNaN(e)||"number"!=typeof t||t%1!=0?NaN:(e=e.toString().split("e"),+((e=(e=Math.round(+(e[0]+"e"+(e[1]?+e[1]-t:-t)))).toString().split("e"))[0]+"e"+(e[1]?+e[1]+t:t)))),Ao=(e,t,n,i,o)=>{const s=n.length,a=n[0].length;if(e<0||e>1)throw new Error("t out of bounds [0,1]: "+e);if(t<1)throw new Error("degree must be at least 1 (linear)");if(t>s-1)throw new Error("degree must be less than or equal to point count - 1");if(!o){o=[];for(let e=0;e<s;e++)o[e]=1}if(i){if(i.length!==s+t+1)throw new Error("bad knot vector length")}else{i=[];for(let e=0;e<s+t+1;e++)i[e]=e}const r=[t,i.length-1-t],l=i[r[0]],c=i[r[1]];let h;for(e=e*(c-l)+l,e=Math.max(e,l),e=Math.min(e,c),h=r[0];h<r[1]&&!(e>=i[h]&&e<=i[h+1]);h++);const u=[];for(let e=0;e<s;e++){u[e]=[];for(let t=0;t<a;t++)u[e][t]=n[e][t]*o[e];u[e][a]=o[e]}let d;for(let n=1;n<=t+1;n++)for(let o=h;o>h-t-1+n;o--){d=(e-i[o])/(i[o+t+1-n]-i[o]);for(let e=0;e<a+1;e++)u[o][e]=(1-d)*u[o-1][e]+d*u[o][e]}const p=[];for(let e=0;e<a;e++)p[e]=To(u[h][e]/u[h][a],-9);return p};var Oo=Object.defineProperty,Co=(e,t,n)=>(((e,t,n)=>{t in e?Oo(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);var No=Object.defineProperty,Io=(e,t,n)=>(((e,t,n)=>{t in e?No(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);const jo=(e,t)=>{if(!io(e,t))return;const{center:n,majorAxisEndPoint:i,axisRatio:o,startAngle:s,endAngle:a}=e;let r=((e,t,n,i,o,s)=>{let a,r=[];a=i<0?{x:t.x*Math.cos(Math.abs(i))-t.y*Math.sin(Math.abs(i)),y:t.x*Math.sin(Math.abs(i))+t.y*Math.cos(Math.abs(i))}:{x:t.x*Math.cos(2*Math.PI-i)-t.y*Math.sin(2*Math.PI-i),y:t.x*Math.sin(2*Math.PI-i)+t.y*Math.cos(2*Math.PI-i)};for(let e=0;e<=50;e++){let t=e/50*Math.abs(o-i);const s=new so;let l=2*Math.PI-t;const{x:c,y:h}=a;s.x=c*Math.cos(l)-h*Math.sin(l),s.y=(c*Math.sin(l)+h*Math.cos(l))*n,s.z=0,r.push(s)}return r})(0,i,o,s,a);return r.forEach((t=>{e.center&&(t.x=t.x+e.center.x,t.y=t.y+e.center.y),e.offsetX&&e.offsetY&&(t.x=100*t.x-e.offsetX,t.y=100*t.y-e.offsetY)})),r};var zo=Object.defineProperty,Vo=(e,t,n)=>(((e,t,n)=>{t in e?zo(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);const Fo={d:"°",c:"⌀",p:"±"},Ro=(e,t)=>{e=e.replace(/%%(.)/g,((e,t)=>Fo[t]||t));const n=t?.encoding;let i,o=n instanceof TextDecoder?n:void 0,s="";const a=[],r=e=>{s&&(a.push(s),s=""),a.push(e)};for(let t=0;t<e.length;t++)switch(i=e[t]){default:s+=i;break;case"\\":switch(i=e[++t]){default:s+=i;break;case"P":s+="\n";break;case"f":case"F":{let n="";for(;i=e[++t];){if(";"===i){r({f:n});break}if("|"===i){const i={f:n},o=e.indexOf(";",++t);for(const n of e.slice(t,o).split("|"))i[n[0]]=+n.slice(1);t=o,r(i);break}n+="\\"===i?e[++t]:i}break}case"S":{let n,o="",s="";for(;i=e[++t];){if(";"===i){n&&r({S:[o,n,s]});break}"\\"===i?n?s+=e[++t]:o+=e[++t]:n?s+=i:"^"===i||"/"===i||"#"===i?n=i:o+=i}break}case"H":case"W":const a=++t,[,l,c]=e.slice(a,t=e.indexOf(";",t)).match(/^(\d*(?:\.\d+)?)(\D*)$/);r({[i]:[+l,c]});break;case"Q":case"A":case"C":case"T":{const n=++t;r({[i]:+e.slice(n,t=e.indexOf(";",t))});break}case"L":case"O":case"K":r({[i]:1});break;case"l":case"o":case"k":r({[i.toUpperCase()]:0});break;case"U":case"u":"+"===e[t+1]?(s+=String.fromCodePoint(parseInt(e.substr(t+2,4),16)),t+=5):s+=i;break;case"M":case"m":n?"+"===e[t+1]&&"1"===e[t+2]?(s+=(o=o||new TextDecoder(n)).decode(new Uint8Array([parseInt(e.substr(t+3,2),16),parseInt(e.substr(t+5,2),16)])),t+=6):s+=i:s+="\\"+i}break;case"{":{let n=1;const o=t;for(;i=e[++t];)if("{"===i)n++;else if("}"===i){if(0==--n){r(Ro(e.slice(o+1,t)));break}}else"\\"===i&&t++;break}}return s&&a.push(s),a};var Bo=Object.defineProperty,_o=(e,t,n)=>(((e,t,n)=>{t in e?Bo(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);const Ho=(e,t,n,i)=>{let o={horizontalAlignment:"left",textHeight:t},s=[];for(let n of e)if("string"==typeof n)n.startsWith("pxq")&&n.endsWith(";")?-1!==n.indexOf("c")?o.horizontalAlignment="center":-1!==n.indexOf("l")?o.horizontalAlignment="left":-1!==n.indexOf("r")?o.horizontalAlignment="right":-1!==n.indexOf("j")&&(o.horizontalAlignment="justify"):s.push(n);else if(Array.isArray(n)){let e=Ho(n,t);s.push(e.text)}else"object"==typeof n&&n.S&&3===n.S.length&&s.push(n.S[0]+"/"+n.S[2]);return{text:s.join(""),style:o}};class Yo{constructor(t){_o(this,"type","MText"),_o(this,"color",16777215),_o(this,"layer","0"),_o(this,"position"),_o(this,"rotation",0),_o(this,"directionVector"),_o(this,"extrusionDirection"),_o(this,"attachmentPoint"),_o(this,"text"),_o(this,"style"),_o(this,"width"),_o(this,"height"),_o(this,"textHeight",12),_o(this,"isIncludeReBarMark",!1),_o(this,"rebarArr",["%%130","%%131","%%132","%%133"]),_o(this,"rebarMark",{"%%130":"A","%%131":"B","%%132":"C","%%133":"D"}),_o(this,"rebarReg",/(.*)(%%130|%%131|%%132|%%133)(.*)/g),_o(this,"createTextForScene",((t,n,i,o,s,a)=>{if(!t)return null;this.isIncludeReBarMark&&(t=this.clearRebarText(t));let r=new T;if(r.text=t.replaceAll("\\P","\n").replaceAll("\\X","\n"),r.font=a&&"reBarMark"===a?`${$t}`:`${Jt}`,r.fontSize=n.textHeight,this.textHeight=n.textHeight,r.maxWidth=this.width,r.position.x=s.x,r.position.y=s.y,r.position.z=s.z,r.textAlign=n.horizontalAlignment,r.color=i,this.rotation&&"MTEXT"===o?r.rotation.z=this.rotation*Math.PI/180:this.rotation&&(r.rotation.z=this.rotation),this.directionVector){let t=this.directionVector,n=new e.Vector3(1,0,0).angleTo(new e.Vector3(t.x,t.y,t.z));const{x:i,y:o}=this.directionVector;i>0&&o<0||i<0&&o<0?r.rotateZ(2*Math.PI-n):r.rotateZ(n)}switch(-1===this.extrusionDirection?.z&&r.scale.set(1,-1,1),this.attachmentPoint){case 1:r.anchorX="left",r.anchorY="top";break;case 2:r.anchorX="center",r.anchorY="top";break;case 3:r.anchorX="right",r.anchorY="top";break;case 4:r.anchorX="left",r.anchorY="middle";break;case 5:r.anchorX="center",r.anchorY="middle";break;case 6:r.anchorX="right",r.anchorY="middle";break;case 7:r.anchorX="left",r.anchorY="bottom";break;case 8:r.anchorX="center",r.anchorY="bottom";break;case 9:r.anchorX="right",r.anchorY="bottom";break;default:return}return r.sync((()=>{if("left"!==r.textAlign){r.geometry.computeBoundingBox();let e=r.geometry.boundingBox.max.x-r.geometry.boundingBox.min.x;"center"===r.textAlign&&(r.position.x+=(this.width-e)/2),"right"===r.textAlign&&(r.position.x+=this.width-e)}})),r})),this.type=t.type,this.color=t.color,this.layer=t.layer,this.position=t.position,this.rotation=t.rotation,this.text=t.text,this.directionVector=t.directionVector,this.extrusionDirection=t.extrusionDirection,this.attachmentPoint=t.attachmentPoint,this.style=t.style,this.width=t.width,this.height=t.height?t.height:t.textHeight,this.text.includes("25")&&this.text.includes("6")&&this.text.includes("")&&(this.text=this.text.replace("","%%132"));const n=this.rebarArr.findIndex((e=>this.text.includes(e)));this.isIncludeReBarMark=-1!==n}clearRebarText(e){return this.rebarReg.test(e)?(e=e.replace(this.rebarReg,"$1   $3"),this.clearRebarText(e)):e}setRebarText(t,n){const i=t.text.replace(this.rebarReg,"$1");let o=i.match(/\d/g),s=o?o.length:0;const a=t.text.replace(this.rebarReg,"$1   $3");let r=new e.Vector3;this.rotation?(r.x=this.position.x+this.height*(i.length-.85*s)*1*Math.cos(this.rotation),r.y=this.position.y+this.height*(i.length-.85*s)*1*Math.sin(this.rotation)):(i.length-s>3?r.x=this.position.x+this.height*(i.length-.85*s)*1:r.x=this.position.x+this.height*(i.length-.1*s)*1,r.y=this.position.y);let l=t.text.replace(this.rebarReg,"$2");l=l.replace(/(%%130|%%131|%%132|%%133)/g,(e=>this.rebarMark[e]));let c=this.createTextForScene(l,t.style,this.color,n,r,"reBarMark");if(this.rebarReg.test(a)){t={text:a,style:{horizontalAlignment:"left",textHeight:this.height}};return[c,...this.setRebarText(t,n)]}return[c]}draw(t){let n,i;if("TEXT"===t||"ATTDEF"===t)this.attachmentPoint=7,i={text:this.text,style:{horizontalAlignment:"left",textHeight:this.height}},n=this.createTextForScene(i.text,i.style,this.color,t,this.position);else{let e=Ro(this.text);i=Ho(e,this.height,this.color),n=this.createTextForScene(i.text,i.style,this.color,t,this.position)}let o=new e.Object3D;return o.layer=this.layer,o.add(n),this.isIncludeReBarMark&&this.setRebarText(i,t).forEach((e=>o.add(e))),((e,t,n,i)=>{Fn.push({text:e,position:t,textHeight:n,boundingBox:i})})(n.text,this.position,this.textHeight,n.geometry.boundingBox),o}}const Xo={LINE:mo,LWPOLYLINE:mo,POLYLINE:mo,MLINE:mo,CIRCLE:wo,ARC:wo,SOLID:class extends lo{constructor(e,t,n){super(),Eo(this,"type","Solid"),Eo(this,"color",16777215),Eo(this,"layer","0"),Eo(this,"position",[]),Eo(this,"box"),Eo(this,"offsetX"),Eo(this,"offsetY"),this.color=io(e,t),this.type=e.type,this.offsetX=e.offsetX,this.offsetY=e.offsetY,this.layer=e.layer;let i=e.points;0!==i?.length&&(So(this.position,i[0],i[1],i[2]),So(this.position,i[1],i[2],i[3])),this.positions=this.flatPosition(this.position),this.box=this.getMaxOrMinPositionArray()}},POINT:class{constructor(e,t,n){Mo(this,"type","Point"),Mo(this,"color",16777215),Mo(this,"layer","0"),Mo(this,"position"),Mo(this,"offsetX"),Mo(this,"offsetY"),this.color=io(e,t),this.type=e.type,this.offsetX=e.offsetX,this.offsetY=e.offsetY,this.position=e.position,this.layer=e.layer}},SPLINE:class extends lo{constructor(e,t,n){super(),Do(this,"type","Spline"),Do(this,"color",16777215),Do(this,"layer","0"),Do(this,"position",[]),Do(this,"box"),Do(this,"offsetX"),Do(this,"offsetY"),this.color=io(e,t),this.type=e.type,this.offsetX=e.offsetX,this.offsetY=e.offsetY,this.layer=e.layer,this.position=((e,t,n,i)=>{const o=[],s=e.map((function(e){return[e.x,e.y]})),a=[n[t]],r=[n[t],n[n.length-1-t]];for(let e=t+1;e<n.length-t;++e)a[a.length-1]!==n[e]&&a.push(n[e]);i=i||25;for(let e=1;e<a.length;++e){const l=a[e-1],c=a[e];for(let e=0;e<=i;++e){let a=(e/i*(c-l)+l-r[0])/(r[1]-r[0]);a=Math.max(a,0),a=Math.min(a,1);const h=Ao(a,t,s,n);o.push(new so(h[0],h[1]))}}return o})(e.controlPoints,e.degreeOfSplineCurve,e.knotValues,100),this.box=this.getMaxOrMinPositionArray(),this.positions=this.flatPosition(this.position)}},ELLIPSE:class extends lo{constructor(e,t,n){if(super(),Io(this,"type","Ellipse"),Io(this,"color",16777215),Io(this,"layer","0"),Io(this,"position",[]),Io(this,"box"),Io(this,"offsetX"),Io(this,"offsetY"),this.color=io(e,t),this.type=e.type,this.offsetX=e.offsetX,this.offsetY=e.offsetY,this.layer=e.layer,e.extrusionDirection&&1===e.extrusionDirection.z){let t,n,i;e.majorAxisEndPoint&&e.axisRatio&&(t=Math.sqrt(Math.pow(e.majorAxisEndPoint.x,2)+Math.pow(e.majorAxisEndPoint.y,2)),n=t*e.axisRatio,i=Math.atan2(e.majorAxisEndPoint.y,e.majorAxisEndPoint.x));let o=new class{constructor(e=0,t=0,n=1,i=1,o=0,s=2*Math.PI,a=!1,r=0){Io(this,"aX"),Io(this,"aY"),Io(this,"xRadius"),Io(this,"yRadius"),Io(this,"aStartAngle"),Io(this,"aEndAngle"),Io(this,"aClockwise"),Io(this,"aRotation"),this.aX=e,this.aY=t,this.xRadius=n,this.yRadius=i,this.aStartAngle=o,this.aEndAngle=s,this.aClockwise=a,this.aRotation=r}getPoint(e){const t=2*Math.PI;let n=this.aEndAngle-this.aStartAngle;const i=Math.abs(n)<Number.EPSILON;for(;n<0;)n+=t;for(;n>t;)n-=t;n<Number.EPSILON&&(n=i?0:t),!0===this.aClockwise&&!i&&(n===t?n=-t:n-=t);const o=this.aStartAngle+e*n;let s=this.aX+this.xRadius*Math.cos(o),a=this.aY+this.yRadius*Math.sin(o);if(0!==this.aRotation){const e=Math.cos(this.aRotation),t=Math.sin(this.aRotation),n=s-this.aX,i=a-this.aY;s=n*e-i*t+this.aX,a=n*t+i*e+this.aY}return new so(s,a)}getPoints(e=5){const t=[];for(let n=0;n<=e;n++)t.push(this.getPoint(n/e));return t}}(0,0,t,n,e.startAngle,e.endAngle,!1,i);this.position=o.getPoints(50),this.position.forEach((t=>{e.center&&(t.x=t.x+e.center.x,t.y=t.y+e.center.y)}))}else this.position=jo(e,t);this.box=this.getMaxOrMinPositionArray(),this.positions=this.flatPosition(this.position)}},MTEXT:class{constructor(e,t,n){Co(this,"type","MText"),Co(this,"color",16777215),Co(this,"layer","0"),Co(this,"width"),Co(this,"position"),Co(this,"rotation"),Co(this,"directionVector"),Co(this,"extrusionDirection"),Co(this,"attachmentPoint"),Co(this,"text"),Co(this,"style"),Co(this,"box"),Co(this,"insertNum",-1),Co(this,"height"),this.color=io(e,t),this.type=e.type,this.width=e.width,this.position=e.position,this.directionVector=e.directionVector,this.extrusionDirection=e.extrusionDirection,this.position=e.position,this.rotation=e.rotation,this.attachmentPoint=e.attachmentPoint,this.insertNum=n,this.layer=e.layer,this.text=e.text,this.height=e.height,this.box=this.getMaxOrMinPosition()}getMaxOrMinPosition(){let e={max:new oo(0,0),min:new oo(0,0)};return e.max.x=this.position.x,e.min.x=this.position.x,e.max.y=this.position.y,e.min.y=this.position.y,e}},TEXT:xo,ATTDEF:xo},Uo={POINT:class{constructor(e){Vo(this,"type","Point"),Vo(this,"color",16777215),Vo(this,"layer","0"),Vo(this,"position"),this.type=e.type,this.color=e.color,this.layer=e.layer,this.position=e.position}draw(){let t=new E;const{x:n,y:i,z:s}=this.position,{offsetX:a,offsetY:r}=(e=>{let t=0,n=0;const i=e[0]+"",o=e[1]+"";if(i.split(".").length>1){const e=i.split(".")[0];0!==i.split(".")[1].length&&(t=100*Number(e))}if(o.split(".").length>1){const e=o.split(".")[0];0!==o.split(".")[1].length&&(n=100*Number(e))}return{offsetX:t,offsetY:n}})([n,i,s]);if(a&&r){const o=((e,t,n)=>e.map(((e,i)=>i%3==0?100*e-t:i%3==1?100*e-n:e)))([n,i,s],a,r);t.setAttribute("position",new e.Float32BufferAttribute(o,3))}else t.setAttribute("position",new o([n,i,s],3));let l=new e.PointsMaterial({size:.1,color:this.color}),c=new e.Points(t,l);if(a&&r){let e=a?a/100:0,t=r?r/100:0;c.position.set(e,t,0);const n=.01;c.scale.set(n,n,n)}return c.layer=this.layer,c}},MTEXT:Yo,TEXT:Yo,ATTDEF:Yo};let Wo,Go=["LINE","LWPOLYLINE","POLYLINE","ELLIPSE","ARC","CIRCLE","SPLINE","MLINE","SOLID"];const qo=e=>{Wo=e,console.log("原始dxf数据",e);let t=[],n=[],i=null;for(let o=0;o<e.entities?.length;o++){const{type:s,dimensionType:a}=e.entities[o],r=e.entities[o];if(!1===r.visible||r.inPaperSpace)continue;const{visible:l,frozen:c}=Wo.tables.layer.layers[r.layer];if(!1===l||!0===c)continue;let h=null;if("DIMENSION"===s||"INSERT"===s){if("DIMENSION"===s&&7&a)continue;const e=$o(r,o);e.models&&0!==e.models.length&&t.push(...e.models),n.push(...e.groupArr)}else if(Go.includes(s)){const e=new Xo[s](r,Wo,o);e.pixelIndex=o,h=e.box,t.push(e)}else if(Xo[s]){const e=new Xo[s](r,Wo,o);let t=new Uo[s](e).draw(s);n.push(t)}else console.log("解析到shape过程未处理的类型",s);h&&!i?i=h:h&&i&&(i.min.x>h.min.x&&(i.min.x=h.min.x),i.min.y>h.min.y&&(i.min.y=h.min.y),i.max.x<h.max.x&&(i.max.x=h.max.x),i.max.y<h.max.y&&(i.max.y=h.max.y))}return null===i&&(i={max:new oo(t[0].positions[0],t[0].positions[1]),min:new oo(t[0].positions[0]-10,t[0].positions[1]-10)}),e=null,{models:t,box:i,group:n}},$o=(e,t)=>{let n,i;n="0"===e.layer&&e.layerColor?e.layerColor:Wo.tables.layer.layers[e.layer].color,i=void 0!==e.color||void 0!==e.colorIndex||e.blockColor?e.color?e.color:e.blockColor:n;let o={scale:{x:null,y:null,z:null},rotation:null,position:null};e.xScale&&(o.scale.x=e.xScale),e.yScale&&(o.scale.y=e.yScale),e.zScale&&(o.scale.z=e.zScale),e.rotation&&(o.rotation=e.rotation),e.position&&(o.position=e.position);let s,a=[],r=[];s="INSERT"===e.type?Wo.blocks[e.name]:Wo.blocks[e.block];for(let l=0;l<s.entities?.length;l++){const c=s.entities[l],{type:h,dimensionType:u,colorIndex:d,color:p}=c;if(!1===c.visible)continue;const{visible:f,frozen:m}=Wo.tables.layer.layers[c.layer];if(!1!==f&&!0!==m)if((!p||"MTEXT"===h)&&(0===d&&i?(c.blockColor=i,c.extendColor="byBlock"):0!==d||i?(c.layerColor=n,c.extendColor="byLayer"):(c.blockColor=16777215,c.extendColor="byBlock")),"0"===c.layer&&(e.layer.includes(" @ ")?c.layer=e.layer.split(" @ ")[0]:c.layer=e.layer),"DIMENSION"===h||"INSERT"===h){if("DIMENSION"===h&&7&u)continue;const e=$o(c,t);e.models.forEach((e=>{e.positions=Ko(e.positions,o),a.push(e)})),Zo(e.groupArr,o),r.push(...e.groupArr)}else if(Go.includes(h)){const e=new Xo[h](c,Wo,t);e.pixelIndex=t,e.positions=Ko(e.positions,o),a.push(e)}else if(Xo[h]){const e=new Xo[h](c,Wo,l);let t=new Uo[h](e).draw(h);Zo([t],o),r.push(t)}else console.log("解析到shape过程未处理的类型",h)}return{models:a,groupArr:r}},Jo=(e,t)=>{const{scale:n,rotation:i,position:o}=t;if(n){let t=1,i=1;n.x&&(t=n.x),n.y&&(i=n.y),n.z&&-1===n.z&&(t=-t);const o=((e,t,n)=>{let i=new Float32Array(16);return i[0]=e,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=t,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=n,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i})(t,i,0);e=eo(e,o)}if(i)if(n.z&&-1===n.z){const t=Qi(-i*Math.PI/180);e=eo(e,t)}else{const t=Qi(i*Math.PI/180);e=eo(e,t)}if(o){const t=((e,t,n)=>{let i=new Float32Array(16);for(let e=0;e<12;e++)i[e]=e%5==0?1:0;return i[12]=e||0,i[13]=t||0,i[14]=n||0,i[15]=1,i})(o.x,o.y,0);e=eo(e,t)}return e},Ko=(e,t)=>"object"==typeof e[0]?(e.forEach((e=>{e.positions=Jo(e.positions,t)})),e):Jo(e,t),Zo=(e,t)=>{e.forEach((e=>{const{scale:n,rotation:i,position:o}=t;n&&(n.x&&(e.scale.x=n.x),n.y&&(e.scale.y=n.y),n.z&&-1===n.z&&(e.scale.x=-e.scale.x)),i&&(n.z&&-1===n.z?e.rotation.z=-i*Math.PI/180:e.rotation.z=i*Math.PI/180),o&&(e.position.x=o.x,e.position.y=o.y,e.position.z=0)}))};var Qo=Object.defineProperty,es=(e,t,n)=>(((e,t,n)=>{t in e?Qo(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);class ts{constructor(t,n){es(this,"cadUrl"),es(this,"container"),es(this,"renderer",new e.WebGLRenderer({antialias:!0})),es(this,"scene",new e.Scene),es(this,"camera",null),es(this,"controls",null),es(this,"addMoveEvent",(()=>{})),es(this,"deleteMoveEvent",(()=>{})),es(this,"modelGroupByLayer",{}),es(this,"textData",[]),es(this,"finishCallBack",(()=>{})),es(this,"progressCallBack",(()=>{})),es(this,"progress",0),es(this,"isLoadingLocal"),es(this,"isLoadingFinish"),n.includes(".dxf")?this.isLoadingLocal=!0:this.isLoadingLocal=!1,this.isLoadingFinish=!1,this.container=t,this.cadUrl=n+"",this.initViewer()}initViewer(){return new Promise((async(e,t)=>{this.changeProgress(10),this.isLoadingLocal?await this.loadLocalFile():await this.loadOurBimCADFile(),this.changeProgress(100),this.renderer=Oe,this.scene=Ce,this.camera=Me,this.controls=Le,this.addMoveEvent=ft,this.deleteMoveEvent=mt,this.modelGroupByLayer=je,this.textData=Fn,this.isLoadingFinish=!0,this.finishCallBack(),e(!0)}))}loadOurBimCADFile(){return new Promise(((e,t)=>{fetch(`${Wt}dxfParse?fileName=${this.cadUrl}`,{method:"GET"}).then((e=>e.json())).then((t=>{if(200===t.code){this.changeProgress(55);const n=Number(t.fileName);let i=[];for(let e=0;e<n;e++)i.push(this.getJsonFile(this.cadUrl,e));Promise.all(i).then((async t=>{let n,i="";t.forEach(((e,t)=>{"string"==typeof e?i+=e:i=e})),this.changeProgress(70),n="string"==typeof i?JSON.parse(i):i;const o=qo(n);this.changeProgress(90),await this.draw(o),e(!0)}))}}))}))}getJsonFile(e,t){return new Promise(((n,i)=>{fetch(`${Gt}${e}/${t}.json`).then((e=>e.text())).then((e=>{n(e)}))}))}loadLocalFile(){return new Promise(((t,n)=>{(new e.FileLoader).load(this.cadUrl,(async e=>{this.changeProgress(40);const n=(new Ki).parseSync(e);this.changeProgress(70);const i=qo(n);this.changeProgress(90),await this.draw(i),t(!0)}),(function(e){}),(function(e){console.error("文件加载异常，请检测文件是否存在")}))}))}draw(e){return new Promise(((t,n)=>{qe(e,this.container),t(!0)}))}changeProgress(e){this.progress=e,this.progressCallBack()}registFinishCallBack(e){e&&"function"==typeof e?this.finishCallBack=e:console.warn("加载完成回调函数注册异常，请检查参数是否为响应函数")}registProgressCallBack(e){e&&"function"==typeof e?this.progressCallBack=e:console.warn("进度回调函数注册异常，请检查参数是否为响应函数")}update(){this.renderer=Oe,this.scene=Ce,this.camera=Me,this.controls=Le}}export{jn as Controller,ts as Viewer};
