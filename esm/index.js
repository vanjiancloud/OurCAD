import*as e from"three";import{Box3 as t,Vector3 as n,InstancedBufferGeometry as i,Float32BufferAttribute as a,InstancedInterleavedBuffer as o,InterleavedBufferAttribute as s,WireframeGeometry as r,Sphere as l,UniformsLib as c,Vector2 as u,ShaderLib as h,UniformsUtils as d,ShaderMaterial as p,Vector4 as f,Matrix4 as b,Line3 as m,Mesh as y,MathUtils as x,Loader as v,FileLoader as g,ShapePath as w,ExtrudeGeometry as k,BufferGeometry as E}from"three";import{ElMessageBox as S,ElInput as P,ElMessage as M}from"element-plus";import{ref as L,h as O}from"vue";import{Text as A}from"troika-three-text";const T=(t,n,i)=>{let a=new e.Vector2;a.x=t/window.innerWidth*2-1,a.y=-n/window.innerHeight*2+1;let o=new e.Vector3(a.x,a.y,0);return o.unproject(i),o};let D=0;const C=(e,t)=>{(new Date).getTime()-D>t&&(e(),D=(new Date).getTime())};let N,z,j,I,F=0,V=0,B=0,R=0,_=!1;const H=e=>{_=!0,F=e.clientX,V=e.clientY,N||(N=document.createElement("div"),N.id="selectBox",document.body.appendChild(N)),N.style.cssText="\n        position: absolute;\n        width: 0;\n        height: 0;\n        margin: 0;\n        padding: 0;\n        border: 1px dashed #eee;\n        z-index: 1000;\n        opacity: 0.6;\n        display: none;\n    ",N.style.left=F+"px",N.style.top=V+"px"},Y=e=>{_&&(B=e.clientX,R=e.clientY,N.style.display="block",N.style.left=Math.min(B,F)+"px",N.style.top=Math.min(R,V)+"px",N.style.width=Math.abs(B-F)+"px",N.style.height=Math.abs(R-V)+"px")},X=e=>{B=e.clientX,R=e.clientY;const t=B-F,n=R-V;if(Math.abs(t)<2||Math.abs(n)<2)return void U();const i=((e,t)=>{const n=window.innerWidth/Math.abs(e),i=window.innerHeight/Math.abs(t);return Math.min(n,i)})(t,n),a={x:F+t/2,y:V+n/2};I(a.x,a.y,i),U(),W()},U=()=>{_=!1,F=0,V=0,N.style.display="none"},G=()=>{j(),document.addEventListener("mousedown",H,!1),document.addEventListener("mousemove",Y,!1),document.addEventListener("mouseup",X,!1)},W=()=>{document.removeEventListener("mousedown",H,!1),document.removeEventListener("mousemove",Y,!1),document.removeEventListener("mouseup",X,!1),z()};let q=0;let $=0;let J,K,Z;function Q(t,n){this.object=t,this.domElement=void 0!==n?n:document,J=n,this.enabled=!0,this.target=new e.Vector3,this.center=this.target,this.noZoom=!1,this.zoomSpeed=1,this.minDistance=0,this.maxDistance=1/0,this.noRotate=!1,this.rotateSpeed=1,this.noPan=!1,this.keyPanSpeed=7,this.autoRotate=!1,this.autoRotateSpeed=2,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.noKeys=!1,this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40};var i=this,a=new e.Vector2,o=new e.Vector2,s=new e.Vector2,r=new e.Vector2,l=new e.Vector2,c=new e.Vector2,u=new e.Vector3,h=new e.Vector3,d=new e.Vector2,p=new e.Vector2,f=new e.Vector2,b=1,m=new e.Vector3;new e.Vector3;var y={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_DOLLY:4,TOUCH_PAN:5},x=y.NONE;this.target0=this.target.clone(),this.position0=this.object.position.clone();var v={type:"change"},g={type:"start"},w={type:"end"};function k(){return 2*Math.PI/60/60*i.autoRotateSpeed}function E(){return Math.pow(.95,i.zoomSpeed)}function S(e){((e,t)=>{(new Date).getTime()-$>t&&(e(),$=(new Date).getTime())})((()=>{P(e)}),20)}function P(t){if(!1!==i.enabled&&(t.preventDefault(),x===y.PAN)){if(!0===i.noPan)return;let n=new e.Vector2;n.x=t.clientX/window.innerWidth*2-1,n.y=-t.clientY/window.innerHeight*2+1;let a=new e.Vector3(n.x,n.y,0);a.unproject(i.object),l.set(a.x,a.y),c.subVectors(l,r),i.object.position.sub(new e.Vector3(c.x,c.y,0)),i.dispatchEvent(v)}}function M(){!1!==i.enabled&&(i.domElement.removeEventListener("mousemove",P,!1),i.domElement.removeEventListener("mouseup",M,!1),i.dispatchEvent(w),x=y.NONE)}this.rotateLeft=function(e){void 0===e&&(e=k())},this.rotateUp=function(e){void 0===e&&(e=k())},this.panLeft=function(e){var t=this.object.matrix.elements;u.set(t[0],t[1],t[2]),u.multiplyScalar(-e),m.add(u)},this.panUp=function(e){var t=this.object.matrix.elements;u.set(t[4],t[5],t[6]),u.multiplyScalar(e),m.add(u)},this.pan=function(e,t){var n=i.domElement===document?i.domElement.body:i.domElement;void 0!==i.object.top&&(console.log("正交相机",e,i.object.right-i.object.left,n.clientWidth),i.panLeft(e*(i.object.right-i.object.left)/n.clientWidth),i.panUp(t*(i.object.top-i.object.bottom)/n.clientHeight))},this.dollyIn=function(e){void 0===e&&(e=E()),b/=e},this.dollyOut=function(e){void 0===e&&(e=E()),b*=e},this.update=function(){void 0!==i.object.top&&(this.object.top=b*this.object.top,this.object.bottom=b*this.object.bottom,this.object.left=b*this.object.left,this.object.right=b*this.object.right,this.object.updateProjectionMatrix());var e=this.object.position;h.copy(e).sub(this.target),this.target.add(m),e.copy(this.target).add(h),this.object.lookAt(this.target),this.dispatchEvent(v),b=1,m.set(0,0,0)},this.reset=function(){x=y.NONE,this.target.copy(this.target0),this.object.position.copy(this.position0),this.update()},K=t=>{if(!1!==i.enabled){if(t.preventDefault(),0!==t.button&&2!==t.button)return;{x=y.PAN;let n=new e.Vector2;n.x=t.clientX/window.innerWidth*2-1,n.y=-t.clientY/window.innerHeight*2+1;let a=new e.Vector3(n.x,n.y,0);a.unproject(i.object),r.set(a.x,a.y)}i.domElement.addEventListener("mousemove",S,!1),i.domElement.addEventListener("mouseup",M,!1),i.dispatchEvent(g)}},Z=t=>{if(!1===i.enabled||!0===i.noZoom)return;t.preventDefault();let n=new e.Vector2,a=0;n.x=t.clientX/window.innerWidth*2-1,n.y=-t.clientY/window.innerHeight*2+1,a=t.deltaY>0?10:-10;const o=1+.01*a,s=new e.Vector3(n.x,n.y,.5).unproject(i.object);i.object.zoom/=o,i.object.updateProjectionMatrix();const r=new e.Vector3(n.x,n.y,.5).unproject(i.object);i.object.position.add(s.clone().sub(r)),i.dispatchEvent(v)},this.domElement.addEventListener("contextmenu",(function(e){e.preventDefault()}),!1),ee(),this.domElement.addEventListener("touchstart",(function(e){if(!1!==i.enabled){switch(e.touches.length){case 1:if(!0===i.noRotate)return;x=y.TOUCH_ROTATE,a.set(e.touches[0].pageX,e.touches[0].pageY);break;case 2:if(!0===i.noZoom)return;x=y.TOUCH_DOLLY;var t=e.touches[0].pageX-e.touches[1].pageX,n=e.touches[0].pageY-e.touches[1].pageY,o=Math.sqrt(t*t+n*n);d.set(0,o);break;case 3:if(!0===i.noPan)return;x=y.TOUCH_PAN,r.set(e.touches[0].pageX,e.touches[0].pageY);break;default:x=y.NONE}i.dispatchEvent(g)}}),!1),this.domElement.addEventListener("touchend",(function(){!1!==i.enabled&&(i.dispatchEvent(w),x=y.NONE)}),!1),this.domElement.addEventListener("touchmove",(function(e){if(!1!==i.enabled){e.preventDefault(),e.stopPropagation();var t=i.domElement===document?i.domElement.body:i.domElement;switch(e.touches.length){case 1:if(!0===i.noRotate||x!==y.TOUCH_ROTATE)return;o.set(e.touches[0].pageX,e.touches[0].pageY),s.subVectors(o,a),i.rotateLeft(2*Math.PI*s.x/t.clientWidth*i.rotateSpeed),i.rotateUp(2*Math.PI*s.y/t.clientHeight*i.rotateSpeed),a.copy(o),i.update();break;case 2:if(!0===i.noZoom||x!==y.TOUCH_DOLLY)return;var n=e.touches[0].pageX-e.touches[1].pageX,u=e.touches[0].pageY-e.touches[1].pageY,h=Math.sqrt(n*n+u*u);p.set(0,h),f.subVectors(p,d),f.y>0?i.dollyOut():i.dollyIn(),d.copy(p),i.update();break;case 3:if(!0===i.noPan||x!==y.TOUCH_PAN)return;l.set(e.touches[0].pageX,e.touches[0].pageY),c.subVectors(l,r),i.pan(c.x,c.y),r.copy(l),i.update();break;default:x=y.NONE}}}),!1),window.addEventListener("keydown",(function(e){if(!1!==i.enabled&&!0!==i.noKeys&&!0!==i.noPan)switch(e.keyCode){case i.keys.UP:i.pan(0,i.keyPanSpeed),i.update();break;case i.keys.BOTTOM:i.pan(0,-i.keyPanSpeed),i.update();break;case i.keys.LEFT:i.pan(i.keyPanSpeed,0),i.update();break;case i.keys.RIGHT:i.pan(-i.keyPanSpeed,0),i.update()}}),!1)}const ee=()=>{J.addEventListener("mousedown",K,!1),J.addEventListener("mousewheel",Z,!1),J.addEventListener("DOMMouseScroll",Z,!1)};Q.prototype=Object.create(e.EventDispatcher.prototype);const te=e=>{let t=0,n=0;const i=e[0]+"",a=e[1]+"";if(i.split(".").length>1){const e=i.split(".")[0];0!==i.split(".")[1].length&&(t=100*Number(e))}if(a.split(".").length>1){const e=a.split(".")[0];0!==a.split(".")[1].length&&(n=100*Number(e))}return{offsetX:t,offsetY:n}},ne=(e,t,n)=>e.map(((e,i)=>i%3==0?100*e-t:i%3==1?100*e-n:e)),ie=(t,n,i)=>{let a=new e.Vector2;a.x=t/window.innerWidth*2-1,a.y=-n/window.innerHeight*2+1;let o=new e.Vector3(a.x,a.y,0);return o.unproject(i),o},ae=new t,oe=new n;class se extends i{constructor(){super(),this.isLineSegmentsGeometry=!0,this.type="LineSegmentsGeometry";this.setIndex([0,2,1,2,3,1,2,4,3,4,5,3,4,6,5,6,7,5]),this.setAttribute("position",new a([-1,2,0,1,2,0,-1,1,0,1,1,0,-1,0,0,1,0,0,-1,-1,0,1,-1,0],3)),this.setAttribute("uv",new a([-1,2,1,2,-1,1,1,1,-1,-1,1,-1,-1,-2,1,-2],2))}applyMatrix4(e){const t=this.attributes.instanceStart,n=this.attributes.instanceEnd;return void 0!==t&&(t.applyMatrix4(e),n.applyMatrix4(e),t.needsUpdate=!0),null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this}setPositions(e){let t;e instanceof Float32Array?t=e:Array.isArray(e)&&(t=new Float32Array(e));const n=new o(t,6,1);return this.setAttribute("instanceStart",new s(n,3,0)),this.setAttribute("instanceEnd",new s(n,3,3)),this.computeBoundingBox(),this.computeBoundingSphere(),this}setColors(e){let t;e instanceof Float32Array?t=e:Array.isArray(e)&&(t=new Float32Array(e));const n=new o(t,6,1);return this.setAttribute("instanceColorStart",new s(n,3,0)),this.setAttribute("instanceColorEnd",new s(n,3,3)),this}fromWireframeGeometry(e){return this.setPositions(e.attributes.position.array),this}fromEdgesGeometry(e){return this.setPositions(e.attributes.position.array),this}fromMesh(e){return this.fromWireframeGeometry(new r(e.geometry)),this}fromLineSegments(e){const t=e.geometry;return this.setPositions(t.attributes.position.array),this}computeBoundingBox(){null===this.boundingBox&&(this.boundingBox=new t);const e=this.attributes.instanceStart,n=this.attributes.instanceEnd;void 0!==e&&void 0!==n&&(this.boundingBox.setFromBufferAttribute(e),ae.setFromBufferAttribute(n),this.boundingBox.union(ae))}computeBoundingSphere(){null===this.boundingSphere&&(this.boundingSphere=new l),null===this.boundingBox&&this.computeBoundingBox();const e=this.attributes.instanceStart,t=this.attributes.instanceEnd;if(void 0!==e&&void 0!==t){const n=this.boundingSphere.center;this.boundingBox.getCenter(n);let i=0;for(let a=0,o=e.count;a<o;a++)oe.fromBufferAttribute(e,a),i=Math.max(i,n.distanceToSquared(oe)),oe.fromBufferAttribute(t,a),i=Math.max(i,n.distanceToSquared(oe));this.boundingSphere.radius=Math.sqrt(i),isNaN(this.boundingSphere.radius)&&console.error("THREE.LineSegmentsGeometry.computeBoundingSphere(): Computed radius is NaN. The instanced position data is likely to have NaN values.",this)}}toJSON(){}applyMatrix(e){return console.warn("THREE.LineSegmentsGeometry: applyMatrix() has been renamed to applyMatrix4()."),this.applyMatrix4(e)}}c.line={worldUnits:{value:1},linewidth:{value:1},resolution:{value:new u(1,1)},dashOffset:{value:0},dashScale:{value:1},dashSize:{value:1},gapSize:{value:1}},h.line={uniforms:d.merge([c.common,c.fog,c.line]),vertexShader:"\n\t\t#include <common>\n\t\t#include <color_pars_vertex>\n\t\t#include <fog_pars_vertex>\n\t\t#include <logdepthbuf_pars_vertex>\n\t\t#include <clipping_planes_pars_vertex>\n\n\t\tuniform float linewidth;\n\t\tuniform vec2 resolution;\n\n\t\tattribute vec3 instanceStart;\n\t\tattribute vec3 instanceEnd;\n\n\t\tattribute vec3 instanceColorStart;\n\t\tattribute vec3 instanceColorEnd;\n\n\t\t#ifdef WORLD_UNITS\n\n\t\t\tvarying vec4 worldPos;\n\t\t\tvarying vec3 worldStart;\n\t\t\tvarying vec3 worldEnd;\n\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tvarying vec2 vUv;\n\n\t\t\t#endif\n\n\t\t#else\n\n\t\t\tvarying vec2 vUv;\n\n\t\t#endif\n\n\t\t#ifdef USE_DASH\n\n\t\t\tuniform float dashScale;\n\t\t\tattribute float instanceDistanceStart;\n\t\t\tattribute float instanceDistanceEnd;\n\t\t\tvarying float vLineDistance;\n\n\t\t#endif\n\n\t\tvoid trimSegment( const in vec4 start, inout vec4 end ) {\n\n\t\t\t// trim end segment so it terminates between the camera plane and the near plane\n\n\t\t\t// conservative estimate of the near plane\n\t\t\tfloat a = projectionMatrix[ 2 ][ 2 ]; // 3nd entry in 3th column\n\t\t\tfloat b = projectionMatrix[ 3 ][ 2 ]; // 3nd entry in 4th column\n\t\t\tfloat nearEstimate = - 0.5 * b / a;\n\n\t\t\tfloat alpha = ( nearEstimate - start.z ) / ( end.z - start.z );\n\n\t\t\tend.xyz = mix( start.xyz, end.xyz, alpha );\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\t#ifdef USE_COLOR\n\n\t\t\t\tvColor.xyz = ( position.y < 0.5 ) ? instanceColorStart : instanceColorEnd;\n\n\t\t\t#endif\n\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tvLineDistance = ( position.y < 0.5 ) ? dashScale * instanceDistanceStart : dashScale * instanceDistanceEnd;\n\t\t\t\tvUv = uv;\n\n\t\t\t#endif\n\n\t\t\tfloat aspect = resolution.x / resolution.y;\n\n\t\t\t// camera space\n\t\t\tvec4 start = modelViewMatrix * vec4( instanceStart, 1.0 );\n\t\t\tvec4 end = modelViewMatrix * vec4( instanceEnd, 1.0 );\n\n\t\t\t#ifdef WORLD_UNITS\n\n\t\t\t\tworldStart = start.xyz;\n\t\t\t\tworldEnd = end.xyz;\n\n\t\t\t#else\n\n\t\t\t\tvUv = uv;\n\n\t\t\t#endif\n\n\t\t\t// special case for perspective projection, and segments that terminate either in, or behind, the camera plane\n\t\t\t// clearly the gpu firmware has a way of addressing this issue when projecting into ndc space\n\t\t\t// but we need to perform ndc-space calculations in the shader, so we must address this issue directly\n\t\t\t// perhaps there is a more elegant solution -- WestLangley\n\n\t\t\tbool perspective = ( projectionMatrix[ 2 ][ 3 ] == - 1.0 ); // 4th entry in the 3rd column\n\n\t\t\tif ( perspective ) {\n\n\t\t\t\tif ( start.z < 0.0 && end.z >= 0.0 ) {\n\n\t\t\t\t\ttrimSegment( start, end );\n\n\t\t\t\t} else if ( end.z < 0.0 && start.z >= 0.0 ) {\n\n\t\t\t\t\ttrimSegment( end, start );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\t// clip space\n\t\t\tvec4 clipStart = projectionMatrix * start;\n\t\t\tvec4 clipEnd = projectionMatrix * end;\n\n\t\t\t// ndc space\n\t\t\tvec3 ndcStart = clipStart.xyz / clipStart.w;\n\t\t\tvec3 ndcEnd = clipEnd.xyz / clipEnd.w;\n\n\t\t\t// direction\n\t\t\tvec2 dir = ndcEnd.xy - ndcStart.xy;\n\n\t\t\t// account for clip-space aspect ratio\n\t\t\tdir.x *= aspect;\n\t\t\tdir = normalize( dir );\n\n\t\t\t#ifdef WORLD_UNITS\n\n\t\t\t\t// get the offset direction as perpendicular to the view vector\n\t\t\t\tvec3 worldDir = normalize( end.xyz - start.xyz );\n\t\t\t\tvec3 offset;\n\t\t\t\tif ( position.y < 0.5 ) {\n\n\t\t\t\t\toffset = normalize( cross( start.xyz, worldDir ) );\n\n\t\t\t\t} else {\n\n\t\t\t\t\toffset = normalize( cross( end.xyz, worldDir ) );\n\n\t\t\t\t}\n\n\t\t\t\t// sign flip\n\t\t\t\tif ( position.x < 0.0 ) offset *= - 1.0;\n\n\t\t\t\tfloat forwardOffset = dot( worldDir, vec3( 0.0, 0.0, 1.0 ) );\n\n\t\t\t\t// don't extend the line if we're rendering dashes because we\n\t\t\t\t// won't be rendering the endcaps\n\t\t\t\t#ifndef USE_DASH\n\n\t\t\t\t\t// extend the line bounds to encompass  endcaps\n\t\t\t\t\tstart.xyz += - worldDir * linewidth * 0.5;\n\t\t\t\t\tend.xyz += worldDir * linewidth * 0.5;\n\n\t\t\t\t\t// shift the position of the quad so it hugs the forward edge of the line\n\t\t\t\t\toffset.xy -= dir * forwardOffset;\n\t\t\t\t\toffset.z += 0.5;\n\n\t\t\t\t#endif\n\n\t\t\t\t// endcaps\n\t\t\t\tif ( position.y > 1.0 || position.y < 0.0 ) {\n\n\t\t\t\t\toffset.xy += dir * 2.0 * forwardOffset;\n\n\t\t\t\t}\n\n\t\t\t\t// adjust for linewidth\n\t\t\t\toffset *= linewidth * 0.5;\n\n\t\t\t\t// set the world position\n\t\t\t\tworldPos = ( position.y < 0.5 ) ? start : end;\n\t\t\t\tworldPos.xyz += offset;\n\n\t\t\t\t// project the worldpos\n\t\t\t\tvec4 clip = projectionMatrix * worldPos;\n\n\t\t\t\t// shift the depth of the projected points so the line\n\t\t\t\t// segments overlap neatly\n\t\t\t\tvec3 clipPose = ( position.y < 0.5 ) ? ndcStart : ndcEnd;\n\t\t\t\tclip.z = clipPose.z * clip.w;\n\n\t\t\t#else\n\n\t\t\t\tvec2 offset = vec2( dir.y, - dir.x );\n\t\t\t\t// undo aspect ratio adjustment\n\t\t\t\tdir.x /= aspect;\n\t\t\t\toffset.x /= aspect;\n\n\t\t\t\t// sign flip\n\t\t\t\tif ( position.x < 0.0 ) offset *= - 1.0;\n\n\t\t\t\t// endcaps\n\t\t\t\tif ( position.y < 0.0 ) {\n\n\t\t\t\t\toffset += - dir;\n\n\t\t\t\t} else if ( position.y > 1.0 ) {\n\n\t\t\t\t\toffset += dir;\n\n\t\t\t\t}\n\n\t\t\t\t// adjust for linewidth\n\t\t\t\toffset *= linewidth;\n\n\t\t\t\t// adjust for clip-space to screen-space conversion // maybe resolution should be based on viewport ...\n\t\t\t\toffset /= resolution.y;\n\n\t\t\t\t// select end\n\t\t\t\tvec4 clip = ( position.y < 0.5 ) ? clipStart : clipEnd;\n\n\t\t\t\t// back to clip space\n\t\t\t\toffset *= clip.w;\n\n\t\t\t\tclip.xy += offset;\n\n\t\t\t#endif\n\n\t\t\tgl_Position = clip;\n\n\t\t\tvec4 mvPosition = ( position.y < 0.5 ) ? start : end; // this is an approximation\n\n\t\t\t#include <logdepthbuf_vertex>\n\t\t\t#include <clipping_planes_vertex>\n\t\t\t#include <fog_vertex>\n\n\t\t}\n\t\t",fragmentShader:"\n\t\tuniform vec3 diffuse;\n\t\tuniform float opacity;\n\t\tuniform float linewidth;\n\n\t\t#ifdef USE_DASH\n\n\t\t\tuniform float dashOffset;\n\t\t\tuniform float dashSize;\n\t\t\tuniform float gapSize;\n\n\t\t#endif\n\n\t\tvarying float vLineDistance;\n\n\t\t#ifdef WORLD_UNITS\n\n\t\t\tvarying vec4 worldPos;\n\t\t\tvarying vec3 worldStart;\n\t\t\tvarying vec3 worldEnd;\n\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tvarying vec2 vUv;\n\n\t\t\t#endif\n\n\t\t#else\n\n\t\t\tvarying vec2 vUv;\n\n\t\t#endif\n\n\t\t#include <common>\n\t\t#include <color_pars_fragment>\n\t\t#include <fog_pars_fragment>\n\t\t#include <logdepthbuf_pars_fragment>\n\t\t#include <clipping_planes_pars_fragment>\n\n\t\tvec2 closestLineToLine(vec3 p1, vec3 p2, vec3 p3, vec3 p4) {\n\n\t\t\tfloat mua;\n\t\t\tfloat mub;\n\n\t\t\tvec3 p13 = p1 - p3;\n\t\t\tvec3 p43 = p4 - p3;\n\n\t\t\tvec3 p21 = p2 - p1;\n\n\t\t\tfloat d1343 = dot( p13, p43 );\n\t\t\tfloat d4321 = dot( p43, p21 );\n\t\t\tfloat d1321 = dot( p13, p21 );\n\t\t\tfloat d4343 = dot( p43, p43 );\n\t\t\tfloat d2121 = dot( p21, p21 );\n\n\t\t\tfloat denom = d2121 * d4343 - d4321 * d4321;\n\n\t\t\tfloat numer = d1343 * d4321 - d1321 * d4343;\n\n\t\t\tmua = numer / denom;\n\t\t\tmua = clamp( mua, 0.0, 1.0 );\n\t\t\tmub = ( d1343 + d4321 * ( mua ) ) / d4343;\n\t\t\tmub = clamp( mub, 0.0, 1.0 );\n\n\t\t\treturn vec2( mua, mub );\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\t#include <clipping_planes_fragment>\n\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tif ( vUv.y < - 1.0 || vUv.y > 1.0 ) discard; // discard endcaps\n\n\t\t\t\tif ( mod( vLineDistance + dashOffset, dashSize + gapSize ) > dashSize ) discard; // todo - FIX\n\n\t\t\t#endif\n\n\t\t\tfloat alpha = opacity;\n\n\t\t\t#ifdef WORLD_UNITS\n\n\t\t\t\t// Find the closest points on the view ray and the line segment\n\t\t\t\tvec3 rayEnd = normalize( worldPos.xyz ) * 1e5;\n\t\t\t\tvec3 lineDir = worldEnd - worldStart;\n\t\t\t\tvec2 params = closestLineToLine( worldStart, worldEnd, vec3( 0.0, 0.0, 0.0 ), rayEnd );\n\n\t\t\t\tvec3 p1 = worldStart + lineDir * params.x;\n\t\t\t\tvec3 p2 = rayEnd * params.y;\n\t\t\t\tvec3 delta = p1 - p2;\n\t\t\t\tfloat len = length( delta );\n\t\t\t\tfloat norm = len / linewidth;\n\n\t\t\t\t#ifndef USE_DASH\n\n\t\t\t\t\t#ifdef USE_ALPHA_TO_COVERAGE\n\n\t\t\t\t\t\tfloat dnorm = fwidth( norm );\n\t\t\t\t\t\talpha = 1.0 - smoothstep( 0.5 - dnorm, 0.5 + dnorm, norm );\n\n\t\t\t\t\t#else\n\n\t\t\t\t\t\tif ( norm > 0.5 ) {\n\n\t\t\t\t\t\t\tdiscard;\n\n\t\t\t\t\t\t}\n\n\t\t\t\t\t#endif\n\n\t\t\t\t#endif\n\n\t\t\t#else\n\n\t\t\t\t#ifdef USE_ALPHA_TO_COVERAGE\n\n\t\t\t\t\t// artifacts appear on some hardware if a derivative is taken within a conditional\n\t\t\t\t\tfloat a = vUv.x;\n\t\t\t\t\tfloat b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;\n\t\t\t\t\tfloat len2 = a * a + b * b;\n\t\t\t\t\tfloat dlen = fwidth( len2 );\n\n\t\t\t\t\tif ( abs( vUv.y ) > 1.0 ) {\n\n\t\t\t\t\t\talpha = 1.0 - smoothstep( 1.0 - dlen, 1.0 + dlen, len2 );\n\n\t\t\t\t\t}\n\n\t\t\t\t#else\n\n\t\t\t\t\tif ( abs( vUv.y ) > 1.0 ) {\n\n\t\t\t\t\t\tfloat a = vUv.x;\n\t\t\t\t\t\tfloat b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;\n\t\t\t\t\t\tfloat len2 = a * a + b * b;\n\n\t\t\t\t\t\tif ( len2 > 1.0 ) discard;\n\n\t\t\t\t\t}\n\n\t\t\t\t#endif\n\n\t\t\t#endif\n\n\t\t\tvec4 diffuseColor = vec4( diffuse, alpha );\n\n\t\t\t#include <logdepthbuf_fragment>\n\t\t\t#include <color_fragment>\n\n\t\t\tgl_FragColor = vec4( diffuseColor.rgb, alpha );\n\n\t\t\t#include <tonemapping_fragment>\n\t\t\t#include <encodings_fragment>\n\t\t\t#include <fog_fragment>\n\t\t\t#include <premultiplied_alpha_fragment>\n\n\t\t}\n\t\t"};class re extends p{constructor(e){super({type:"LineMaterial",uniforms:d.clone(h.line.uniforms),vertexShader:h.line.vertexShader,fragmentShader:h.line.fragmentShader,clipping:!0}),this.isLineMaterial=!0,Object.defineProperties(this,{color:{enumerable:!0,get:function(){return this.uniforms.diffuse.value},set:function(e){this.uniforms.diffuse.value=e}},worldUnits:{enumerable:!0,get:function(){return"WORLD_UNITS"in this.defines},set:function(e){!0===e?this.defines.WORLD_UNITS="":delete this.defines.WORLD_UNITS}},linewidth:{enumerable:!0,get:function(){return this.uniforms.linewidth.value},set:function(e){this.uniforms.linewidth.value=e}},dashed:{enumerable:!0,get:function(){return"USE_DASH"in this.defines},set(e){!!e!="USE_DASH"in this.defines&&(this.needsUpdate=!0),!0===e?this.defines.USE_DASH="":delete this.defines.USE_DASH}},dashScale:{enumerable:!0,get:function(){return this.uniforms.dashScale.value},set:function(e){this.uniforms.dashScale.value=e}},dashSize:{enumerable:!0,get:function(){return this.uniforms.dashSize.value},set:function(e){this.uniforms.dashSize.value=e}},dashOffset:{enumerable:!0,get:function(){return this.uniforms.dashOffset.value},set:function(e){this.uniforms.dashOffset.value=e}},gapSize:{enumerable:!0,get:function(){return this.uniforms.gapSize.value},set:function(e){this.uniforms.gapSize.value=e}},opacity:{enumerable:!0,get:function(){return this.uniforms.opacity.value},set:function(e){this.uniforms.opacity.value=e}},resolution:{enumerable:!0,get:function(){return this.uniforms.resolution.value},set:function(e){this.uniforms.resolution.value.copy(e)}},alphaToCoverage:{enumerable:!0,get:function(){return"USE_ALPHA_TO_COVERAGE"in this.defines},set:function(e){!!e!="USE_ALPHA_TO_COVERAGE"in this.defines&&(this.needsUpdate=!0),!0===e?(this.defines.USE_ALPHA_TO_COVERAGE="",this.extensions.derivatives=!0):(delete this.defines.USE_ALPHA_TO_COVERAGE,this.extensions.derivatives=!1)}}}),this.setValues(e)}}const le=new n,ce=new n,ue=new f,he=new f,de=new f,pe=new n,fe=new b,be=new m,me=new n,ye=new t,xe=new l,ve=new f;let ge,we;function ke(e,t,n){return ve.set(0,0,-t,1).applyMatrix4(e.projectionMatrix),ve.multiplyScalar(1/ve.w),ve.x=we/n.width,ve.y=we/n.height,ve.applyMatrix4(e.projectionMatrixInverse),ve.multiplyScalar(1/ve.w),Math.abs(Math.max(ve.x,ve.y))}let Ee,Se,Pe,Me,Le,Oe=new e.WebGLRenderer({antialias:!0}),Ae=new e.Scene,Te=new e.WebGLRenderTarget(1,1),De=new e.Scene,Ce={},Ne={},ze={};const je=e=>{if(e.length>6){const t=e.length/3;let n=0;for(let i=1;i<t-1;i++){const t=3*i+3*n;e.splice(t,0,e[t],e[t+1],e[t+2]),n++}}else if(3===e.length)return[];return e},Ie=(e,t)=>{let n=[];for(let i=0;i<e.length/3;i++)n.push(t.r,t.g,t.b);return n};let Fe=new e.LineBasicMaterial({vertexColors:!0}),Ve=new e.LineBasicMaterial({vertexColors:!0});const Be={};let Re={};const _e=()=>{Re={};for(let t=0;t<He.length;t++){const n=He[t];if(!n)continue;ze[n.pixelIndex]?ze[n.pixelIndex].push(t):ze[n.pixelIndex]=[t],Ne[n.layer]?Ne[n.layer].push(t):Ne[n.layer]=[t];let i=[],a=[],o=[];if("object"==typeof n.positions[0]?n.positions.forEach((s=>{i=je(s.positions),a=Ie(i,new e.Color(n.color)),o=Ie(i,new e.Color(t))})):(i=je(n.positions),a=Ie(i,new e.Color(n.color)),o=Ie(i,new e.Color(t))),!Me||!Le){const{offsetX:e,offsetY:t}=te(i);Me=e,Le=t}const s=ne(i,Me,Le);Be[t]={positions:s,colors:a,pickColors:o},Re[n.layer]?(Re[n.layer].positions.push(...s),Re[n.layer].colors.push(...a),Re[n.layer].pickColors.push(...o)):Re[n.layer]={positions:[...s],colors:[...a],pickColors:[...o]}}};let He,Ye,Xe={};const Ue=(t,n)=>{console.log("解析数据",t),He=t.models,t.models.length,Ye=n,Pe=t.box,Ae.background=new e.Color(3289655),(()=>{_e();for(let t in Re){const{positions:n,colors:i,pickColors:a}=Re[t];let o=new e.BufferGeometry,s=new e.BufferGeometry;if(Me&&Le){let t=new e.Float32BufferAttribute(n,3);o.setAttribute("position",t),s.setAttribute("position",t)}o.setAttribute("color",new e.Float32BufferAttribute(i,3)),s.setAttribute("color",new e.Float32BufferAttribute(a,3));let r=new e.LineSegments(o,Ve),l=new e.LineSegments(s,Fe);if(Me&&Le){let e=Me?Me/100:0,t=Le?Le/100:0;r.position.set(e,t,0),l.position.set(e,t,0);const n=.01;r.scale.set(n,n,n),l.scale.set(n,n,n)}Ae.add(r),De.add(l),Ce[t]={objects:r,pickObjects:l}}Re=null})(),t.group.forEach((e=>{Xe[e.layer]?Xe[e.layer].push(e):Xe[e.layer]=[e],Ae.add(e)})),lt();const i=window.innerWidth/window.innerHeight,a=Pe.max.x,o=Pe.max.y,s=Pe.min.x,r=Pe.min.y;let l=a-s,c=o-r,u={x:l/2+s,y:c/2+r};const h=Math.abs(l/c);i>h?l=c*i:c=l/i;const d={bottom:-c/2,left:-l/2,top:c/2,right:l/2,center:{x:u.x,y:u.y}},p=1.3;Ee=new e.OrthographicCamera(d.left*p,d.right*p,d.top*p,d.bottom*p,1,19),Ee.position.z=10,Ee.position.x=d.center.x,Ee.position.y=d.center.y,Oe.setSize(window.innerWidth,window.innerHeight),Oe.setPixelRatio(window.devicePixelRatio),Oe.setClearColor(268435455,1),Ye.appendChild(Oe.domElement),Ye.style.display="block",Se=new Q(Ee,Ye),Se.target.x=Ee.position.x,Se.target.y=Ee.position.y,Se.target.z=0,Se.zoomSpeed=3,Se.addEventListener("change",qe),qe(),Se.update();window.addEventListener("resize",(()=>{const t=Se.object.position,n=Se.object.zoom,i=window.innerWidth/window.innerHeight;i>h?l=c*i:c=l/i;const a=-c/2,o=-l/2,s=c/2,r=l/2;Ee=new e.OrthographicCamera(o*p,r*p,s*p,a*p,1,19),Ee.position.set(t.x,t.y,t.z),Ee.zoom=n,Se.object=Ee,Se.object.updateProjectionMatrix(),Oe.setSize(window.innerWidth,window.innerHeight),Oe.setPixelRatio(window.devicePixelRatio),Oe.render(Ae,Ee)})),Ge(),window.addEventListener("mousedown",We,!1),window.addEventListener("mouseup",Ge,!1),Ye.addEventListener("click",ot)},Ge=()=>{Ye.addEventListener("pointermove",Je,!1)},We=()=>{Ye.removeEventListener("pointermove",Je,!1)},qe=()=>{Oe.setRenderTarget(null),Oe.render(Ae,Ee)};let $e=new e.Vector2;const Je=e=>{$e.x=e.clientX,$e.y=e.clientY,Ze(),qe()};let Ke;const Ze=()=>{Ee.setViewOffset(window.innerWidth,window.innerHeight,$e.x*window.devicePixelRatio|0,$e.y*window.devicePixelRatio|0,1,1),Oe.setRenderTarget(Te),Oe.render(De,Ee),Ee.clearViewOffset();const e=new Uint8Array(4);Oe.readRenderTargetPixels(Te,0,0,1,1,e);const t=e[0]<<16|e[1]<<8|e[2];if(Ke=t,16777215!==t){{const e=He[t].pixelIndex;nt(ze[e])}}else Ke=null,nt([]);qe()};let Qe=new se;const et=new re({linewidth:.0015,vertexColors:!0,dashed:!1,alphaToCoverage:!0,transparent:!0,depthTest:!1});let tt=new class extends y{constructor(e=new se,t=new re({color:16777215*Math.random()})){super(e,t),this.isLineSegments2=!0,this.type="LineSegments2"}computeLineDistances(){const e=this.geometry,t=e.attributes.instanceStart,n=e.attributes.instanceEnd,i=new Float32Array(2*t.count);for(let e=0,a=0,o=t.count;e<o;e++,a+=2)le.fromBufferAttribute(t,e),ce.fromBufferAttribute(n,e),i[a]=0===a?0:i[a-1],i[a+1]=i[a]+le.distanceTo(ce);const a=new o(i,2,1);return e.setAttribute("instanceDistanceStart",new s(a,1,0)),e.setAttribute("instanceDistanceEnd",new s(a,1,1)),this}raycast(e,t){const i=this.material.worldUnits,a=e.camera;null===a&&!i&&console.error('LineSegments2: "Raycaster.camera" needs to be set in order to raycast against LineSegments2 while worldUnits is set to false.');const o=void 0!==e.params.Line2&&e.params.Line2.threshold||0;ge=e.ray;const s=this.matrixWorld,r=this.geometry,l=this.material;let c,u;if(we=l.linewidth+o,null===r.boundingSphere&&r.computeBoundingSphere(),xe.copy(r.boundingSphere).applyMatrix4(s),i)c=.5*we;else{c=ke(a,Math.max(a.near,xe.distanceToPoint(ge.origin)),l.resolution)}if(xe.radius+=c,!1!==ge.intersectsSphere(xe)){if(null===r.boundingBox&&r.computeBoundingBox(),ye.copy(r.boundingBox).applyMatrix4(s),i)u=.5*we;else{u=ke(a,Math.max(a.near,ye.distanceToPoint(ge.origin)),l.resolution)}ye.expandByScalar(u),!1!==ge.intersectsBox(ye)&&(i?function(e,t){const i=e.matrixWorld,a=e.geometry,o=a.attributes.instanceStart,s=a.attributes.instanceEnd;for(let r=0,l=Math.min(a.instanceCount,o.count);r<l;r++){be.start.fromBufferAttribute(o,r),be.end.fromBufferAttribute(s,r),be.applyMatrix4(i);const a=new n,l=new n;ge.distanceSqToSegment(be.start,be.end,l,a),l.distanceTo(a)<.5*we&&t.push({point:l,pointOnLine:a,distance:ge.origin.distanceTo(l),object:e,face:null,faceIndex:r,uv:null,uv2:null})}}(this,t):function(e,t,i){const a=t.projectionMatrix,o=e.material.resolution,s=e.matrixWorld,r=e.geometry,l=r.attributes.instanceStart,c=r.attributes.instanceEnd,u=Math.min(r.instanceCount,l.count),h=-t.near;ge.at(1,de),de.w=1,de.applyMatrix4(t.matrixWorldInverse),de.applyMatrix4(a),de.multiplyScalar(1/de.w),de.x*=o.x/2,de.y*=o.y/2,de.z=0,pe.copy(de),fe.multiplyMatrices(t.matrixWorldInverse,s);for(let t=0,r=u;t<r;t++){if(ue.fromBufferAttribute(l,t),he.fromBufferAttribute(c,t),ue.w=1,he.w=1,ue.applyMatrix4(fe),he.applyMatrix4(fe),ue.z>h&&he.z>h)continue;if(ue.z>h){const e=ue.z-he.z,t=(ue.z-h)/e;ue.lerp(he,t)}else if(he.z>h){const e=he.z-ue.z,t=(he.z-h)/e;he.lerp(ue,t)}ue.applyMatrix4(a),he.applyMatrix4(a),ue.multiplyScalar(1/ue.w),he.multiplyScalar(1/he.w),ue.x*=o.x/2,ue.y*=o.y/2,he.x*=o.x/2,he.y*=o.y/2,be.start.copy(ue),be.start.z=0,be.end.copy(he),be.end.z=0;const r=be.closestPointToPointParameter(pe,!0);be.at(r,me);const u=x.lerp(ue.z,he.z,r),d=u>=-1&&u<=1,p=pe.distanceTo(me)<.5*we;if(d&&p){be.start.fromBufferAttribute(l,t),be.end.fromBufferAttribute(c,t),be.start.applyMatrix4(s),be.end.applyMatrix4(s);const a=new n,o=new n;ge.distanceSqToSegment(be.start,be.end,o,a),i.push({point:o,pointOnLine:a,distance:ge.origin.distanceTo(o),object:e,face:null,faceIndex:t,uv:null,uv2:null})}}}(this,a,t))}}}(Qe,et);const nt=(e,t)=>{let n=[];e.forEach((e=>{n.push(...Be[e].positions)}));let i={max:{x:0,y:0},min:{x:0,y:0}};if(t){i.max.x=n[0],i.min.x=n[0],i.min.y=n[1],i.max.y=n[1];for(let e=0;e<n.length;e+=3)i.max.x<n[e]&&(i.max.x=n[e]),i.min.x>n[e]&&(i.min.x=n[e]),i.max.y<n[e+1]&&(i.max.y=n[e+1]),i.min.y>n[e+1]&&(i.min.y=n[e+1])}at.forEach((e=>{n.push(...Be[e].positions)}));let a=new se;a.setPositions(n);let o=[];for(let e=0;e<n.length;e+=3)o.push(1),o.push(.4),o.push(0);a.setColors(o),tt.geometry=a,tt.computeLineDistances(),tt.scale.set(1,1,1);let s=Me?Me/100:0,r=Le?Le/100:0;tt.position.set(s,r,0);const l=.01;if(tt.scale.set(l,l,l),Ae.add(tt),t)return i};let it,at=[];const ot=()=>{Ke?(it=He[Ke].pixelIndex,at=[...ze[it]],nt(ze[it])):(at=[],it=null,nt([])),qe()};let st=[],rt=[];const lt=()=>{let e=[];for(let t in Xe)e.push(t);for(let t in Ce)e.push(t);e.sort(((e,t)=>e.localeCompare(t))),st=[...new Set(e)],rt=[...new Set(e)]},ct=(e,t)=>{let n=[];"string"==typeof e?n.push(e):n=e,t?rt.push(...n):rt=rt.filter((e=>!n.includes(e)));for(let e in Ce)n.includes(e)&&(Ce[e].objects.visible=t,Ce[e].pickObjects.visible=t);n.forEach((e=>{Xe[e]&&Xe[e].forEach((e=>e.visible=t))})),qe()},ut=e=>{rt=e?st:[];for(let t in Ce)Ce[t].objects.visible=e,Ce[t].pickObjects.visible=e;for(let t in Xe)Xe[t].forEach((t=>t.visible=e));qe()},ht=()=>{ee()},dt=()=>{J.removeEventListener("mousedown",K,!1),J.removeEventListener("mousewheel",Z,!1),J.removeEventListener("DOMMouseScroll",Z,!1)};let pt={};let ft,bt,mt,yt,xt,vt,gt,wt="";const kt=(t,n,i,a,o,s)=>{let r=[];for(let l=0;l<=a;l++){let c=l/a*Math.PI*2;const u=new e.Vector3;u.x=t+i*Math.sin(c)*o,u.y=n+i*Math.cos(c)*s,u.z=0,r.push(u)}return r};let Et,St;const Pt=()=>{Et(),document.addEventListener("mousedown",yt,!1),document.addEventListener("mousemove",xt,!1),document.addEventListener("mouseup",vt,!1)},Mt=()=>{document.removeEventListener("mousedown",yt,!1),document.removeEventListener("mousemove",xt,!1),document.removeEventListener("mouseup",vt,!1),St()};let Lt,Ot,At;const Tt=()=>{Ot(),document.addEventListener("mousedown",Lt,!1)},Dt=()=>{document.removeEventListener("mousedown",Lt,!1),At()};let Ct,Nt,zt,jt,It,Ft,Vt,Bt=!1,Rt=!1,_t=[];const Ht=()=>{zt(),document.addEventListener("mousedown",It,!1),document.addEventListener("mousemove",Ft,!1),document.addEventListener("mouseup",Vt,!1)},Yt=()=>{document.removeEventListener("mousedown",It,!1),document.removeEventListener("mousemove",Ft,!1),document.removeEventListener("mouseup",Vt,!1),jt()};class Xt extends v{constructor(e){super(e)}load(e,t,n,i){const a=this,o=new g(this.manager);o.setPath(this.path),o.setRequestHeader(this.requestHeader),o.setWithCredentials(this.withCredentials),o.load(e,(function(e){const n=a.parse(JSON.parse(e));t&&t(n)}),n,i)}parse(e){return new Ut(e)}}class Ut{constructor(e){this.isFont=!0,this.type="Font",this.data=e}generateShapes(e,t=100){const n=[],i=function(e,t,n){const i=Array.from(e),a=t/n.resolution,o=(n.boundingBox.yMax-n.boundingBox.yMin+n.underlineThickness)*a,s=[];let r=0,l=0;for(let e=0;e<i.length;e++){const t=i[e];if("\n"===t)r=0,l-=o;else{const e=Gt(t,a,r,l,n);r+=e.offsetX,s.push(e.path)}}return s}(e,t,this.data);for(let e=0,t=i.length;e<t;e++)n.push(...i[e].toShapes());return n}}function Gt(e,t,n,i,a){const o=a.glyphs[e]||a.glyphs["?"];if(!o)return void console.error('THREE.Font: character "'+e+'" does not exists in font family '+a.familyName+".");const s=new w;let r,l,c,u,h,d,p,f;if(o.o){const e=o._cachedOutline||(o._cachedOutline=o.o.split(" "));for(let a=0,o=e.length;a<o;)switch(e[a++]){case"m":r=e[a++]*t+n,l=e[a++]*t+i,s.moveTo(r,l);break;case"l":r=e[a++]*t+n,l=e[a++]*t+i,s.lineTo(r,l);break;case"q":c=e[a++]*t+n,u=e[a++]*t+i,h=e[a++]*t+n,d=e[a++]*t+i,s.quadraticCurveTo(h,d,c,u);break;case"b":c=e[a++]*t+n,u=e[a++]*t+i,h=e[a++]*t+n,d=e[a++]*t+i,p=e[a++]*t+n,f=e[a++]*t+i,s.bezierCurveTo(h,d,p,f,c,u)}}return{offsetX:o.ha*t,path:s}}class Wt extends k{constructor(e,t={}){const n=t.font;if(void 0===n)super();else{const i=n.generateShapes(e,t.size);t.depth=void 0!==t.height?t.height:50,void 0===t.bevelThickness&&(t.bevelThickness=10),void 0===t.bevelSize&&(t.bevelSize=8),void 0===t.bevelEnabled&&(t.bevelEnabled=!1),super(i,t)}this.type="TextGeometry"}}const qt="http://120.86.64.201:5023/CADFile/";var $t="http://120.86.64.201:5024/",Jt=qt,Kt=`${qt}FZYaoTi_Regular.json`,Zt=`${qt}SJQY.ttf`,Qt=`${qt}FZYTK.TTF`;let en,tn,nn,an,on,sn,rn,ln=L("");const cn=new e.MeshBasicMaterial({color:"#ffffff"}),un=()=>new Promise(((e,t)=>{const n=`${Kt}`;(new Xt).load(n,(t=>{rn=t,e()}))})),hn=()=>{on(),document.addEventListener("mousedown",nn,!1)},dn=()=>{document.removeEventListener("mousedown",nn,!1),sn()};let pn,fn,bn,mn,yn,xn,vn,gn,wn="";const kn=()=>{vn(),document.addEventListener("mousedown",bn,!1),document.addEventListener("mousemove",mn,!1),document.addEventListener("mouseup",yn,!1)},En=()=>{document.removeEventListener("mousedown",bn,!1),document.removeEventListener("mousemove",mn,!1),document.removeEventListener("mouseup",yn,!1),gn()};var Sn=Object.defineProperty,Pn=(e,t,n)=>(((e,t,n)=>{t in e?Sn(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);const Mn={line:t=>new Promise(((n,i)=>{let{camera:a,scene:o,renderer:s}=t;Ot=t.deleteMoveEvent,At=t.addMoveEvent;const r=new e.Group;o.add(r);let l=[];Lt=e=>{let t=T(e.clientX,e.clientY,a);l.push(t),2===l.length&&c()};const c=()=>{const t=new e.LineBasicMaterial({color:16777215}),i=(new e.BufferGeometry).setFromPoints([new e.Vector3(l[0].x,l[0].y,0),new e.Vector3(l[1].x,l[1].y,0)]);let c=new e.Line(i,t);r.add(c),s.render(o,a),Dt(),n({type:"line",comment:c,commentData:l})};Tt()})),ellipse:t=>new Promise(((n,i)=>{let{camera:a,scene:o,renderer:s}=t;Et=t.deleteMoveEvent,St=t.addMoveEvent;const r=new e.Group;o.add(r),bt=null,ft=(e,t,n)=>{let i=T(e,t,n);return r.worldToLocal(i)},yt=e=>{bt=ft(e.clientX,e.clientY,a)},xt=t=>{if(!bt)return;mt=ft(t.clientX,t.clientY,a);const n=bt.x+(mt.x-bt.x)/2,i=bt.y+(mt.y-bt.y)/2,l=Math.abs(bt.x-mt.x),c=Math.abs(bt.y-mt.y),u=Math.max(l,c)/2,h=kt(n,i,u,50,l/2/u,c/2/u);"drawing"===wt&&r.remove(gt);const d=(new e.BufferGeometry).setFromPoints(h),p=new e.LineBasicMaterial({color:16777215});gt=new e.LineLoop(d,p),r.add(gt),wt="drawing",C((()=>{s.render(o,a)}),40)},vt=()=>{wt="",Mt(),n({type:"ellipse",comment:gt,commentData:{startPoint:bt,endPoint:mt}})},Pt()})),pointerLine:t=>new Promise(((n,i)=>{let{camera:a,scene:o,renderer:s}=t;zt=t.deleteMoveEvent,jt=t.addMoveEvent;const r=new e.Group;o.add(r),_t=[],It=()=>{Bt=!0},Ft=t=>{if(!Bt)return;const n=T(t.clientX,t.clientY,a),i=new e.Vector3(n.x,n.y,0);_t.push(i),Ct=(new e.BufferGeometry).setFromPoints(_t);const l=new e.LineBasicMaterial({color:16777215});Rt&&r.remove(Nt),Nt=new e.Line(Ct,l),r.add(Nt),Rt=!0,C((()=>{s.render(o,a)}),30)},Vt=()=>{Bt=!1,Rt=!1,Yt(),n({type:"pointerLine",comment:Nt,commentData:_t})},Ht()})),word:t=>new Promise(((n,i)=>{let{camera:a,scene:o,renderer:s}=t;on=t.deleteMoveEvent,sn=t.addMoveEvent;const r=new e.Group;o.add(r),ln.value="",nn=e=>{en=T(e.clientX,e.clientY,a),tn=T(e.clientX+50,e.clientY,a),S({title:"请输入文字标注内容",message:()=>O("div",[O(P,{modelValue:ln.value,"onUpdate:modelValue":e=>{ln.value=e}})]),showCancelButton:!0,confirmButtonText:"确定",cancelButtonText:"取消"}).then((()=>{an()})).catch((()=>{})),dn()},an=async()=>{const t=.3*(tn.x-en.x);rn||await un();const i=new Wt(ln.value,{font:rn,size:t,height:0});let l=new e.Mesh(i,cn);l.position.set(en.x,en.y,0),r.add(l),s.render(o,a),n({type:"word",comment:l,commentData:{position:en,text:ln.value,fontHeight:t}})},hn()})),rect:t=>new Promise(((n,i)=>{let{camera:a,scene:o,renderer:s}=t;vn=t.deleteMoveEvent,gn=t.addMoveEvent;const r=new e.Group;o.add(r),pn=null,bn=e=>{pn=T(e.clientX,e.clientY,a)},mn=t=>{if(!pn)return;fn=T(t.clientX,t.clientY,a);const n=[new e.Vector3(pn.x,pn.y,0),new e.Vector3(fn.x,pn.y,0),new e.Vector3(fn.x,fn.y,0),new e.Vector3(pn.x,fn.y,0)];"drawing"===wn&&r.remove(xn);const i=(new e.BufferGeometry).setFromPoints(n),l=new e.LineBasicMaterial({color:16777215});xn=new e.LineLoop(i,l),r.add(xn),wn="drawing",C((()=>{s.render(o,a)}),40)},yn=()=>{wn="",En(),n({type:"rect",comment:xn,commentData:{startPoint:pn,endPoint:fn}})},kn()}))},Ln={line:(t,n)=>{let{camera:i,scene:a,renderer:o}=t;const s=new e.Group;a.add(s);const r=new e.LineBasicMaterial({color:16777215}),l=(new e.BufferGeometry).setFromPoints([new e.Vector3(n[0].x,n[0].y,0),new e.Vector3(n[1].x,n[1].y,0)]);let c=new e.Line(l,r);return s.add(c),o.render(a,i),c},ellipse:(t,n)=>{let{camera:i,scene:a,renderer:o}=t;const{startPoint:s,endPoint:r}=n,l=new e.Group;a.add(l);const c=s.x+(r.x-s.x)/2,u=s.y+(r.y-s.y)/2,h=Math.abs(s.x-r.x),d=Math.abs(s.y-r.y),p=Math.max(h,d)/2,f=kt(c,u,p,50,h/2/p,d/2/p),b=(new e.BufferGeometry).setFromPoints(f),m=new e.LineBasicMaterial({color:16777215});return gt=new e.LineLoop(b,m),l.add(gt),o.render(a,i),gt},pointerLine:(t,n)=>{let{camera:i,scene:a,renderer:o}=t;const s=new e.Group;a.add(s),Ct=(new e.BufferGeometry).setFromPoints(n);const r=new e.LineBasicMaterial({color:16777215});return Nt=new e.Line(Ct,r),s.add(Nt),o.render(a,i),Nt},word:async(t,n)=>{let{camera:i,scene:a,renderer:o}=t;const{text:s,position:r,fontHeight:l}=n,c=new e.Group;a.add(c),rn||await un();const u=new Wt(s,{font:rn,size:l,height:0});let h=new e.Mesh(u,cn);return h.position.set(r.x,r.y,0),c.add(h),o.render(a,i),h},rect:(t,n)=>{let{camera:i,scene:a,renderer:o}=t;const{startPoint:s,endPoint:r}=n,l=new e.Group;a.add(l);const c=[new e.Vector3(s.x,s.y,0),new e.Vector3(r.x,s.y,0),new e.Vector3(r.x,r.y,0),new e.Vector3(s.x,r.y,0)],u=(new e.BufferGeometry).setFromPoints(c),h=new e.LineBasicMaterial({color:16777215});return xn=new e.LineLoop(u,h),l.add(xn),o.render(a,i),xn}};var On=Object.defineProperty,An=(e,t,n)=>(((e,t,n)=>{t in e?On(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);let Tn=class{constructor(e){An(this,"Viewer"),An(this,"comment"),this.Viewer=e,this.comment=new class{constructor(e){Pn(this,"Viewer"),Pn(this,"commentArr",[]),Pn(this,"commentCollecter",{length:0}),this.Viewer=e}draw(e){Mn[e]?Mn[e](this.Viewer).then((e=>{const{type:t,comment:n,commentData:i}=e;this.collecter(t,n,i)})):console.log("暂不支持该类型批注")}reShowComment(e){e.forEach((async e=>{if(Ln[e.type]){const t=await Ln[e.type](this.Viewer,e.commentData);this.collecter(e.type,t,e.commentData)}else console.log("暂不支持该类型批注",e.type)}))}showOrHidden(){let{camera:e,scene:t,renderer:n}=this.Viewer;for(let e in this.commentCollecter)"length"!==e&&this.commentCollecter[e].forEach((e=>{e.visible=!e.visible}));n.render(t,e)}collecter(e,t,n){this.commentCollecter[e]?this.commentCollecter[e].push(t):(this.commentCollecter[e]=[t],this.commentCollecter.length++),this.commentArr.push({type:e,commentData:n})}}(e),this.Viewer.isLoadingLocal||Dn(this.Viewer.cadUrl).then((e=>{e&&this.reShowComment(JSON.parse(e))}))}reShowComment(e){this.Viewer.camera?this.comment.reShowComment(e):setTimeout((()=>{this.reShowComment(e)}),500)}HomeView(){this.Viewer.update();const{renderer:e,scene:t,camera:n,controls:i}=this.Viewer;i.target.copy(i.target0),i.object.position.copy(i.position0),i.object.zoom=1,i.object.updateProjectionMatrix(),e.render(t,n)}selectBox(t,n){this.Viewer.update();const{renderer:i,scene:a,camera:o,controls:s,addMoveEvent:r,deleteMoveEvent:l}=this.Viewer;((t,n,i,a,o,s,r=(()=>{}),l=(()=>{}))=>{z=o,j=s,r(),G(),I=(o,s,r)=>{const c=T(o,s,a.object),u=T(window.innerWidth/2,window.innerHeight/2,a.object),h=(new e.Vector3).subVectors(u,c);a.object.position.sub(h),a.object.zoom=a.object.zoom*r,a.object.updateProjectionMatrix(),t.render(n,i),l()}})(i,a,o,s,r,l,t,n)}cancelSelectBox(){W()}changeBackground(){this.Viewer.update();const{renderer:t,scene:n,camera:i}=this.Viewer;((t,n,i)=>{const a=[new e.Color(3289655),new e.Color(16777215)];q++,n.background=a[q%a.length],t.render(n,i)})(t,n,i)}fullScreen(e){var t;t=e,document.fullscreenElement?console.warn("已经是全屏状态"):t.requestFullscreen()}exitFullScreen(){document.fullscreenElement?document.exitFullscreen():console.warn("当前不是全屏状态")}getLayerList(){const{Allkeys:e,visibleKeys:t}={Allkeys:st,visibleKeys:rt};return{Allkeys:e,visibleKeys:t}}showLayerBykeys(e){ct(e,!0)}hiddenLayerBykeys(e){ct(e,!1)}showAllLayer(){ut(!0)}hiddenAllLayer(){ut(!1)}getSearchList(e){const{textData:t}=this.Viewer;return((e,t)=>{let n=[];return e.forEach(((e,i)=>{e.text.includes(t)&&(pt[i]=e,n.push({index:i,text:e.text}))})),n})(t,e)}positionByText(t){const{renderer:n,scene:i,camera:a,controls:o}=this.Viewer;((t,n,i,a,o)=>{let{x:s,y:r}=pt[o].position;const l=pt[o].boundingBox;((o,s,r)=>{const l=new e.Vector3(o,s,0),c=T(window.innerWidth/2,window.innerHeight/2,a.object),u=(new e.Vector3).subVectors(c,l);a.object.position.sub(u),a.object.zoom=a.object.zoom*r,a.object.updateProjectionMatrix(),t.render(n,i)})(s+Math.abs(l.max.x-l.min.x)/2,r-Math.abs(l.max.y-l.min.y)/2,(()=>{const t=T(0,0,a.object),n=T(0,window.innerHeight/6,a.object),i=(new e.Vector3).subVectors(n,t),s=pt[o].boundingBox,r=s.max.y-s.min.y;return Math.abs(i.y/r)})())})(n,i,a,o,t)}addComment(e){this.comment.draw(e)}showOrHiddenComment(){this.comment.showOrHidden()}saveComment(){this.Viewer.isLoadingLocal?console.warn("本地图纸无法保存批注，请先上传图纸到ourbim"):0!==this.comment.commentArr.length?Cn(this.Viewer.cadUrl,this.comment.commentArr):console.warn("请先添加批注再保存")}getSelectedPixelId(){return it}focusByPixelId(t){(t=>{if(t&&ze[t]){at=[...ze[t]];const n=nt(ze[t],!0);n.max.x=(n.max.x+Me)/100,n.min.x=(n.min.x+Me)/100,n.max.y=(n.max.y+Le)/100,n.min.y=(n.min.y+Le)/100;const i=ie(0,0,Se.object),a=6,o=ie(0,window.innerHeight/a,Se.object),s=(new e.Vector3).subVectors(o,i);let r=n.max.y-n.min.y;const l=n.max.x-n.min.x,c=l/r,u=window.innerWidth/window.innerHeight;c>u&&(r=l/u);const h=Math.abs(s.y/r),d=(n.max.x+n.min.x)/2,p=(n.max.y+n.min.y)/2,f=new e.Vector3(d,p,0),b=ie(window.innerWidth/2,window.innerHeight/2,Se.object),m=(new e.Vector3).subVectors(b,f);Se.object.position.sub(m),Se.object.zoom=Se.object.zoom*h,Se.object.updateProjectionMatrix(),Oe.render(Ae,Ee)}else console.log(t?`id为:${t}的图元不存在!`:"请传递正确的参数")})(t)}};const Dn=e=>new Promise((async(t,n)=>{if(!await(e=>new Promise(((t,n)=>{const i={fileName:e};fetch(`${$t}isExistComment`,{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)}).then((e=>e.json())).then((e=>{t(e.message)}))})))(e))return;fetch(`${Jt}${e}/comment.json`).then((e=>e.text())).then((e=>{t(e)}))})),Cn=(e,t)=>{const n={fileName:e,commentData:JSON.stringify(t)};fetch(`${$t}addComment`,{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}).then((e=>e.json())).then((e=>{200===e.code&&M({message:"保存成功",type:"success"})}))};let Nn=[];var zn=Object.defineProperty,jn=(e,t,n)=>(((e,t,n)=>{t in e?zn(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);function In(e,t){return e<=9?t:e>=10&&e<=59?parseFloat(t):e>=60&&e<=99?parseInt(t):e>=100&&e<=109?t:e>=110&&e<=149?parseFloat(t):e>=160&&e<=179?parseInt(t):e>=210&&e<=239?parseFloat(t):e>=270&&e<=289?parseInt(t):e>=290&&e<=299?function(e){if("0"===e)return!1;if("1"===e)return!0;throw TypeError("String '"+e+"' cannot be cast to Boolean type")}(t):e>=300&&e<=369?t:e>=370&&e<=389?parseInt(t):e>=390&&e<=399?t:e>=400&&e<=409?parseInt(t):e>=410&&e<=419?t:e>=420&&e<=429?parseInt(t):e>=430&&e<=439?t:e>=440&&e<=459?parseInt(t):e>=460&&e<=469?parseFloat(t):e>=470&&e<=481||999===e||e>=1e3&&e<=1009?t:e>=1010&&e<=1059?parseFloat(t):e>=1060&&e<=1071?parseInt(t):(console.log("WARNING: Group code does not have a defined type: %j",{code:e,value:t}),t)}var Fn=[0,16711680,16776960,65280,65535,255,16711935,16777215,8421504,12632256,16711680,16744319,13369344,13395558,10027008,10046540,8323072,8339263,4980736,4990502,16727808,16752511,13382400,13401958,10036736,10051404,8331008,8343359,4985600,4992806,16744192,16760703,13395456,13408614,10046464,10056268,8339200,8347455,4990464,4995366,16760576,16768895,13408512,13415014,10056192,10061132,8347392,8351551,4995328,4997670,16776960,16777087,13421568,13421670,10000384,10000460,8355584,8355647,5000192,5000230,12582656,14679935,10079232,11717734,7510016,8755276,6258432,7307071,3755008,4344870,8388352,12582783,6736896,10079334,5019648,7510092,4161280,6258495,2509824,3755046,4194048,10485631,3394560,8375398,2529280,6264908,2064128,5209919,1264640,3099686,65280,8388479,52224,6736998,38912,5019724,32512,4161343,19456,2509862,65343,8388511,52275,6737023,38950,5019743,32543,4161359,19475,2509871,65407,8388543,52326,6737049,38988,5019762,32575,4161375,19494,2509881,65471,8388575,52377,6737074,39026,5019781,32607,4161391,19513,2509890,65535,8388607,52428,6737100,39064,5019800,32639,4161407,19532,2509900,49151,8380415,39372,6730444,29336,5014936,24447,4157311,14668,2507340,32767,8372223,26316,6724044,19608,5010072,16255,4153215,9804,2505036,16383,8364031,13260,6717388,9880,5005208,8063,4149119,4940,2502476,255,8355839,204,6710988,152,5000344,127,4145023,76,2500172,4129023,10452991,3342540,8349388,2490520,6245528,2031743,5193599,1245260,3089996,8323327,12550143,6684876,10053324,4980888,7490712,4128895,6242175,2490444,3745356,12517631,14647295,10027212,11691724,7471256,8735896,6226047,7290751,3735628,4335180,16711935,16744447,13369548,13395660,9961624,9981080,8323199,8339327,4980812,4990540,16711871,16744415,13369497,13395634,9961586,9981061,8323167,8339311,4980793,4990530,16711807,16744383,13369446,13395609,9961548,9981042,8323135,8339295,4980774,4990521,16711743,16744351,13369395,13395583,9961510,9981023,8323103,8339279,4980755,4990511,3355443,5987163,8684676,11382189,14079702,16777215];function Vn(e){const t={};e.rewind();let n=e.next(),i=n.code;if(t.x=n.value,i+=10,n=e.next(),n.code!=i)throw new Error("Expected code for point value to be "+i+" but got "+n.code+".");return t.y=n.value,i+=10,n=e.next(),n.code!=i?(e.rewind(),t):(t.z=n.value,t)}function Bn(e,t){e.rewind();const n=[];for(let i=0;i<16;i++){const i=e.next();if(i.code!==t)throw new Error("Expected code for matrix value to be "+t+" but got "+i.code+".");n.push(i.value)}return n}function Rn(e,t,n){switch(t.code){case 0:e.type=t.value;break;case 5:e.handle=t.value;break;case 6:e.lineType=t.value;break;case 8:e.layer=t.value;break;case 48:e.lineTypeScale=t.value;break;case 60:e.visible=0===t.value;break;case 62:e.colorIndex=t.value,e.color=function(e){return Fn[e]}(Math.abs(t.value));break;case 67:e.inPaperSpace=0!==t.value;break;case 100:break;case 101:for(;0!=t.code;)t=n.next();n.rewind();break;case 330:e.ownerHandle=t.value;break;case 347:e.materialObjectHandle=t.value;break;case 370:e.lineweight=t.value;break;case 420:e.color=t.value;break;case 1e3:e.extendedData=e.extendedData||{},e.extendedData.customStrings=e.extendedData.customStrings||[],e.extendedData.customStrings.push(t.value);break;case 1001:e.extendedData=e.extendedData||{},e.extendedData.applicationName=t.value;break;default:return!1}return!0}var _n=Object.defineProperty,Hn=(e,t,n)=>(((e,t,n)=>{t in e?_n(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);let Yn=class{constructor(){Hn(this,"ForEntityName","3DFACE")}parseEntity(e,t){const n={type:t.value,vertices:[]};for(t=e.next();!e.isEOF()&&0!==t.code;){switch(t.code){case 70:n.shape=1==(1&t.value),n.hasContinuousLinetypePattern=128==(128&t.value);break;case 10:n.vertices=Xn(e,t),t=e.lastReadGroup;break;default:Rn(n,t,e)}t=e.next()}return n}};function Xn(e,t){var n=[],i=!1,a=!1;for(let s=0;s<=4;s++){for(var o={};!e.isEOF()&&0!==t.code&&!a;){switch(t.code){case 10:case 11:case 12:case 13:if(i){a=!0;continue}o.x=t.value,i=!0;break;case 20:case 21:case 22:case 23:o.y=t.value;break;case 30:case 31:case 32:case 33:o.z=t.value;break;default:return n}t=e.next()}n.push(o),i=!1,a=!1}return e.rewind(),n}var Un=Object.defineProperty,Gn=(e,t,n)=>(((e,t,n)=>{t in e?Un(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);let Wn=class{constructor(){Gn(this,"ForEntityName","ARC")}parseEntity(e,t){const n={type:t.value};for(t=e.next();!e.isEOF()&&0!==t.code;){switch(t.code){case 10:n.center=Vn(e);break;case 40:n.radius=t.value;break;case 50:n.startAngle=Math.PI/180*t.value;break;case 51:n.endAngle=Math.PI/180*t.value,n.angleLength=n.endAngle-n.startAngle;break;case 210:n.extrusionDirectionX=t.value;break;case 220:n.extrusionDirectionY=t.value;break;case 230:n.extrusionDirectionZ=t.value;break;default:Rn(n,t,e)}t=e.next()}return n}};var qn=Object.defineProperty,$n=(e,t,n)=>(((e,t,n)=>{t in e?qn(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);let Jn=class{constructor(){$n(this,"ForEntityName","ATTDEF")}parseEntity(e,t){var n={type:t.value,scale:1,textStyle:"STANDARD"};for(t=e.next();!e.isEOF()&&0!==t.code;){switch(t.code){case 1:n.text=t.value;break;case 2:n.tag=t.value;break;case 3:n.prompt=t.value;break;case 7:n.textStyle=t.value;break;case 10:n.startPoint=Vn(e);break;case 11:n.endPoint=Vn(e);break;case 39:n.thickness=t.value;break;case 40:n.textHeight=t.value;break;case 41:n.scale=t.value;break;case 50:n.rotation=t.value;break;case 51:n.obliqueAngle=t.value;break;case 70:n.invisible=!!(1&t.value),n.constant=!!(2&t.value),n.verificationRequired=!!(4&t.value),n.preset=!!(8&t.value);break;case 71:n.backwards=!!(2&t.value),n.mirrored=!!(4&t.value);break;case 72:n.horizontalJustification=t.value;break;case 73:n.fieldLength=t.value;break;case 74:n.verticalJustification=t.value;break;case 100:break;case 210:n.extrusionDirectionX=t.value;break;case 220:n.extrusionDirectionY=t.value;break;case 230:n.extrusionDirectionZ=t.value;break;default:Rn(n,t,e)}t=e.next()}return n}};var Kn=Object.defineProperty,Zn=(e,t,n)=>(((e,t,n)=>{t in e?Kn(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);let Qn=class{constructor(){Zn(this,"ForEntityName","CIRCLE")}parseEntity(e,t){const n={type:t.value};for(t=e.next();!e.isEOF()&&0!==t.code;){switch(t.code){case 10:n.center=Vn(e);break;case 40:n.radius=t.value;break;case 50:n.startAngle=Math.PI/180*t.value;break;case 51:const i=Math.PI/180*t.value;i<n.startAngle?n.angleLength=i+2*Math.PI-n.startAngle:n.angleLength=i-n.startAngle,n.endAngle=i;break;default:Rn(n,t,e)}t=e.next()}return n}};var ei=Object.defineProperty,ti=(e,t,n)=>(((e,t,n)=>{t in e?ei(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);let ni=class{constructor(){ti(this,"ForEntityName","DIMENSION")}parseEntity(e,t){const n={type:t.value};for(t=e.next();!e.isEOF()&&0!==t.code;){switch(t.code){case 2:n.block=t.value;break;case 10:n.anchorPoint=Vn(e);break;case 11:n.middleOfText=Vn(e);break;case 12:n.insertionPoint=Vn(e);break;case 13:n.linearOrAngularPoint1=Vn(e);break;case 14:n.linearOrAngularPoint2=Vn(e);break;case 15:n.diameterOrRadiusPoint=Vn(e);break;case 16:n.arcPoint=Vn(e);break;case 70:n.dimensionType=t.value;break;case 71:n.attachmentPoint=t.value;break;case 42:n.actualMeasurement=t.value;break;case 1:n.text=t.value;break;case 50:n.angle=t.value;break;default:Rn(n,t,e)}t=e.next()}return n}};var ii=Object.defineProperty,ai=(e,t,n)=>(((e,t,n)=>{t in e?ii(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);class oi{constructor(){ai(this,"ForEntityName","MULTILEADER")}parseEntity(e,t){const n={type:t.value};function i(){for(;!e.isEOF();){switch(t.code){case 40:n.contextData.contentScale=t.value;break;case 10:n.contextData.contentBasePosition=Vn(e);break;case 145:n.contextData.landingGap=t.value;break;case 290:n.contextData.hasMText=t.value;break;case 304:n.contextData.defaultTextContents=t.value;break;case 11:n.contextData.textNormalDirection=Vn(e);break;case 12:n.contextData.textLocation=Vn(e);break;case 13:n.contextData.textDirection=Vn(e);break;case 140:n.contextData.arrowHeadSize=t.value;break;case 41:case 44:n.contextData.textHeight=t.value;break;case 42:n.contextData.textRotation=t.value;break;case 43:n.contextData.textWidth=t.value;break;case 45:n.contextData.textLineSpacingFactor=t.value;break;case 90:n.contextData.textColor=t.value;break;case 170:n.contextData.textLineSpacingStyle=t.value;break;case 171:n.contextData.textAttachment=t.value;break;case 172:n.contextData.textFlowDirection=t.value;break;case 141:n.contextData.textBackgroundScaleFactor=t.value;break;case 92:n.contextData.textBackgroundTransparency=t.value;break;case 291:n.contextData.textBackgroundColorOn=t.value;break;case 292:n.contextData.textBackgroundFillOn=t.value;break;case 293:n.contextData.textUseAutoHeight=t.value;break;case 173:n.contextData.textColumnType=t.value;break;case 142:n.contextData.textColumnWidth=t.value;break;case 143:n.contextData.textColumnGutterWidth=t.value;break;case 144:n.contextData.textColumnHeight=t.value;break;case 295:n.contextData.textUseWordBreak=t.value;break;case 296:n.contextData.hasBlock=t.value;break;case 341:n.contextData.blockContentId=t.value;break;case 14:n.contextData.blockContentNormalDirection=Vn(e);break;case 15:n.contextData.blockContentPosition=Vn(e);break;case 16:n.contextData.blockContentScale=t.value;break;case 46:n.contextData.blockContentRotation=t.value;break;case 93:n.contextData.blockContentColor=t.value;break;case 47:n.contextData.blockTransformationMatrix=Bn(e,47);break;case 110:n.contextData.planeOriginPoint=Vn(e);break;case 111:n.contextData.planeXAxisDirection=Vn(e);break;case 112:n.contextData.planeYAxisDirection=Vn(e);break;case 297:n.contextData.planeNormalReversed=t.value;break;case 301:return;case 302:a()}t=e.next()}}function a(){const i={leaderLines:[]};for(n.contextData.leaders.push(i);!e.isEOF();){switch(t.code){case 290:i.hasSetLastLeaderLinePoint=t.value;break;case 291:i.hasSetDoglegVector=t.value;break;case 10:i.lastLeaderLinePoint=Vn(e);break;case 11:i.doglegVector=Vn(e);break;case 90:i.leaderBranchIndex=t.value;break;case 40:i.doglegLength=t.value;break;case 303:return;case 304:o()}t=e.next()}}function o(){const i={vertices:[[]]};for(n.contextData.leaders[n.contextData.leaders.length-1].leaderLines.push(i);!e.isEOF();){switch(t.code){case 10:i.vertices[0].push(Vn(e));break;case 305:return}t=e.next()}}return n.contextData={leaders:[]},t=e.next(),function(){for(;!e.isEOF();){switch(t.code){case 0:return;case 340:n.leaderStyleId=t.value;break;case 170:n.leaderLineType=t.value;break;case 91:n.leaderLineColor=t.value;break;case 341:n.leaderLineTypeId=t.value;break;case 171:n.leaderLineWeight=t.value;break;case 41:n.doglegLength=t.value;break;case 290:n.enableLanding=t.value;break;case 291:n.enableDogLeg=t.value;break;case 342:n.arrowHeadId=t.value;break;case 42:n.arrowHeadSize=t.value;break;case 172:n.contentType=t.value;break;case 173:case 95:n.textLeftAttachmentType=t.value;break;case 174:n.textAngleType=t.value;break;case 175:n.textAlignmentType=t.value;break;case 343:n.textStyleId=t.value;break;case 92:n.textColor=t.value;break;case 292:n.enableFrameText=t.value;break;case 344:n.blockContentId=t.value;break;case 93:n.blockContentColor=t.value;break;case 10:n.blockContentScale=Vn(e);break;case 43:n.blockContentRotation=t.value;break;case 176:n.blockContentConnectionType=t.value;break;case 293:n.enableAnotationScale=t.value;break;case 94:n.arrowHeadIndex=t.value;break;case 330:n.blockAttributeId=t.value;break;case 177:n.blockAttributeIndex=t.value;break;case 44:n.blockAttributeWidth=t.value;break;case 302:n.blockAttributeTextString=t.value;break;case 294:n.textDirectionNegative=t.value;break;case 178:n.textAlignInIPE=t.value;break;case 179:n.textAttachmentPoint=t.value;break;case 271:n.textAttachmentDirectionMText=t.value;break;case 272:n.textAttachmentDirectionBottom=t.value;break;case 273:n.textAttachmentDirectionTop=t.value;break;case 300:i();break;default:Rn(n,t,e)}t=e.next()}}(),n}}var si=Object.defineProperty,ri=(e,t,n)=>(((e,t,n)=>{t in e?si(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);let li=class{constructor(){ri(this,"ForEntityName","ELLIPSE")}parseEntity(e,t){const n={type:t.value};for(t=e.next();!e.isEOF()&&0!==t.code;){switch(t.code){case 10:n.center=Vn(e);break;case 11:n.majorAxisEndPoint=Vn(e);break;case 40:n.axisRatio=t.value;break;case 41:n.startAngle=t.value;break;case 42:n.endAngle=t.value;break;case 2:n.name=t.value;break;case 210:n.extrusionDirection=Vn(e);break;default:Rn(n,t,e)}t=e.next()}return n}};var ci=Object.defineProperty,ui=(e,t,n)=>(((e,t,n)=>{t in e?ci(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);let hi=class{constructor(){ui(this,"ForEntityName","INSERT")}parseEntity(e,t){const n={type:t.value};for(t=e.next();!e.isEOF()&&0!==t.code;){switch(t.code){case 2:n.name=t.value;break;case 41:n.xScale=t.value;break;case 42:n.yScale=t.value;break;case 43:n.zScale=t.value;break;case 10:n.position=Vn(e);break;case 50:n.rotation=t.value;break;case 70:n.columnCount=t.value;break;case 71:n.rowCount=t.value;break;case 44:n.columnSpacing=t.value;break;case 45:n.rowSpacing=t.value;break;case 210:n.extrusionDirection=Vn(e);break;default:Rn(n,t,e)}t=e.next()}return n.extrusionDirection&&-1===n.extrusionDirection.z&&(n.position.x=-n.position.x),n}};var di=Object.defineProperty,pi=(e,t,n)=>(((e,t,n)=>{t in e?di(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);let fi=class{constructor(){pi(this,"ForEntityName","LINE")}parseEntity(e,t){const n={type:t.value,vertices:[]};for(t=e.next();!e.isEOF()&&0!==t.code;){switch(t.code){case 10:n.vertices.unshift(Vn(e));break;case 11:n.vertices.push(Vn(e));break;case 210:n.extrusionDirection=Vn(e);break;case 100:break;default:Rn(n,t,e)}0!==n.vertices.length&&n.vertices.forEach(((e,t)=>{if(0===t){const t=e.x+"",i=e.y+"";if(t.split(".").length>1){const e=t.split(".")[0];if(0!==t.split(".")[1].length){const t=100*Number(e);n.offsetX=t}}if(i.split(".").length>1){const e=i.split(".")[0];if(0!==i.split(".")[1].length){const t=100*Number(e);n.offsetY=t}}}})),t=e.next()}return n}};var bi=Object.defineProperty,mi=(e,t,n)=>(((e,t,n)=>{t in e?bi(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);let yi=class{constructor(){mi(this,"ForEntityName","LWPOLYLINE")}parseEntity(e,t){const n={type:t.value,vertices:[]};let i=0;for(t=e.next();!e.isEOF()&&0!==t.code;){switch(t.code){case 38:n.elevation=t.value;break;case 39:n.depth=t.value;break;case 70:n.shape=1==(1&t.value),n.hasContinuousLinetypePattern=128==(128&t.value);break;case 90:i=t.value;break;case 10:n.vertices=xi(i,e);break;case 43:0!==t.value&&(n.width=t.value);break;case 210:n.extrusionDirectionX=t.value;break;case 220:n.extrusionDirectionY=t.value;break;case 230:n.extrusionDirectionZ=t.value;break;default:Rn(n,t,e)}if(0!==n.vertices.length){let e=null,t=null;n.vertices.forEach(((n,i)=>{const a=n.x+"",o=n.y+"";if(a.split(".").length>1){const t=a.split(".")[0];0!==a.split(".")[1].length&&(!e||e<100*Number(t))&&(e=100*Number(t))}if(o.split(".").length>1){const e=o.split(".")[0];0!==o.split(".")[1].length&&(!t||t<100*Number(e))&&(t=100*Number(e))}})),n.offsetX=e,n.offsetY=t}t=e.next()}return n}};function xi(e,t){if(!e||e<=0)throw Error("n must be greater than 0 verticies");const n=[];let i=!1,a=!1,o=t.lastReadGroup;for(let s=0;s<e;s++){const e={};for(;!t.isEOF()&&0!==o.code&&!a;){switch(o.code){case 10:if(i){a=!0;continue}e.x=o.value,i=!0;break;case 20:e.y=o.value;break;case 30:e.z=o.value;break;case 40:e.startWidth=o.value;break;case 41:e.endWidth=o.value;break;case 42:0!=o.value&&(e.bulge=o.value);break;default:return t.rewind(),i&&n.push(e),t.rewind(),n}o=t.next()}n.push(e),i=!1,a=!1}return t.rewind(),n}var vi=Object.defineProperty,gi=(e,t,n)=>(((e,t,n)=>{t in e?vi(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);let wi=class{constructor(){gi(this,"ForEntityName","MTEXT")}parseEntity(e,t){const n={type:t.value};for(t=e.next();!e.isEOF()&&0!==t.code;){switch(t.code){case 3:case 1:n.text?n.text+=t.value:n.text=t.value;break;case 7:n.textStyleName=t.value;break;case 10:n.position=Vn(e);break;case 11:n.directionVector=Vn(e);break;case 40:n.height=t.value;break;case 41:n.width=t.value;break;case 50:n.rotation=t.value;break;case 71:n.attachmentPoint=t.value;break;case 72:n.drawingDirection=t.value;break;case 90:n.backgroundFillSetting=t.value;break;case 100:n.subClassMarker=t.value;break;case 210:n.extrusionDirection=Vn(e);break;default:Rn(n,t,e)}t=e.next()}return n}};var ki=Object.defineProperty,Ei=(e,t,n)=>(((e,t,n)=>{t in e?ki(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);let Si=class{constructor(){Ei(this,"ForEntityName","POINT")}parseEntity(e,t){const n={type:t.value};for(t=e.next();!e.isEOF()&&0!==t.code;){switch(t.code){case 10:n.position=Vn(e);break;case 39:n.thickness=t.value;break;case 210:n.extrusionDirection=Vn(e);break;case 100:break;default:Rn(n,t,e)}t=e.next()}return n}};var Pi=Object.defineProperty,Mi=(e,t,n)=>(((e,t,n)=>{t in e?Pi(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);var Li=Object.defineProperty,Oi=(e,t,n)=>(((e,t,n)=>{t in e?Li(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);let Ai=class{constructor(){Oi(this,"ForEntityName","POLYLINE")}parseEntity(e,t){var n={type:t.value,vertices:[]};for(t=e.next();!e.isEOF()&&0!==t.code;){switch(t.code){case 10:case 20:case 30:case 40:case 41:case 71:case 72:case 73:case 74:case 75:break;case 39:n.thickness=t.value;break;case 70:n.shape=0!=(1&t.value),n.includesCurveFitVertices=0!=(2&t.value),n.includesSplineFitVertices=0!=(4&t.value),n.is3dPolyline=0!=(8&t.value),n.is3dPolygonMesh=0!=(16&t.value),n.is3dPolygonMeshClosed=0!=(32&t.value),n.isPolyfaceMesh=0!=(64&t.value),n.hasContinuousLinetypePattern=0!=(128&t.value);break;case 210:n.extrusionDirection=Vn(e);break;default:Rn(n,t,e)}0!==n.vertices.length&&n.vertices.some(((e,t)=>{if(0===t){const t=e.x+"",i=e.y+"";if(t.split(".").length>1){const e=t.split(".")[0];if(0!==t.split(".")[1].length){const t=100*Number(e);n.offsetX=t}}if(i.split(".").length>1){const e=i.split(".")[0];if(0!==i.split(".")[1].length){const t=100*Number(e);n.offsetY=t}}}if(e.bulge)return n.offsetX=null,n.offsetY=null,!0})),t=e.next()}return n.vertices=function(e,t){const n=new class{constructor(){Mi(this,"ForEntityName","VERTEX")}parseEntity(e,t){var n={type:t.value};for(t=e.next();!e.isEOF()&&0!==t.code;){switch(t.code){case 10:n.x=t.value;break;case 20:n.y=t.value;break;case 30:n.z=t.value;break;case 40:case 41:case 50:break;case 42:0!=t.value&&(n.bulge=t.value);break;case 70:n.curveFittingVertex=0!=(1&t.value),n.curveFitTangent=0!=(2&t.value),n.splineVertex=0!=(8&t.value),n.splineControlPoint=0!=(16&t.value),n.threeDPolylineVertex=0!=(32&t.value),n.threeDPolylineMesh=0!=(64&t.value),n.polyfaceMeshVertex=0!=(128&t.value);break;case 71:n.faceA=t.value;break;case 72:n.faceB=t.value;break;case 73:n.faceC=t.value;break;case 74:n.faceD=t.value;break;default:Rn(n,t,e)}t=e.next()}return n}},i=[];for(;!e.isEOF();)if(0===t.code)if("VERTEX"===t.value)i.push(n.parseEntity(e,t)),t=e.lastReadGroup;else if("SEQEND"===t.value){Ti(e,t);break}return i}(e,t),n}};function Ti(e,t){const n={type:t.value};for(t=e.next();!e.isEOF()&&0!=t.code;)Rn(n,t,e),t=e.next();return n}var Di=Object.defineProperty,Ci=(e,t,n)=>(((e,t,n)=>{t in e?Di(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);let Ni=class{constructor(){Ci(this,"ForEntityName","SOLID")}parseEntity(e,t){const n={type:t.value,points:[]};for(t=e.next();!e.isEOF()&&0!==t.code;){switch(t.code){case 10:n.points[0]=Vn(e);break;case 11:n.points[1]=Vn(e);break;case 12:n.points[2]=Vn(e);break;case 13:n.points[3]=Vn(e);break;case 210:n.extrusionDirection=Vn(e);break;default:Rn(n,t,e)}t=e.next()}return n}};var zi=Object.defineProperty,ji=(e,t,n)=>(((e,t,n)=>{t in e?zi(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);let Ii=class{constructor(){ji(this,"ForEntityName","SPLINE")}parseEntity(e,t){const n={type:t.value};for(t=e.next();!e.isEOF()&&0!==t.code;){switch(t.code){case 10:n.controlPoints||(n.controlPoints=[]),n.controlPoints.push(Vn(e));break;case 11:n.fitPoints||(n.fitPoints=[]),n.fitPoints.push(Vn(e));break;case 12:n.startTangent=Vn(e);break;case 13:n.endTangent=Vn(e);break;case 40:n.knotValues||(n.knotValues=[]),n.knotValues.push(t.value);break;case 70:1&t.value&&(n.closed=!0),2&t.value&&(n.periodic=!0),4&t.value&&(n.rational=!0),8&t.value&&(n.planar=!0),16&t.value&&(n.planar=!0,n.linear=!0);break;case 71:n.degreeOfSplineCurve=t.value;break;case 72:n.numberOfKnots=t.value;break;case 73:n.numberOfControlPoints=t.value;break;case 74:n.numberOfFitPoints=t.value;break;case 210:n.normalVector=Vn(e);break;default:Rn(n,t,e)}t=e.next()}return n}};var Fi=Object.defineProperty,Vi=(e,t,n)=>(((e,t,n)=>{t in e?Fi(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);let Bi=class{constructor(){Vi(this,"ForEntityName","TEXT")}parseEntity(e,t){const n={type:t.value};for(t=e.next();!e.isEOF()&&0!==t.code;){switch(t.code){case 10:n.startPoint=Vn(e);break;case 11:n.endPoint=Vn(e);break;case 40:n.textHeight=t.value;break;case 41:n.xScale=t.value;break;case 50:n.rotation=t.value;break;case 1:n.text=t.value;break;case 72:n.halign=t.value;break;case 73:n.valign=t.value;break;default:Rn(n,t,e)}t=e.next()}return n}};var Ri=Object.defineProperty,_i=(e,t,n)=>(((e,t,n)=>{t in e?Ri(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);let Hi=class{constructor(){_i(this,"ForEntityName","MLINE")}parseEntity(e,t){const n={type:t.value,startPoint:[],vertices:[],directionVector:[],miterDirectionVector:[]};for(t=e.next();!e.isEOF()&&0!==t.code;){switch(t.code){case 2:n.mlineStype=t.value;break;case 10:n.startPoint.push(Vn(e));break;case 11:n.vertices.push(Vn(e));break;case 12:n.directionVector.push(Vn(e));break;case 13:n.miterDirectionVector.push(Vn(e));break;case 40:n.scaleFactor=t.value;break;case 70:n.justification=t.value;break;case 71:n.flags=t.value;break;case 72:n.verticesNum=t.value;break;case 73:n.elementsNum=t.value;break;case 210:n.extrusionDirection=Vn(e);break;case 100:break;default:Rn(n,t,e)}0!==n.vertices.length&&n.vertices.forEach(((e,t)=>{if(0===t){const t=e.x+"",i=e.y+"";if(t.split(".").length>1){const e=t.split(".")[0];if(0!==t.split(".")[1].length){const t=100*Number(e);n.offsetX=t}}if(i.split(".").length>1){const e=i.split(".")[0];if(0!==i.split(".")[1].length){const t=100*Number(e);n.offsetY=t}}}})),t=e.next()}return n}};var Yi=Object.defineProperty,Xi=(e,t,n)=>(((e,t,n)=>{t in e?Yi(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);function Ui(e){e.registerEntityHandler(Yn),e.registerEntityHandler(Wn),e.registerEntityHandler(Jn),e.registerEntityHandler(Qn),e.registerEntityHandler(ni),e.registerEntityHandler(oi),e.registerEntityHandler(li),e.registerEntityHandler(hi),e.registerEntityHandler(fi),e.registerEntityHandler(yi),e.registerEntityHandler(wi),e.registerEntityHandler(Si),e.registerEntityHandler(Ai),e.registerEntityHandler(Ni),e.registerEntityHandler(Ii),e.registerEntityHandler(Bi),e.registerEntityHandler(Hi)}class Gi{constructor(){Xi(this,"_entityHandlers",{}),Ui(this)}parse(e){return"string"==typeof e?this._parse(e):(console.error("Cannot read dxf source of type `"+typeof e),null)}registerEntityHandler(e){const t=new e;this._entityHandlers[t.ForEntityName]=t}parseSync(e){return this.parse(e)}parseStream(e){let t="";const n=this;return new Promise(((i,a)=>{e.on("data",(e=>{t+=e})),e.on("end",(()=>{try{i(n._parse(t))}catch(e){a(e)}})),e.on("error",(e=>{a(e)}))}))}_parse(e){const t={};let n=0;const i=e.split(/\r\n|\r|\n/g),a=new class{constructor(e){jn(this,"_pointer",0),jn(this,"_eof",!1),jn(this,"lastReadGroup"),jn(this,"_data"),this._data=e}next(){if(!this.hasNext())throw this._eof?new Error("Cannot call 'next' after EOF group has been read"):new Error("Unexpected end of input: EOF group not read before end of file. Ended on code "+this._data[this._pointer]);const e={code:parseInt(this._data[this._pointer])};return this._pointer++,e.value=In(e.code,this._data[this._pointer].trim()),this._pointer++,0===e.code&&"EOF"===e.value&&(this._eof=!0),this.lastReadGroup=e,e}peek(){if(!this.hasNext())throw this._eof?new Error("Cannot call 'next' after EOF group has been read"):new Error("Unexpected end of input: EOF group not read before end of file. Ended on code "+this._data[this._pointer]);const e={code:parseInt(this._data[this._pointer])};return e.value=In(e.code,this._data[this._pointer+1].trim()),e}rewind(e=1){this._pointer=this._pointer-2*e}hasNext(){return!(this._eof||this._pointer>this._data.length-2)}isEOF(){return this._eof}}(i);if(!a.hasNext())throw Error("Empty file");const o=this;let s;function r(){let e=null,t=null;const n={};for(s=a.next();;){if(Wi(s,0,"ENDSEC")){e&&(n[e]=t);break}9===s.code?(e&&(n[e]=t),e=s.value):10===s.code?t={x:s.value}:20===s.code?t.y=s.value:30===s.code?t.z=s.value:t=s.value,s=a.next()}return s=a.next(),n}function l(){const e={mlineStyle:{}};for(s=a.next();"ENDSEC"!==s.value;)if(Wi(s,0,"MLINESTYLE")){s=a.next();let t={mlineData:[]};for(;;){switch(s.code){case 2:t.mlineStyleName=s.value;break;case 49:t.mlineData.push(c(s));break;case 51:t.startAngle=s.value;break;case 52:t.endAngle=s.value;break;case 70:t.flags=s.value}if(0===s.code){e.mlineStyle[t.mlineStyleName]=t;break}s=a.next()}}else s=a.next();return e}function c(e){let t={};return e.code,t.elementOffset=e.value,e=a.next(),t.fillColor=e.value,e=a.next(),t.lineType=e.value,t}function u(){const e={};for(s=a.next();"EOF"!==s.value&&!Wi(s,0,"ENDSEC");)if(Wi(s,0,"BLOCK")){const t=h();x(t),t.name?e[t.name]=t:console.log('block with handle "'+t.handle+'" is missing a name.')}else s=a.next();return e}function h(){const e={};for(s=a.next();"EOF"!==s.value;){switch(s.code){case 1:e.xrefPath=s.value,s=a.next();break;case 2:e.name=s.value,s=a.next();break;case 3:e.name2=s.value,s=a.next();break;case 5:e.handle=s.value,s=a.next();break;case 8:e.layer=s.value,s=a.next();break;case 10:e.position=y(s),s=a.next();break;case 67:e.paperSpace=!(!s.value||1!=s.value),s=a.next();break;case 70:0!=s.value&&(e.type=s.value),s=a.next();break;case 100:default:s=a.next();break;case 330:e.ownerHandle=s.value,s=a.next();break;case 0:if("ENDBLK"==s.value)break;e.entities=m(!0)}if(Wi(s,0,"ENDBLK")){s=a.next();break}}for(let t=0;t<e.entities?.length;t++)if(e.position&&0!==e.position.x){const n={x:e.position.x,y:e.position.y};e.entities[t].vertices&&e.entities[t].vertices.forEach((e=>{e.x=n.x-e.x,e.y=n.y-e.y,e.z=n.z-e.z})),e.entities[t].center&&(e.entities[t].center.x=n.x-e.entities[t].center.x,e.entities[t].center.y=n.y-e.entities[t].center.y)}return e}function d(){const e={};for(s=a.next();"EOF"!==s.value&&!Wi(s,0,"ENDSEC");)Wi(s,0,"TABLE")?(s=a.next(),b[s.value]&&(e[b[s.value].tableName]=f(s))):s=a.next();return s=a.next(),e}const p="ENDTAB";function f(e){const t=b[e.value],n={};for(s=a.next();!Wi(s,0,p);)switch(s.code){case 5:n.handle=s.value,s=a.next();break;case 330:n.ownerHandle=s.value,s=a.next();break;case 100:case 70:s.value,s=a.next();break;case 0:s.value===t.dxfSymbolName?n[t.tableRecordsProperty]=t.parseTableRecords():s=a.next();break;default:s=a.next()}const i=n[t.tableRecordsProperty];return i&&(i.constructor===Array?i.length:"object"==typeof i&&Object.keys(i).length),s=a.next(),n}const b={VPORT:{tableRecordsProperty:"viewPorts",tableName:"viewPort",dxfSymbolName:"VPORT",parseTableRecords:function(){const e=[];let t={};for(s=a.next();!Wi(s,0,p);)switch(s.code){case 2:t.name=s.value,s=a.next();break;case 10:t.lowerLeftCorner=y(s),s=a.next();break;case 11:t.upperRightCorner=y(s),s=a.next();break;case 12:t.center=y(s),s=a.next();break;case 13:t.snapBasePoint=y(s),s=a.next();break;case 14:t.snapSpacing=y(s),s=a.next();break;case 15:t.gridSpacing=y(s),s=a.next();break;case 16:t.viewDirectionFromTarget=y(s),s=a.next();break;case 17:t.viewTarget=y(s),s=a.next();break;case 42:t.lensLength=s.value,s=a.next();break;case 43:t.frontClippingPlane=s.value,s=a.next();break;case 44:t.backClippingPlane=s.value,s=a.next();break;case 45:t.viewHeight=s.value,s=a.next();break;case 50:t.snapRotationAngle=s.value,s=a.next();break;case 51:t.viewTwistAngle=s.value,s=a.next();break;case 79:t.orthographicType=s.value,s=a.next();break;case 110:t.ucsOrigin=y(s),s=a.next();break;case 111:t.ucsXAxis=y(s),s=a.next();break;case 112:t.ucsYAxis=y(s),s=a.next();break;case 281:t.renderMode=s.value,s=a.next();break;case 282:t.defaultLightingType=s.value,s=a.next();break;case 292:t.defaultLightingOn=s.value,s=a.next();break;case 330:t.ownerHandle=s.value,s=a.next();break;case 63:case 421:case 431:t.ambientColor=s.value,s=a.next();break;case 0:"VPORT"===s.value&&(e.push(t),t={},s=a.next());break;default:s=a.next()}return e.push(t),e}},LTYPE:{tableRecordsProperty:"lineTypes",tableName:"lineType",dxfSymbolName:"LTYPE",parseTableRecords:function(){const e={};let t,n={},i=0;for(s=a.next();!Wi(s,0,"ENDTAB");)switch(s.code){case 2:n.name=s.value,t=s.value,s=a.next();break;case 3:n.description=s.value,s=a.next();break;case 73:i=s.value,i>0&&(n.pattern=[]),s=a.next();break;case 40:n.patternLength=s.value,s=a.next();break;case 49:n.pattern.push(s.value),s=a.next();break;case 0:i>0&&i!==n.pattern.length&&console.log("lengths do not match on LTYPE pattern"),e[t]=n,n={},s=a.next();break;default:s=a.next()}return e[t]=n,e}},LAYER:{tableRecordsProperty:"layers",tableName:"layer",dxfSymbolName:"LAYER",parseTableRecords:function(){const e={};let t,n={};for(s=a.next();!Wi(s,0,"ENDTAB");)switch(s.code){case 2:n.name=s.value,t=s.value,s=a.next();break;case 62:n.visible=s.value>=0,n.colorIndex=Math.abs(s.value),n.color=(i=n.colorIndex,Fn[i]),s=a.next();break;case 70:n.frozen=0!=(1&s.value)||0!=(2&s.value),s=a.next();break;case 420:n.color=Math.abs(s.value),s=a.next();break;case 0:"LAYER"===s.value&&(e[t]=n,n={},t=void 0,s=a.next());break;default:s=a.next()}var i;return e[t]=n,e}}};function m(e){const t=[],n=e?"ENDBLK":"ENDSEC";for(e||(s=a.next());;)if(0===s.code){if(s.value===n)break;const e=o._entityHandlers[s.value];if(null==e){s=a.next();continue}{const n=e.parseEntity(a,s);s=a.lastReadGroup,x(n),t.push(n)}}else s=a.next();return"ENDSEC"==n&&(s=a.next()),t}function y(e){const t={};let n=e.code;if(t.x=e.value,n+=10,(e=a.next()).code!=n)throw new Error("Expected code for point value to be "+n+" but got "+e.code+".");return t.y=e.value,n+=10,(e=a.next()).code!=n?(a.rewind(),t):(t.z=e.value,t)}function x(e){if(!e)throw new TypeError("entity cannot be undefined or null");e.handle||(e.handle=n++)}return function(){for(s=a.next();!a.isEOF();)if(0===s.code&&"SECTION"===s.value){if(s=a.next(),2!==s.code){console.error("Unexpected code %s after 0:SECTION",(e=s).code+":"+e.value),s=a.next();continue}"HEADER"===s.value?t.header=r():"BLOCKS"===s.value?t.blocks=u():"ENTITIES"===s.value?t.entities=m(!1):"TABLES"===s.value?t.tables=d():"EOF"===s.value?console.log("EOF"):"OBJECTS"===s.value&&(t.objects=l())}else s=a.next();var e}(),t}}function Wi(e,t,n){return e.code===t&&e.value===n}const qi=e=>{let t=new Float32Array(16);var n=Math.sin(e),i=Math.cos(e);return t[0]=i,t[1]=n,t[2]=0,t[3]=0,t[4]=-n,t[5]=i,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},$i=(e,t)=>{let n=[];for(let i=0;i<e.length;i+=3){let a=e[i],o=e[i+1],s=e[i+2];if(null!==a&&null!==o&&null!==s){let e=[];e.push(t[0]*a+t[4]*o+t[8]*s+1*t[12]),e.push(t[1]*a+t[5]*o+t[9]*s+1*t[13]),e.push(t[2]*a+t[6]*o+t[10]*s+1*t[14]),n.push(...e)}}return n};var Ji=Object.defineProperty,Ki=(e,t,n)=>(((e,t,n)=>{t in e?Ji(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);const Zi=(e,t)=>{let n=null;if(e.color)n=e.color;else if(0===e.colorIndex)n=16777215;else if(t.tables&&t.tables.layer&&t.tables.layer.layers[e.layer]){const{visible:i,frozen:a}=t.tables.layer.layers[e.layer];if(!i||a)return null;n=t.tables.layer.layers[e.layer].color}const{type:i,extendColor:a,blockColor:o,layerColor:s,layer:r}=e;return(0===e.color||"MTEXT"===i)&&(a&&"byBlock"===a?n=o:a&&"byLayer"===a&&(n=s)),void 0===e.color&&void 0===e.colorIndex&&"0"===r&&s&&(n=s),n};class Qi{constructor(e=0,t=0){Ki(this,"x"),Ki(this,"y"),this.x=e,this.y=t}distanceTo(e){return Math.sqrt(this.distanceToSquared(e))}distanceToSquared(e){const t=this.x-e.x,n=this.y-e.y;return t*t+n*n}sub(e){return this.x-=e.x,this.y-=e.y,this}normalize(){return this.divideScalar(this.length()||1)}divideScalar(e){return this.multiplyScalar(1/e)}multiplyScalar(e){return this.x*=e,this.y*=e,this}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}}class ea extends Qi{constructor(e=0,t=0,n=0){super(e,t),Ki(this,"z"),this.z=n}distanceTo(e){return Math.sqrt(this.distanceToSquared(e))}distanceToSquared(e){const t=this.x-e.x,n=this.y-e.y,i=this.z-e.z;return t*t+n*n+i*i}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this}normalize(){return this.divideScalar(this.length()||1)}divideScalar(e){return this.multiplyScalar(1/e)}multiplyScalar(e){return this.x*=e,this.y*=e,this.z*=e,this}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this}cross(e){return this.crossVectors(this,e)}crossVectors(e,t){const n=e.x,i=e.y,a=e.z,o=t.x,s=t.y,r=t.z;return this.x=i*r-a*s,this.y=a*o-n*r,this.z=n*s-i*o,this}}var ta=Object.defineProperty,na=(e,t,n)=>(((e,t,n)=>{t in e?ta(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);let ia=class{constructor(){na(this,"position",[]),na(this,"color",16777215),na(this,"positions",[]),na(this,"colors",[])}flatPosition(e){let t=[];return e.forEach((e=>{t.push(e.x,e.y,0)})),t}changeToLineSegments(e){if(e.length>6){const t=e.length/3;let n=0;for(let i=1;i<t-1;i++){const t=3*i+3*n;e.splice(t,0,e[t],e[t+1],e[t+2]),n++}}else if(3===e.length)return[];return e}fillColor(e,t){this.colors=[];for(let n=0;n<e.length/3;n++)this.colors.push(t.r,t.g,t.b)}getMaxOrMinPositionArray(){if(1===this.position.length)return null;let e={max:new Qi(0,0),min:new Qi(0,0)};return this.position.forEach(((t,n)=>{0===n?(e.max.x=t.x,e.min.x=t.x,e.max.y=t.y,e.min.y=t.y):(e.min.x>t.x&&(e.min.x=t.x),e.min.y>t.y&&(e.min.y=t.y),e.max.x<t.x&&(e.max.x=t.x),e.max.y<t.y&&(e.max.y=t.y))})),e}};var aa=Object.defineProperty,oa=(e,t,n)=>(((e,t,n)=>{t in e?aa(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);const sa=(e,t)=>{let n=new Qi(e.x,e.y),i=new Qi(t.x,t.y);return i.sub(n),i.normalize(),i.y<0?-Math.acos(i.x):Math.acos(i.x)},ra=(e,t,n)=>{let i=new Qi;return i.x=e.x+t*Math.cos(n),i.y=e.y+t*Math.sin(n),i},la=(e,t,n,i)=>{let a=e?new ea(e.x,e.y,0):new ea(0,0,0),o=t?new ea(t.x,t.y,0):new ea(1,0,0);n=n||1;let s=4*Math.atan(n),r=a.distanceTo(o)/2/Math.sin(s/2),l=ra(e,r,sa(a,o)+(Math.PI/2-s/2));i=i||Math.max(Math.abs(Math.ceil(s/(Math.PI/18))),6);let c=sa(l,a),u=s/i,h=[];h.push(new ea(a.x,a.y,0));for(let e=1;e<=i-1;e++){let t=ra(l,Math.abs(r),c+u*e);h.push(new ea(t.x,t.y,0))}return[e,...h,t]};let ca=class extends ia{constructor(t,n,i){if(super(),oa(this,"type","Line"),oa(this,"color",16777215),oa(this,"layer","0"),oa(this,"position",[]),oa(this,"positions",[]),oa(this,"isDashed",!1),oa(this,"box"),oa(this,"offsetX"),oa(this,"offsetY"),oa(this,"lineTypeScale"),oa(this,"lineTypeData"),oa(this,"shape"),oa(this,"mlineOffset",1),oa(this,"scaleFactor"),"MLINE"===t.type){const e=n.objects.mlineStyle[t.mlineStype];t.mlineOffset=Math.abs(e.mlineData[0].elementOffset-e.mlineData[1].elementOffset)}if(this.color=Zi(t,n),this.type=t.type,this.offsetX=t.offsetX,this.offsetY=t.offsetY,this.layer=t.layer,this.lineTypeScale=t.lineTypeScale,this.shape=t.shape,this.mlineOffset=t.mlineOffset,this.scaleFactor=t.scaleFactor,t.vertices)for(let e=0;e<t.vertices.length;e++){let n=t.vertices[e];if("number"==typeof n.x&&"number"==typeof n.y)if(-1===t.extrusionDirection?.z&&t.vertices[e].type&&(n.x=-n.x),n.bulge){let i=n.bulge;if(e+1===t.vertices.length&&!t.shape)break;let a=new ea(n.x,n.y,0),o=e+1<t.vertices.length?t.vertices[e+1]:t.vertices[0];o.z=0;let s=la(a,o,i);this.position.push.apply(this.position,s)}else this.position.push(new ea(n.x,n.y,0))}let a;if(t.shape&&0!==this.position.length&&this.position.push(this.position[0]),t.lineType&&(a=n.tables.lineType.lineTypes[t.lineType]),a&&a.pattern&&0!==a.pattern.length&&(this.lineTypeData=a,this.isDashed=!0),"MLINE"===this.type){const t=new e.Vector3(1,0,0),n=new e.Vector3(this.position[1].x-this.position[0].x,this.position[1].y-this.position[0].y,this.position[1].z-this.position[0].z);let i=Math.PI/2-t.angleTo(n);const a=this.scaleFactor;let o=this.mlineOffset*Math.cos(i)*a,s=-this.mlineOffset*Math.sin(i)*a;this.position[1].y-this.position[0].y<0&&(o=-o,s=-s);let r=[];this.position.forEach((e=>{r.push(new ea(e.x+o,e.y+s,0))}));const l=this.flatPosition(r),c=this.flatPosition(this.position);this.positions.push({index:0,positions:c}),this.positions.push({index:1,positions:l}),this.box=this.getMaxOrMinPositionArray()}else this.box=this.getMaxOrMinPositionArray(),this.positions=this.flatPosition(this.position)}};var ua=Object.defineProperty,ha=(e,t,n)=>(((e,t,n)=>{t in e?ua(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);let da=class{constructor(e,t,n){ha(this,"type","Text"),ha(this,"color",16777215),ha(this,"layer","0"),ha(this,"position"),ha(this,"rotation",0),ha(this,"text"),ha(this,"textHeight",12),ha(this,"box"),ha(this,"insertNum",-1),this.color=Zi(e,t),this.type=e.type,this.insertNum=n,this.layer=e.layer,e.rotation&&(this.rotation=e.rotation*Math.PI/180),"ATTDEF"===this.type?this.text=e.tag:this.text=e.text,this.textHeight=e.textHeight,this.position=e.startPoint,this.box=this.getMaxOrMinPosition()}getMaxOrMinPosition(){let e={max:new Qi(0,0),min:new Qi(0,0)};return e.max.x=this.position.x,e.min.x=this.position.x,e.max.y=this.position.y,e.min.y=this.position.y,e}};var pa=Object.defineProperty,fa=(e,t,n)=>(((e,t,n)=>{t in e?pa(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);class ba extends ia{constructor(e,t,n){let i,a;super(),fa(this,"type","Arc"),fa(this,"color",16777215),fa(this,"layer","0"),fa(this,"position",[]),fa(this,"offsetX"),fa(this,"offsetY"),fa(this,"box"),this.color=Zi(e,t),this.type=e.type,this.offsetX=e.offsetX,this.offsetY=e.offsetY,this.layer=e.layer,"CIRCLE"===this.type?(i=e.startAngle||0,a=i+2*Math.PI):(i=e.startAngle,a=e.endAngle);let o=new class{constructor(e=0,t=0,n=1,i=1,a=0,o=2*Math.PI){fa(this,"aX"),fa(this,"aY"),fa(this,"xRadius"),fa(this,"yRadius"),fa(this,"aStartAngle"),fa(this,"aEndAngle"),this.aX=e,this.aY=t,this.xRadius=n,this.yRadius=i,this.aStartAngle=a,this.aEndAngle=o}getPoint(e){const t=2*Math.PI;let n=this.aEndAngle-this.aStartAngle;const i=Math.abs(n)<Number.EPSILON;for(;n<0;)n+=t;for(;n>t;)n-=t;n<Number.EPSILON&&(n=i?0:t);const a=this.aStartAngle+e*n;let o=this.aX+this.xRadius*Math.cos(a),s=this.aY+this.yRadius*Math.sin(a);return new ea(o,s)}getPoints(e=5){const t=[];for(let n=0;n<=e;n++)t.push(this.getPoint(n/e));return t}}(0,0,e.radius,e.radius,i,a);this.position=o.getPoints(50),this.position.forEach((t=>{e.center&&(t.x=t.x+e.center.x,t.y=t.y+e.center.y),-1===e.extrusionDirectionZ&&(t.x=-t.x)})),this.box=this.getMaxOrMinPositionArray(),this.positions=this.flatPosition(this.position)}}var ma=Object.defineProperty,ya=(e,t,n)=>(((e,t,n)=>{t in e?ma(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);const xa=(e,t,n,i)=>{let a=new ea,o=new ea;a.subVectors(n,t),o.subVectors(i,t),a.cross(o);let s=new ea(t.x,t.y,t.z),r=new ea(n.x,n.y,n.z),l=new ea(i.x,i.y,i.z);a.z<0?e.push(l,r,s):e.push(s,r,l)};var va=Object.defineProperty,ga=(e,t,n)=>(((e,t,n)=>{t in e?va(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);var wa=Object.defineProperty,ka=(e,t,n)=>(((e,t,n)=>{t in e?wa(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);const Ea=(e,t)=>typeof t>"u"||0==+t?Math.round(e):(e=+e,t=+t,isNaN(e)||"number"!=typeof t||t%1!=0?NaN:(e=e.toString().split("e"),+((e=(e=Math.round(+(e[0]+"e"+(e[1]?+e[1]-t:-t)))).toString().split("e"))[0]+"e"+(e[1]?+e[1]+t:t)))),Sa=(e,t,n,i,a)=>{const o=n.length,s=n[0].length;if(e<0||e>1)throw new Error("t out of bounds [0,1]: "+e);if(t<1)throw new Error("degree must be at least 1 (linear)");if(t>o-1)throw new Error("degree must be less than or equal to point count - 1");if(!a){a=[];for(let e=0;e<o;e++)a[e]=1}if(i){if(i.length!==o+t+1)throw new Error("bad knot vector length")}else{i=[];for(let e=0;e<o+t+1;e++)i[e]=e}const r=[t,i.length-1-t],l=i[r[0]],c=i[r[1]];let u;for(e=e*(c-l)+l,e=Math.max(e,l),e=Math.min(e,c),u=r[0];u<r[1]&&!(e>=i[u]&&e<=i[u+1]);u++);const h=[];for(let e=0;e<o;e++){h[e]=[];for(let t=0;t<s;t++)h[e][t]=n[e][t]*a[e];h[e][s]=a[e]}let d;for(let n=1;n<=t+1;n++)for(let a=u;a>u-t-1+n;a--){d=(e-i[a])/(i[a+t+1-n]-i[a]);for(let e=0;e<s+1;e++)h[a][e]=(1-d)*h[a-1][e]+d*h[a][e]}const p=[];for(let e=0;e<s;e++)p[e]=Ea(h[u][e]/h[u][s],-9);return p};var Pa=Object.defineProperty,Ma=(e,t,n)=>(((e,t,n)=>{t in e?Pa(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);var La=Object.defineProperty,Oa=(e,t,n)=>(((e,t,n)=>{t in e?La(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);const Aa=(e,t)=>{if(!Zi(e,t))return;const{center:n,majorAxisEndPoint:i,axisRatio:a,startAngle:o,endAngle:s}=e;let r=((e,t,n,i,a,o)=>{let s,r=[];s=i<0?{x:t.x*Math.cos(Math.abs(i))-t.y*Math.sin(Math.abs(i)),y:t.x*Math.sin(Math.abs(i))+t.y*Math.cos(Math.abs(i))}:{x:t.x*Math.cos(2*Math.PI-i)-t.y*Math.sin(2*Math.PI-i),y:t.x*Math.sin(2*Math.PI-i)+t.y*Math.cos(2*Math.PI-i)};for(let e=0;e<=50;e++){let t=e/50*Math.abs(a-i);const o=new ea;let l=2*Math.PI-t;const{x:c,y:u}=s;o.x=c*Math.cos(l)-u*Math.sin(l),o.y=(c*Math.sin(l)+u*Math.cos(l))*n,o.z=0,r.push(o)}return r})(0,i,a,o,s);return r.forEach((t=>{e.center&&(t.x=t.x+e.center.x,t.y=t.y+e.center.y),e.offsetX&&e.offsetY&&(t.x=100*t.x-e.offsetX,t.y=100*t.y-e.offsetY)})),r};var Ta=Object.defineProperty,Da=(e,t,n)=>(((e,t,n)=>{t in e?Ta(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);const Ca={d:"°",c:"⌀",p:"±"},Na=(e,t)=>{e=e.replace(/%%(.)/g,((e,t)=>Ca[t]||t));const n=t?.encoding;let i,a=n instanceof TextDecoder?n:void 0,o="";const s=[],r=e=>{o&&(s.push(o),o=""),s.push(e)};for(let t=0;t<e.length;t++)switch(i=e[t]){default:o+=i;break;case"\\":switch(i=e[++t]){default:o+=i;break;case"P":o+="\n";break;case"f":case"F":{let n="";for(;i=e[++t];){if(";"===i){r({f:n});break}if("|"===i){const i={f:n},a=e.indexOf(";",++t);for(const n of e.slice(t,a).split("|"))i[n[0]]=+n.slice(1);t=a,r(i);break}n+="\\"===i?e[++t]:i}break}case"S":{let n,a="",o="";for(;i=e[++t];){if(";"===i){n&&r({S:[a,n,o]});break}"\\"===i?n?o+=e[++t]:a+=e[++t]:n?o+=i:"^"===i||"/"===i||"#"===i?n=i:a+=i}break}case"H":case"W":const s=++t,[,l,c]=e.slice(s,t=e.indexOf(";",t)).match(/^(\d*(?:\.\d+)?)(\D*)$/);r({[i]:[+l,c]});break;case"Q":case"A":case"C":case"T":{const n=++t;r({[i]:+e.slice(n,t=e.indexOf(";",t))});break}case"L":case"O":case"K":r({[i]:1});break;case"l":case"o":case"k":r({[i.toUpperCase()]:0});break;case"U":case"u":"+"===e[t+1]?(o+=String.fromCodePoint(parseInt(e.substr(t+2,4),16)),t+=5):o+=i;break;case"M":case"m":n?"+"===e[t+1]&&"1"===e[t+2]?(o+=(a=a||new TextDecoder(n)).decode(new Uint8Array([parseInt(e.substr(t+3,2),16),parseInt(e.substr(t+5,2),16)])),t+=6):o+=i:o+="\\"+i}break;case"{":{let n=1;const a=t;for(;i=e[++t];)if("{"===i)n++;else if("}"===i){if(0==--n){r(Na(e.slice(a+1,t)));break}}else"\\"===i&&t++;break}}return o&&s.push(o),s};var za=Object.defineProperty,ja=(e,t,n)=>(((e,t,n)=>{t in e?za(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);const Ia=(e,t,n,i)=>{let a={horizontalAlignment:"left",textHeight:t},o=[];for(let n of e)if("string"==typeof n)n.startsWith("pxq")&&n.endsWith(";")?-1!==n.indexOf("c")?a.horizontalAlignment="center":-1!==n.indexOf("l")?a.horizontalAlignment="left":-1!==n.indexOf("r")?a.horizontalAlignment="right":-1!==n.indexOf("j")&&(a.horizontalAlignment="justify"):o.push(n);else if(Array.isArray(n)){let e=Ia(n,t);o.push(e.text)}else"object"==typeof n&&n.S&&3===n.S.length&&o.push(n.S[0]+"/"+n.S[2]);return{text:o.join(""),style:a}};class Fa{constructor(t){ja(this,"type","MText"),ja(this,"color",16777215),ja(this,"layer","0"),ja(this,"position"),ja(this,"rotation",0),ja(this,"directionVector"),ja(this,"extrusionDirection"),ja(this,"attachmentPoint"),ja(this,"text"),ja(this,"style"),ja(this,"width"),ja(this,"height"),ja(this,"textHeight",12),ja(this,"isIncludeReBarMark",!1),ja(this,"rebarArr",["%%130","%%131","%%132","%%133"]),ja(this,"rebarMark",{"%%130":"A","%%131":"B","%%132":"C","%%133":"D"}),ja(this,"rebarReg",/(.*)(%%130|%%131|%%132|%%133)(.*)/g),ja(this,"createTextForScene",((t,n,i,a,o,s)=>{if(!t)return null;this.isIncludeReBarMark&&(t=this.clearRebarText(t));let r=new A;if(r.text=t.replaceAll("\\P","\n").replaceAll("\\X","\n"),r.font=s&&"reBarMark"===s?`${Zt}`:`${Qt}`,r.fontSize=n.textHeight,this.textHeight=n.textHeight,r.maxWidth=this.width,r.position.x=o.x,r.position.y=o.y,r.position.z=o.z,r.textAlign=n.horizontalAlignment,r.color=i,this.rotation&&"MTEXT"===a?r.rotation.z=this.rotation*Math.PI/180:this.rotation&&(r.rotation.z=this.rotation),this.directionVector){let t=this.directionVector,n=new e.Vector3(1,0,0).angleTo(new e.Vector3(t.x,t.y,t.z));const{x:i,y:a}=this.directionVector;i>0&&a<0||i<0&&a<0?r.rotateZ(2*Math.PI-n):r.rotateZ(n)}switch(-1===this.extrusionDirection?.z&&r.scale.set(1,-1,1),this.attachmentPoint){case 1:r.anchorX="left",r.anchorY="top";break;case 2:r.anchorX="center",r.anchorY="top";break;case 3:r.anchorX="right",r.anchorY="top";break;case 4:r.anchorX="left",r.anchorY="middle";break;case 5:r.anchorX="center",r.anchorY="middle";break;case 6:r.anchorX="right",r.anchorY="middle";break;case 7:r.anchorX="left",r.anchorY="bottom";break;case 8:r.anchorX="center",r.anchorY="bottom";break;case 9:r.anchorX="right",r.anchorY="bottom";break;default:return}return r.sync((()=>{if("left"!==r.textAlign){r.geometry.computeBoundingBox();let e=r.geometry.boundingBox.max.x-r.geometry.boundingBox.min.x;"center"===r.textAlign&&(r.position.x+=(this.width-e)/2),"right"===r.textAlign&&(r.position.x+=this.width-e)}})),r})),this.type=t.type,this.color=t.color,this.layer=t.layer,this.position=t.position,this.rotation=t.rotation,this.text=t.text,this.directionVector=t.directionVector,this.extrusionDirection=t.extrusionDirection,this.attachmentPoint=t.attachmentPoint,this.style=t.style,this.width=t.width,this.height=t.height?t.height:t.textHeight,this.text.includes("25")&&this.text.includes("6")&&this.text.includes("")&&(this.text=this.text.replace("","%%132"));const n=this.rebarArr.findIndex((e=>this.text.includes(e)));this.isIncludeReBarMark=-1!==n}clearRebarText(e){return this.rebarReg.test(e)?(e=e.replace(this.rebarReg,"$1   $3"),this.clearRebarText(e)):e}setRebarText(t,n){const i=t.text.replace(this.rebarReg,"$1");let a=i.match(/\d/g),o=a?a.length:0;const s=t.text.replace(this.rebarReg,"$1   $3");let r=new e.Vector3;this.rotation?(r.x=this.position.x+this.height*(i.length-.85*o)*1*Math.cos(this.rotation),r.y=this.position.y+this.height*(i.length-.85*o)*1*Math.sin(this.rotation)):(i.length-o>3?r.x=this.position.x+this.height*(i.length-.85*o)*1:r.x=this.position.x+this.height*(i.length-.1*o)*1,r.y=this.position.y);let l=t.text.replace(this.rebarReg,"$2");l=l.replace(/(%%130|%%131|%%132|%%133)/g,(e=>this.rebarMark[e]));let c=this.createTextForScene(l,t.style,this.color,n,r,"reBarMark");if(this.rebarReg.test(s)){t={text:s,style:{horizontalAlignment:"left",textHeight:this.height}};return[c,...this.setRebarText(t,n)]}return[c]}draw(t){let n,i;if("TEXT"===t||"ATTDEF"===t)this.attachmentPoint=7,i={text:this.text,style:{horizontalAlignment:"left",textHeight:this.height}},n=this.createTextForScene(i.text,i.style,this.color,t,this.position);else{let e=Na(this.text);i=Ia(e,this.height,this.color),n=this.createTextForScene(i.text,i.style,this.color,t,this.position)}let a=new e.Object3D;return a.layer=this.layer,a.add(n),this.isIncludeReBarMark&&this.setRebarText(i,t).forEach((e=>a.add(e))),((e,t,n,i)=>{Nn.push({text:e,position:t,textHeight:n,boundingBox:i})})(n.text,this.position,this.textHeight,n.geometry.boundingBox),a}}const Va={LINE:ca,LWPOLYLINE:ca,POLYLINE:ca,MLINE:ca,CIRCLE:ba,ARC:ba,SOLID:class extends ia{constructor(e,t,n){super(),ya(this,"type","Solid"),ya(this,"color",16777215),ya(this,"layer","0"),ya(this,"position",[]),ya(this,"box"),ya(this,"offsetX"),ya(this,"offsetY"),this.color=Zi(e,t),this.type=e.type,this.offsetX=e.offsetX,this.offsetY=e.offsetY,this.layer=e.layer;let i=e.points;0!==i?.length&&(xa(this.position,i[0],i[1],i[2]),xa(this.position,i[1],i[2],i[3])),this.positions=this.flatPosition(this.position),this.box=this.getMaxOrMinPositionArray()}},POINT:class{constructor(e,t,n){ga(this,"type","Point"),ga(this,"color",16777215),ga(this,"layer","0"),ga(this,"position"),ga(this,"offsetX"),ga(this,"offsetY"),this.color=Zi(e,t),this.type=e.type,this.offsetX=e.offsetX,this.offsetY=e.offsetY,this.position=e.position,this.layer=e.layer}},SPLINE:class extends ia{constructor(e,t,n){super(),ka(this,"type","Spline"),ka(this,"color",16777215),ka(this,"layer","0"),ka(this,"position",[]),ka(this,"box"),ka(this,"offsetX"),ka(this,"offsetY"),this.color=Zi(e,t),this.type=e.type,this.offsetX=e.offsetX,this.offsetY=e.offsetY,this.layer=e.layer,this.position=((e,t,n,i)=>{const a=[],o=e.map((function(e){return[e.x,e.y]})),s=[n[t]],r=[n[t],n[n.length-1-t]];for(let e=t+1;e<n.length-t;++e)s[s.length-1]!==n[e]&&s.push(n[e]);i=i||25;for(let e=1;e<s.length;++e){const l=s[e-1],c=s[e];for(let e=0;e<=i;++e){let s=(e/i*(c-l)+l-r[0])/(r[1]-r[0]);s=Math.max(s,0),s=Math.min(s,1);const u=Sa(s,t,o,n);a.push(new ea(u[0],u[1]))}}return a})(e.controlPoints,e.degreeOfSplineCurve,e.knotValues,100),this.box=this.getMaxOrMinPositionArray(),this.positions=this.flatPosition(this.position)}},ELLIPSE:class extends ia{constructor(e,t,n){if(super(),Oa(this,"type","Ellipse"),Oa(this,"color",16777215),Oa(this,"layer","0"),Oa(this,"position",[]),Oa(this,"box"),Oa(this,"offsetX"),Oa(this,"offsetY"),this.color=Zi(e,t),this.type=e.type,this.offsetX=e.offsetX,this.offsetY=e.offsetY,this.layer=e.layer,e.extrusionDirection&&1===e.extrusionDirection.z){let t,n,i;e.majorAxisEndPoint&&e.axisRatio&&(t=Math.sqrt(Math.pow(e.majorAxisEndPoint.x,2)+Math.pow(e.majorAxisEndPoint.y,2)),n=t*e.axisRatio,i=Math.atan2(e.majorAxisEndPoint.y,e.majorAxisEndPoint.x));let a=new class{constructor(e=0,t=0,n=1,i=1,a=0,o=2*Math.PI,s=!1,r=0){Oa(this,"aX"),Oa(this,"aY"),Oa(this,"xRadius"),Oa(this,"yRadius"),Oa(this,"aStartAngle"),Oa(this,"aEndAngle"),Oa(this,"aClockwise"),Oa(this,"aRotation"),this.aX=e,this.aY=t,this.xRadius=n,this.yRadius=i,this.aStartAngle=a,this.aEndAngle=o,this.aClockwise=s,this.aRotation=r}getPoint(e){const t=2*Math.PI;let n=this.aEndAngle-this.aStartAngle;const i=Math.abs(n)<Number.EPSILON;for(;n<0;)n+=t;for(;n>t;)n-=t;n<Number.EPSILON&&(n=i?0:t),!0===this.aClockwise&&!i&&(n===t?n=-t:n-=t);const a=this.aStartAngle+e*n;let o=this.aX+this.xRadius*Math.cos(a),s=this.aY+this.yRadius*Math.sin(a);if(0!==this.aRotation){const e=Math.cos(this.aRotation),t=Math.sin(this.aRotation),n=o-this.aX,i=s-this.aY;o=n*e-i*t+this.aX,s=n*t+i*e+this.aY}return new ea(o,s)}getPoints(e=5){const t=[];for(let n=0;n<=e;n++)t.push(this.getPoint(n/e));return t}}(0,0,t,n,e.startAngle,e.endAngle,!1,i);this.position=a.getPoints(50),this.position.forEach((t=>{e.center&&(t.x=t.x+e.center.x,t.y=t.y+e.center.y)}))}else this.position=Aa(e,t);this.box=this.getMaxOrMinPositionArray(),this.positions=this.flatPosition(this.position)}},MTEXT:class{constructor(e,t,n){Ma(this,"type","MText"),Ma(this,"color",16777215),Ma(this,"layer","0"),Ma(this,"width"),Ma(this,"position"),Ma(this,"rotation"),Ma(this,"directionVector"),Ma(this,"extrusionDirection"),Ma(this,"attachmentPoint"),Ma(this,"text"),Ma(this,"style"),Ma(this,"box"),Ma(this,"insertNum",-1),Ma(this,"height"),this.color=Zi(e,t),this.type=e.type,this.width=e.width,this.position=e.position,this.directionVector=e.directionVector,this.extrusionDirection=e.extrusionDirection,this.position=e.position,this.rotation=e.rotation,this.attachmentPoint=e.attachmentPoint,this.insertNum=n,this.layer=e.layer,this.text=e.text,this.height=e.height,this.box=this.getMaxOrMinPosition()}getMaxOrMinPosition(){let e={max:new Qi(0,0),min:new Qi(0,0)};return e.max.x=this.position.x,e.min.x=this.position.x,e.max.y=this.position.y,e.min.y=this.position.y,e}},TEXT:da,ATTDEF:da},Ba={POINT:class{constructor(e){Da(this,"type","Point"),Da(this,"color",16777215),Da(this,"layer","0"),Da(this,"position"),this.type=e.type,this.color=e.color,this.layer=e.layer,this.position=e.position}draw(){let t=new E;const{x:n,y:i,z:o}=this.position,{offsetX:s,offsetY:r}=(e=>{let t=0,n=0;const i=e[0]+"",a=e[1]+"";if(i.split(".").length>1){const e=i.split(".")[0];0!==i.split(".")[1].length&&(t=100*Number(e))}if(a.split(".").length>1){const e=a.split(".")[0];0!==a.split(".")[1].length&&(n=100*Number(e))}return{offsetX:t,offsetY:n}})([n,i,o]);if(s&&r){const a=((e,t,n)=>e.map(((e,i)=>i%3==0?100*e-t:i%3==1?100*e-n:e)))([n,i,o],s,r);t.setAttribute("position",new e.Float32BufferAttribute(a,3))}else t.setAttribute("position",new a([n,i,o],3));let l=new e.PointsMaterial({size:.1,color:this.color}),c=new e.Points(t,l);if(s&&r){let e=s?s/100:0,t=r?r/100:0;c.position.set(e,t,0);const n=.01;c.scale.set(n,n,n)}return c.layer=this.layer,c}},MTEXT:Fa,TEXT:Fa,ATTDEF:Fa};let Ra,_a=["LINE","LWPOLYLINE","POLYLINE","ELLIPSE","ARC","CIRCLE","SPLINE","MLINE","SOLID"];const Ha=e=>{Ra=e,console.log("原始dxf数据",e);let t=[],n=[],i=null;for(let a=0;a<e.entities?.length;a++){const{type:o,dimensionType:s}=e.entities[a],r=e.entities[a];if(!1===r.visible||r.inPaperSpace)continue;const{visible:l,frozen:c}=Ra.tables.layer.layers[r.layer];if(!1===l||!0===c)continue;let u=null;if("DIMENSION"===o||"INSERT"===o){if("DIMENSION"===o&&7&s)continue;const e=Ya(r,a);e.models&&0!==e.models.length&&t.push(...e.models),n.push(...e.groupArr)}else if(_a.includes(o)){const e=new Va[o](r,Ra,a);e.pixelIndex=a,u=e.box,t.push(e)}else if(Va[o]){const e=new Va[o](r,Ra,a);let t=new Ba[o](e).draw(o);n.push(t)}else console.log("解析到shape过程未处理的类型",o);u&&!i?i=u:u&&i&&(i.min.x>u.min.x&&(i.min.x=u.min.x),i.min.y>u.min.y&&(i.min.y=u.min.y),i.max.x<u.max.x&&(i.max.x=u.max.x),i.max.y<u.max.y&&(i.max.y=u.max.y))}return null===i&&(i={max:new Qi(t[0].positions[0],t[0].positions[1]),min:new Qi(t[0].positions[0]-10,t[0].positions[1]-10)}),e=null,{models:t,box:i,group:n}},Ya=(e,t)=>{let n,i;n="0"===e.layer&&e.layerColor?e.layerColor:Ra.tables.layer.layers[e.layer].color,i=void 0!==e.color||void 0!==e.colorIndex||e.blockColor?e.color?e.color:e.blockColor:n;let a={scale:{x:null,y:null,z:null},rotation:null,position:null};e.xScale&&(a.scale.x=e.xScale),e.yScale&&(a.scale.y=e.yScale),e.zScale&&(a.scale.z=e.zScale),e.rotation&&(a.rotation=e.rotation),e.position&&(a.position=e.position);let o,s=[],r=[];o="INSERT"===e.type?Ra.blocks[e.name]:Ra.blocks[e.block];for(let l=0;l<o.entities?.length;l++){const c=o.entities[l],{type:u,dimensionType:h,colorIndex:d,color:p}=c;if(!1===c.visible)continue;const{visible:f,frozen:b}=Ra.tables.layer.layers[c.layer];if(!1!==f&&!0!==b)if((!p||"MTEXT"===u)&&(0===d&&i?(c.blockColor=i,c.extendColor="byBlock"):0!==d||i?(c.layerColor=n,c.extendColor="byLayer"):(c.blockColor=16777215,c.extendColor="byBlock")),"0"===c.layer&&(e.layer.includes(" @ ")?c.layer=e.layer.split(" @ ")[0]:c.layer=e.layer),"DIMENSION"===u||"INSERT"===u){if("DIMENSION"===u&&7&h)continue;const e=Ya(c,t);e.models.forEach((e=>{e.positions=Ua(e.positions,a),s.push(e)})),Ga(e.groupArr,a),r.push(...e.groupArr)}else if(_a.includes(u)){const e=new Va[u](c,Ra,t);e.pixelIndex=t,e.positions=Ua(e.positions,a),s.push(e)}else if(Va[u]){const e=new Va[u](c,Ra,l);let t=new Ba[u](e).draw(u);Ga([t],a),r.push(t)}else console.log("解析到shape过程未处理的类型",u)}return{models:s,groupArr:r}},Xa=(e,t)=>{const{scale:n,rotation:i,position:a}=t;if(n){let t=1,i=1;n.x&&(t=n.x),n.y&&(i=n.y),n.z&&-1===n.z&&(t=-t);const a=((e,t,n)=>{let i=new Float32Array(16);return i[0]=e,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=t,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=n,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i})(t,i,0);e=$i(e,a)}if(i)if(n.z&&-1===n.z){const t=qi(-i*Math.PI/180);e=$i(e,t)}else{const t=qi(i*Math.PI/180);e=$i(e,t)}if(a){const t=((e,t,n)=>{let i=new Float32Array(16);for(let e=0;e<12;e++)i[e]=e%5==0?1:0;return i[12]=e||0,i[13]=t||0,i[14]=n||0,i[15]=1,i})(a.x,a.y,0);e=$i(e,t)}return e},Ua=(e,t)=>"object"==typeof e[0]?(e.forEach((e=>{e.positions=Xa(e.positions,t)})),e):Xa(e,t),Ga=(e,t)=>{e.forEach((e=>{const{scale:n,rotation:i,position:a}=t;n&&(n.x&&(e.scale.x=n.x),n.y&&(e.scale.y=n.y),n.z&&-1===n.z&&(e.scale.x=-e.scale.x)),i&&(n.z&&-1===n.z?e.rotation.z=-i*Math.PI/180:e.rotation.z=i*Math.PI/180),a&&(e.position.x=a.x,e.position.y=a.y,e.position.z=0)}))};var Wa=Object.defineProperty,qa=(e,t,n)=>(((e,t,n)=>{t in e?Wa(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);class $a{constructor(t,n){qa(this,"cadUrl"),qa(this,"container"),qa(this,"renderer",new e.WebGLRenderer({antialias:!0})),qa(this,"scene",new e.Scene),qa(this,"camera",null),qa(this,"controls",null),qa(this,"addMoveEvent",(()=>{})),qa(this,"deleteMoveEvent",(()=>{})),qa(this,"modelGroupByLayer",{}),qa(this,"textData",[]),qa(this,"finishCallBack",(()=>{})),qa(this,"progressCallBack",(()=>{})),qa(this,"progress",0),qa(this,"isLoadingLocal"),qa(this,"isLoadingFinish"),n.includes(".dxf")?this.isLoadingLocal=!0:this.isLoadingLocal=!1,this.isLoadingFinish=!1,this.container=t,this.cadUrl=n+"",this.initViewer()}initViewer(){return new Promise((async(e,t)=>{this.changeProgress(10),this.isLoadingLocal?await this.loadLocalFile():await this.loadOurBimCADFile(),this.changeProgress(100),this.renderer=Oe,this.scene=Ae,this.camera=Ee,this.controls=Se,this.addMoveEvent=ht,this.deleteMoveEvent=dt,this.modelGroupByLayer=Ce,this.textData=Nn,this.isLoadingFinish=!0,this.finishCallBack(),e(!0)}))}loadOurBimCADFile(){return new Promise(((e,t)=>{fetch(`${$t}dxfParse?fileName=${this.cadUrl}`,{method:"GET"}).then((e=>e.json())).then((t=>{if(200===t.code){this.changeProgress(55);const n=Number(t.fileName);let i=[];for(let e=0;e<n;e++)i.push(this.getJsonFile(this.cadUrl,e));Promise.all(i).then((async t=>{let n,i="";t.forEach(((e,t)=>{"string"==typeof e?i+=e:i=e})),this.changeProgress(70),n="string"==typeof i?JSON.parse(i):i;const a=Ha(n);this.changeProgress(90),await this.draw(a),e(!0)}))}}))}))}getJsonFile(e,t){return new Promise(((n,i)=>{fetch(`${Jt}${e}/${t}.json`).then((e=>e.text())).then((e=>{n(e)}))}))}loadLocalFile(){return new Promise(((t,n)=>{(new e.FileLoader).load(this.cadUrl,(async e=>{this.changeProgress(40);const n=(new Gi).parseSync(e);this.changeProgress(70);const i=Ha(n);this.changeProgress(90),await this.draw(i),t(!0)}),(function(e){}),(function(e){console.error("文件加载异常，请检测文件是否存在")}))}))}draw(e){return new Promise(((t,n)=>{Ue(e,this.container),t(!0)}))}changeProgress(e){this.progress=e,this.progressCallBack()}registFinishCallBack(e){e&&"function"==typeof e?this.finishCallBack=e:console.warn("加载完成回调函数注册异常，请检查参数是否为响应函数")}registProgressCallBack(e){e&&"function"==typeof e?this.progressCallBack=e:console.warn("进度回调函数注册异常，请检查参数是否为响应函数")}update(){this.renderer=Oe,this.scene=Ae,this.camera=Ee,this.controls=Se}}export{Tn as Controller,$a as Viewer};
