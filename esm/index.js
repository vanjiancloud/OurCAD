import*as e from"three";import{Loader as t,FileLoader as n,ShapePath as a,ExtrudeGeometry as o,BufferGeometry as s,Float32BufferAttribute as i}from"three";import{ElMessageBox as r,ElInput as c,ElMessage as l}from"element-plus";import{ref as h,h as u}from"vue";import{Text as d}from"troika-three-text";const p=(t,n,a)=>{let o=new e.Vector2;o.x=t/window.innerWidth*2-1,o.y=-n/window.innerHeight*2+1;let s=new e.Vector3(o.x,o.y,0);return s.unproject(a),s};let b=0;const y=(e,t)=>{(new Date).getTime()-b>t&&(e(),b=(new Date).getTime())};let f,m,x,v,g=0,w=0,k=0,E=0,P=!1;const L=e=>{P=!0,g=e.clientX,w=e.clientY,f||(f=document.createElement("div"),f.id="selectBox",document.body.appendChild(f)),f.style.cssText="\n        position: absolute;\n        width: 0;\n        height: 0;\n        margin: 0;\n        padding: 0;\n        border: 1px dashed #eee;\n        z-index: 1000;\n        opacity: 0.6;\n        display: none;\n    ",f.style.left=g+"px",f.style.top=w+"px"},M=e=>{P&&(k=e.clientX,E=e.clientY,f.style.display="block",f.style.left=Math.min(k,g)+"px",f.style.top=Math.min(E,w)+"px",f.style.width=Math.abs(k-g)+"px",f.style.height=Math.abs(E-w)+"px")},O=e=>{k=e.clientX,E=e.clientY;const t=k-g,n=E-w;if(Math.abs(t)<2||Math.abs(n)<2)return void D();const a=((e,t)=>{const n=window.innerWidth/Math.abs(e),a=window.innerHeight/Math.abs(t);return Math.min(n,a)})(t,n),o={x:g+t/2,y:w+n/2};v(o.x,o.y,a),D(),T()},D=()=>{P=!1,g=0,w=0,f.style.display="none"},S=()=>{x(),document.addEventListener("mousedown",L,!1),document.addEventListener("mousemove",M,!1),document.addEventListener("mouseup",O,!1)},T=()=>{document.removeEventListener("mousedown",L,!1),document.removeEventListener("mousemove",M,!1),document.removeEventListener("mouseup",O,!1),m()};let N=0;const C=e=>{let t=[],n=[],a=[];for(let o in e)e[o][0].visible&&n.push(o),t.push({key:o,group:e[o]}),a.push(o);return t.sort(((e,t)=>e.key.localeCompare(t.key))),a.sort(((e,t)=>e.localeCompare(t))),{layerData:t,visibleKeys:n,Allkeys:a}},A=(e,t,n,a,o,s)=>{const{layerData:i}=C(e);i.forEach((e=>{"string"==typeof o?e.key===o&&e.group.forEach((e=>{e.visible=s})):o.includes(e.key)&&e.group.forEach((e=>{e.visible=s}))})),t.render(n,a)},j=(e,t,n,a,o)=>{const{layerData:s}=C(e);s.forEach((e=>{e.group.forEach((e=>{e.visible=o}))})),t.render(n,a)};let F={};let V,I,z,Y,B,R,H,X="";const _=(t,n,a,o,s,i)=>{let r=[];for(let c=0;c<=o;c++){let l=c/o*Math.PI*2;const h=new e.Vector3;h.x=t+a*Math.sin(l)*s,h.y=n+a*Math.cos(l)*i,h.z=0,r.push(h)}return r};let G,W;const U=()=>{G(),document.addEventListener("mousedown",Y,!1),document.addEventListener("mousemove",B,!1),document.addEventListener("mouseup",R,!1)},q=()=>{document.removeEventListener("mousedown",Y,!1),document.removeEventListener("mousemove",B,!1),document.removeEventListener("mouseup",R,!1),W()};let Z,K,J;const $=()=>{K(),document.addEventListener("mousedown",Z,!1)},Q=()=>{document.removeEventListener("mousedown",Z,!1),J()};let ee,te,ne,ae,oe,se,ie,re=!1,ce=!1,le=[];const he=()=>{ne(),document.addEventListener("mousedown",oe,!1),document.addEventListener("mousemove",se,!1),document.addEventListener("mouseup",ie,!1)},ue=()=>{document.removeEventListener("mousedown",oe,!1),document.removeEventListener("mousemove",se,!1),document.removeEventListener("mouseup",ie,!1),ae()};class de extends t{constructor(e){super(e)}load(e,t,a,o){const s=this,i=new n(this.manager);i.setPath(this.path),i.setRequestHeader(this.requestHeader),i.setWithCredentials(this.withCredentials),i.load(e,(function(e){const n=s.parse(JSON.parse(e));t&&t(n)}),a,o)}parse(e){return new pe(e)}}class pe{constructor(e){this.isFont=!0,this.type="Font",this.data=e}generateShapes(e,t=100){const n=[],a=function(e,t,n){const a=Array.from(e),o=t/n.resolution,s=(n.boundingBox.yMax-n.boundingBox.yMin+n.underlineThickness)*o,i=[];let r=0,c=0;for(let e=0;e<a.length;e++){const t=a[e];if("\n"===t)r=0,c-=s;else{const e=be(t,o,r,c,n);r+=e.offsetX,i.push(e.path)}}return i}(e,t,this.data);for(let e=0,t=a.length;e<t;e++)n.push(...a[e].toShapes());return n}}function be(e,t,n,o,s){const i=s.glyphs[e]||s.glyphs["?"];if(!i)return void console.error('THREE.Font: character "'+e+'" does not exists in font family '+s.familyName+".");const r=new a;let c,l,h,u,d,p,b,y;if(i.o){const e=i._cachedOutline||(i._cachedOutline=i.o.split(" "));for(let a=0,s=e.length;a<s;)switch(e[a++]){case"m":c=e[a++]*t+n,l=e[a++]*t+o,r.moveTo(c,l);break;case"l":c=e[a++]*t+n,l=e[a++]*t+o,r.lineTo(c,l);break;case"q":h=e[a++]*t+n,u=e[a++]*t+o,d=e[a++]*t+n,p=e[a++]*t+o,r.quadraticCurveTo(d,p,h,u);break;case"b":h=e[a++]*t+n,u=e[a++]*t+o,d=e[a++]*t+n,p=e[a++]*t+o,b=e[a++]*t+n,y=e[a++]*t+o,r.bezierCurveTo(d,p,b,y,h,u)}}return{offsetX:i.ha*t,path:r}}class ye extends o{constructor(e,t={}){const n=t.font;if(void 0===n)super();else{const a=n.generateShapes(e,t.size);t.depth=void 0!==t.height?t.height:50,void 0===t.bevelThickness&&(t.bevelThickness=10),void 0===t.bevelSize&&(t.bevelSize=8),void 0===t.bevelEnabled&&(t.bevelEnabled=!1),super(a,t)}this.type="TextGeometry"}}let fe,me,xe,ve,ge,we,ke,Ee=h("");const Pe=new e.MeshBasicMaterial({color:"#ffffff"}),Le=()=>new Promise(((e,t)=>{(new de).load("https://api.ourbim.com:8181/CADFile/FZYaoTi_Regular.json",(t=>{ke=t,e()}))})),Me=()=>{ge(),document.addEventListener("mousedown",xe,!1)},Oe=()=>{document.removeEventListener("mousedown",xe,!1),we()};let De,Se,Te,Ne,Ce,Ae,je,Fe,Ve="";const Ie=()=>{je(),document.addEventListener("mousedown",Te,!1),document.addEventListener("mousemove",Ne,!1),document.addEventListener("mouseup",Ce,!1)},ze=()=>{document.removeEventListener("mousedown",Te,!1),document.removeEventListener("mousemove",Ne,!1),document.removeEventListener("mouseup",Ce,!1),Fe()};var Ye=Object.defineProperty,Be=(e,t,n)=>(((e,t,n)=>{t in e?Ye(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);const Re={line:t=>new Promise(((n,a)=>{let{camera:o,scene:s,renderer:i}=t;K=t.deleteMoveEvent,J=t.addMoveEvent;const r=new e.Group;s.add(r);let c=[];Z=e=>{let t=p(e.clientX,e.clientY,o);c.push(t),2===c.length&&l()};const l=()=>{const t=new e.LineBasicMaterial({color:16777215}),a=(new e.BufferGeometry).setFromPoints([new e.Vector3(c[0].x,c[0].y,0),new e.Vector3(c[1].x,c[1].y,0)]);let l=new e.Line(a,t);r.add(l),i.render(s,o),Q(),n({type:"line",comment:l,commentData:c})};$()})),ellipse:t=>new Promise(((n,a)=>{let{camera:o,scene:s,renderer:i}=t;G=t.deleteMoveEvent,W=t.addMoveEvent;const r=new e.Group;s.add(r),I=null,V=(e,t,n)=>{let a=p(e,t,n);return r.worldToLocal(a)},Y=e=>{I=V(e.clientX,e.clientY,o)},B=t=>{if(!I)return;z=V(t.clientX,t.clientY,o);const n=I.x+(z.x-I.x)/2,a=I.y+(z.y-I.y)/2,c=Math.abs(I.x-z.x),l=Math.abs(I.y-z.y),h=Math.max(c,l)/2,u=_(n,a,h,50,c/2/h,l/2/h);"drawing"===X&&r.remove(H);const d=(new e.BufferGeometry).setFromPoints(u),p=new e.LineBasicMaterial({color:16777215});H=new e.LineLoop(d,p),r.add(H),X="drawing",y((()=>{i.render(s,o)}),40)},R=()=>{X="",q(),n({type:"ellipse",comment:H,commentData:{startPoint:I,endPoint:z}})},U()})),pointerLine:t=>new Promise(((n,a)=>{let{camera:o,scene:s,renderer:i}=t;ne=t.deleteMoveEvent,ae=t.addMoveEvent;const r=new e.Group;s.add(r),le=[],oe=()=>{re=!0},se=t=>{if(!re)return;const n=p(t.clientX,t.clientY,o),a=new e.Vector3(n.x,n.y,0);le.push(a),ee=(new e.BufferGeometry).setFromPoints(le);const c=new e.LineBasicMaterial({color:16777215});ce&&r.remove(te),te=new e.Line(ee,c),r.add(te),ce=!0,y((()=>{i.render(s,o)}),30)},ie=()=>{re=!1,ce=!1,ue(),n({type:"pointerLine",comment:te,commentData:le})},he()})),word:t=>new Promise(((n,a)=>{let{camera:o,scene:s,renderer:i}=t;ge=t.deleteMoveEvent,we=t.addMoveEvent;const l=new e.Group;s.add(l),Ee.value="",xe=e=>{fe=p(e.clientX,e.clientY,o),me=p(e.clientX+50,e.clientY,o),r({title:"请输入文字标注内容",message:()=>u("div",[u(c,{modelValue:Ee.value,"onUpdate:modelValue":e=>{Ee.value=e}})]),showCancelButton:!0,confirmButtonText:"确定",cancelButtonText:"取消"}).then((()=>{ve()})).catch((()=>{})),Oe()},ve=async()=>{const t=.3*(me.x-fe.x);ke||await Le();const a=new ye(Ee.value,{font:ke,size:t,height:0});let r=new e.Mesh(a,Pe);r.position.set(fe.x,fe.y,0),l.add(r),i.render(s,o),n({type:"word",comment:r,commentData:{position:fe,text:Ee.value,fontHeight:t}})},Me()})),rect:t=>new Promise(((n,a)=>{let{camera:o,scene:s,renderer:i}=t;je=t.deleteMoveEvent,Fe=t.addMoveEvent;const r=new e.Group;s.add(r),De=null,Te=e=>{De=p(e.clientX,e.clientY,o)},Ne=t=>{if(!De)return;Se=p(t.clientX,t.clientY,o);const n=[new e.Vector3(De.x,De.y,0),new e.Vector3(Se.x,De.y,0),new e.Vector3(Se.x,Se.y,0),new e.Vector3(De.x,Se.y,0)];"drawing"===Ve&&r.remove(Ae);const a=(new e.BufferGeometry).setFromPoints(n),c=new e.LineBasicMaterial({color:16777215});Ae=new e.LineLoop(a,c),r.add(Ae),Ve="drawing",y((()=>{i.render(s,o)}),40)},Ce=()=>{Ve="",ze(),n({type:"rect",comment:Ae,commentData:{startPoint:De,endPoint:Se}})},Ie()}))},He={line:(t,n)=>{let{camera:a,scene:o,renderer:s}=t;const i=new e.Group;o.add(i);const r=new e.LineBasicMaterial({color:16777215}),c=(new e.BufferGeometry).setFromPoints([new e.Vector3(n[0].x,n[0].y,0),new e.Vector3(n[1].x,n[1].y,0)]);let l=new e.Line(c,r);return i.add(l),s.render(o,a),l},ellipse:(t,n)=>{let{camera:a,scene:o,renderer:s}=t;const{startPoint:i,endPoint:r}=n,c=new e.Group;o.add(c);const l=i.x+(r.x-i.x)/2,h=i.y+(r.y-i.y)/2,u=Math.abs(i.x-r.x),d=Math.abs(i.y-r.y),p=Math.max(u,d)/2,b=_(l,h,p,50,u/2/p,d/2/p),y=(new e.BufferGeometry).setFromPoints(b),f=new e.LineBasicMaterial({color:16777215});return H=new e.LineLoop(y,f),c.add(H),s.render(o,a),H},pointerLine:(t,n)=>{let{camera:a,scene:o,renderer:s}=t;const i=new e.Group;o.add(i),ee=(new e.BufferGeometry).setFromPoints(n);const r=new e.LineBasicMaterial({color:16777215});return te=new e.Line(ee,r),i.add(te),s.render(o,a),te},word:async(t,n)=>{let{camera:a,scene:o,renderer:s}=t;const{text:i,position:r,fontHeight:c}=n,l=new e.Group;o.add(l),ke||await Le();const h=new ye(i,{font:ke,size:c,height:0});let u=new e.Mesh(h,Pe);return u.position.set(r.x,r.y,0),l.add(u),s.render(o,a),u},rect:(t,n)=>{let{camera:a,scene:o,renderer:s}=t;const{startPoint:i,endPoint:r}=n,c=new e.Group;o.add(c);const l=[new e.Vector3(i.x,i.y,0),new e.Vector3(r.x,i.y,0),new e.Vector3(r.x,r.y,0),new e.Vector3(i.x,r.y,0)],h=(new e.BufferGeometry).setFromPoints(l),u=new e.LineBasicMaterial({color:16777215});return Ae=new e.LineLoop(h,u),c.add(Ae),s.render(o,a),Ae}};var Xe=Object.defineProperty,_e=(e,t,n)=>(((e,t,n)=>{t in e?Xe(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);class Ge{constructor(e){_e(this,"Viewer"),_e(this,"comment"),this.Viewer=e,this.comment=new class{constructor(e){Be(this,"Viewer"),Be(this,"commentArr",[]),Be(this,"commentCollecter",{length:0}),this.Viewer=e}draw(e){Re[e]?Re[e](this.Viewer).then((e=>{const{type:t,comment:n,commentData:a}=e;this.collecter(t,n,a)})):console.log("暂不支持该类型批注")}reShowComment(e){e.forEach((async e=>{if(He[e.type]){const t=await He[e.type](this.Viewer,e.commentData);this.collecter(e.type,t,e.commentData)}else console.log("暂不支持该类型批注",e.type)}))}showOrHidden(){let{camera:e,scene:t,renderer:n}=this.Viewer;for(let e in this.commentCollecter)"length"!==e&&this.commentCollecter[e].forEach((e=>{e.visible=!e.visible}));n.render(t,e)}collecter(e,t,n){this.commentCollecter[e]?this.commentCollecter[e].push(t):(this.commentCollecter[e]=[t],this.commentCollecter.length++),this.commentArr.push({type:e,commentData:n})}}(e),this.Viewer.isLoadingLocal||We(this.Viewer.cadUrl).then((e=>{e&&this.reShowComment(JSON.parse(e))}))}reShowComment(e){this.Viewer.camera?this.comment.reShowComment(e):setTimeout((()=>{this.reShowComment(e)}),500)}HomeView(){this.Viewer.update();const{renderer:e,scene:t,camera:n,controls:a}=this.Viewer;a.target.copy(a.target0),a.object.position.copy(a.position0),a.object.zoom=1,a.object.updateProjectionMatrix(),e.render(t,n)}selectBox(t,n){this.Viewer.update();const{renderer:a,scene:o,camera:s,controls:i,addMoveEvent:r,deleteMoveEvent:c}=this.Viewer;((t,n,a,o,s,i,r=(()=>{}),c=(()=>{}))=>{m=s,x=i,r(),S(),v=(s,i,r)=>{const l=p(s,i,o.object),h=p(window.innerWidth/2,window.innerHeight/2,o.object),u=(new e.Vector3).subVectors(h,l);o.object.position.sub(u),o.object.zoom=o.object.zoom*r,o.object.updateProjectionMatrix(),t.render(n,a),c()}})(a,o,s,i,r,c,t,n)}cancelSelectBox(){T()}changeBackground(){this.Viewer.update();const{renderer:t,scene:n,camera:a}=this.Viewer;((t,n,a)=>{const o=[new e.Color(3289655),new e.Color(16777215)];N++,n.background=o[N%o.length],t.render(n,a)})(t,n,a)}fullScreen(e){var t;t=e,document.fullscreenElement?console.warn("已经是全屏状态"):t.requestFullscreen()}exitFullScreen(){document.fullscreenElement?document.exitFullscreen():console.warn("当前不是全屏状态")}getLayerList(){const{modelGroupByLayer:e}=this.Viewer;return(e=>{const{Allkeys:t,visibleKeys:n}=C(e);return{Allkeys:t,visibleKeys:n}})(e)}showLayerBykeys(e){this.Viewer.update();const{modelGroupByLayer:t,renderer:n,scene:a,camera:o}=this.Viewer;A(t,n,a,o,e,!0)}hiddenLayerBykeys(e){this.Viewer.update();const{modelGroupByLayer:t,renderer:n,scene:a,camera:o}=this.Viewer;A(t,n,a,o,e,!1)}showAllLayer(){this.Viewer.update();const{modelGroupByLayer:e,renderer:t,scene:n,camera:a}=this.Viewer;j(e,t,n,a,!0)}hiddenAllLayer(){this.Viewer.update();const{modelGroupByLayer:e,renderer:t,scene:n,camera:a}=this.Viewer;j(e,t,n,a,!1)}getSearchList(e){const{textData:t}=this.Viewer;return((e,t)=>{let n=[];return e.forEach(((e,a)=>{e.text.includes(t)&&(F[a]=e,n.push({index:a,text:e.text}))})),n})(t,e)}positionByText(t){const{renderer:n,scene:a,camera:o,controls:s}=this.Viewer;((t,n,a,o,s)=>{const{x:i,y:r}=F[s].position;((s,i,r)=>{const c=new e.Vector3(s,i,0),l=p(window.innerWidth/2,window.innerHeight/2,o.object),h=(new e.Vector3).subVectors(l,c);o.object.position.sub(h),o.object.zoom=o.object.zoom*r,o.object.updateProjectionMatrix(),t.render(n,a)})(i,r,(()=>{const t=p(0,0,o.object),n=p(0,window.innerHeight/6,o.object),a=(new e.Vector3).subVectors(n,t);return Math.abs(a.y/F[s].textHeight)})())})(n,a,o,s,t)}addComment(e){this.comment.draw(e)}showOrHiddenComment(){this.comment.showOrHidden()}saveComment(){this.Viewer.isLoadingLocal?console.warn("本地图纸无法保存批注，请先上传图纸到ourbim"):0!==this.comment.commentArr.length?Ue(this.Viewer.cadUrl,this.comment.commentArr):console.warn("请先添加批注再保存")}}const We=e=>new Promise((async(t,n)=>{const a=await(e=>new Promise(((t,n)=>{fetch("http://1.183.136.226:5024/isExistComment",{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify({fileName:e})}).then((e=>e.json())).then((e=>{t(e.message)}))})))(e);if(console.log("第214行被执行",a),!a)return;fetch(`https://api.ourbim.com:8181/CADFile/${e}/comment.json`).then((e=>e.text())).then((e=>{t(e)}))})),Ue=(e,t)=>{const n={fileName:e,commentData:JSON.stringify(t)};fetch("http://1.183.136.226:5024/addComment",{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}).then((e=>e.json())).then((e=>{200===e.code&&l({message:"保存成功",type:"success"})}))};let qe=0;let Ze,Ke,Je;function $e(t,n){this.object=t,this.domElement=void 0!==n?n:document,Ze=n,this.enabled=!0,this.target=new e.Vector3,this.center=this.target,this.noZoom=!1,this.zoomSpeed=1,this.minDistance=0,this.maxDistance=1/0,this.noRotate=!1,this.rotateSpeed=1,this.noPan=!1,this.keyPanSpeed=7,this.autoRotate=!1,this.autoRotateSpeed=2,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.noKeys=!1,this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40};var a=this,o=new e.Vector2,s=new e.Vector2,i=new e.Vector2,r=new e.Vector2,c=new e.Vector2,l=new e.Vector2,h=new e.Vector3,u=new e.Vector3,d=new e.Vector2,p=new e.Vector2,b=new e.Vector2,y=1,f=new e.Vector3;new e.Vector3;var m={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_DOLLY:4,TOUCH_PAN:5},x=m.NONE;this.target0=this.target.clone(),this.position0=this.object.position.clone();var v={type:"change"},g={type:"start"},w={type:"end"};function k(){return 2*Math.PI/60/60*a.autoRotateSpeed}function E(){return Math.pow(.95,a.zoomSpeed)}function P(e){((e,t)=>{(new Date).getTime()-qe>t&&(e(),qe=(new Date).getTime())})((()=>{L(e)}),20)}function L(t){if(!1!==a.enabled&&(t.preventDefault(),x===m.PAN)){if(!0===a.noPan)return;let n=new e.Vector2;n.x=t.clientX/window.innerWidth*2-1,n.y=-t.clientY/window.innerHeight*2+1;let o=new e.Vector3(n.x,n.y,0);o.unproject(a.object),c.set(o.x,o.y),l.subVectors(c,r),a.object.position.sub(new e.Vector3(l.x,l.y,0)),a.dispatchEvent(v)}}function M(){!1!==a.enabled&&(a.domElement.removeEventListener("mousemove",L,!1),a.domElement.removeEventListener("mouseup",M,!1),a.dispatchEvent(w),x=m.NONE)}this.rotateLeft=function(e){void 0===e&&(e=k())},this.rotateUp=function(e){void 0===e&&(e=k())},this.panLeft=function(e){var t=this.object.matrix.elements;h.set(t[0],t[1],t[2]),h.multiplyScalar(-e),f.add(h)},this.panUp=function(e){var t=this.object.matrix.elements;h.set(t[4],t[5],t[6]),h.multiplyScalar(e),f.add(h)},this.pan=function(e,t){var n=a.domElement===document?a.domElement.body:a.domElement;void 0!==a.object.top&&(console.log("正交相机",e,a.object.right-a.object.left,n.clientWidth),a.panLeft(e*(a.object.right-a.object.left)/n.clientWidth),a.panUp(t*(a.object.top-a.object.bottom)/n.clientHeight))},this.dollyIn=function(e){void 0===e&&(e=E()),y/=e},this.dollyOut=function(e){void 0===e&&(e=E()),y*=e},this.update=function(){void 0!==a.object.top&&(this.object.top=y*this.object.top,this.object.bottom=y*this.object.bottom,this.object.left=y*this.object.left,this.object.right=y*this.object.right,this.object.updateProjectionMatrix());var e=this.object.position;u.copy(e).sub(this.target),this.target.add(f),e.copy(this.target).add(u),this.object.lookAt(this.target),this.dispatchEvent(v),y=1,f.set(0,0,0)},this.reset=function(){x=m.NONE,this.target.copy(this.target0),this.object.position.copy(this.position0),this.update()},Ke=t=>{if(!1!==a.enabled){if(t.preventDefault(),0!==t.button&&2!==t.button)return;{x=m.PAN;let n=new e.Vector2;n.x=t.clientX/window.innerWidth*2-1,n.y=-t.clientY/window.innerHeight*2+1;let o=new e.Vector3(n.x,n.y,0);o.unproject(a.object),r.set(o.x,o.y)}a.domElement.addEventListener("mousemove",P,!1),a.domElement.addEventListener("mouseup",M,!1),a.dispatchEvent(g)}},Je=t=>{if(!1===a.enabled||!0===a.noZoom)return;t.preventDefault();let n=new e.Vector2,o=0;n.x=t.clientX/window.innerWidth*2-1,n.y=-t.clientY/window.innerHeight*2+1,o=t.deltaY>0?10:-10;const s=1+.01*o,i=new e.Vector3(n.x,n.y,.5).unproject(a.object);a.object.zoom/=s,a.object.updateProjectionMatrix();const r=new e.Vector3(n.x,n.y,.5).unproject(a.object);a.object.position.add(i.clone().sub(r)),a.dispatchEvent(v)},this.domElement.addEventListener("contextmenu",(function(e){e.preventDefault()}),!1),Qe(),this.domElement.addEventListener("touchstart",(function(e){if(!1!==a.enabled){switch(e.touches.length){case 1:if(!0===a.noRotate)return;x=m.TOUCH_ROTATE,o.set(e.touches[0].pageX,e.touches[0].pageY);break;case 2:if(!0===a.noZoom)return;x=m.TOUCH_DOLLY;var t=e.touches[0].pageX-e.touches[1].pageX,n=e.touches[0].pageY-e.touches[1].pageY,s=Math.sqrt(t*t+n*n);d.set(0,s);break;case 3:if(!0===a.noPan)return;x=m.TOUCH_PAN,r.set(e.touches[0].pageX,e.touches[0].pageY);break;default:x=m.NONE}a.dispatchEvent(g)}}),!1),this.domElement.addEventListener("touchend",(function(){!1!==a.enabled&&(a.dispatchEvent(w),x=m.NONE)}),!1),this.domElement.addEventListener("touchmove",(function(e){if(!1!==a.enabled){e.preventDefault(),e.stopPropagation();var t=a.domElement===document?a.domElement.body:a.domElement;switch(e.touches.length){case 1:if(!0===a.noRotate||x!==m.TOUCH_ROTATE)return;s.set(e.touches[0].pageX,e.touches[0].pageY),i.subVectors(s,o),a.rotateLeft(2*Math.PI*i.x/t.clientWidth*a.rotateSpeed),a.rotateUp(2*Math.PI*i.y/t.clientHeight*a.rotateSpeed),o.copy(s),a.update();break;case 2:if(!0===a.noZoom||x!==m.TOUCH_DOLLY)return;var n=e.touches[0].pageX-e.touches[1].pageX,h=e.touches[0].pageY-e.touches[1].pageY,u=Math.sqrt(n*n+h*h);p.set(0,u),b.subVectors(p,d),b.y>0?a.dollyOut():a.dollyIn(),d.copy(p),a.update();break;case 3:if(!0===a.noPan||x!==m.TOUCH_PAN)return;c.set(e.touches[0].pageX,e.touches[0].pageY),l.subVectors(c,r),a.pan(l.x,l.y),r.copy(c),a.update();break;default:x=m.NONE}}}),!1),window.addEventListener("keydown",(function(e){if(!1!==a.enabled&&!0!==a.noKeys&&!0!==a.noPan)switch(e.keyCode){case a.keys.UP:a.pan(0,a.keyPanSpeed),a.update();break;case a.keys.BOTTOM:a.pan(0,-a.keyPanSpeed),a.update();break;case a.keys.LEFT:a.pan(a.keyPanSpeed,0),a.update();break;case a.keys.RIGHT:a.pan(-a.keyPanSpeed,0),a.update()}}),!1)}const Qe=()=>{Ze.addEventListener("mousedown",Ke,!1),Ze.addEventListener("mousewheel",Je,!1),Ze.addEventListener("DOMMouseScroll",Je,!1)};$e.prototype=Object.create(e.EventDispatcher.prototype);let et=[];const tt=(e,t,n)=>{et.push({text:e,position:t,textHeight:n})};var nt=Object.defineProperty,at=(e,t,n)=>(((e,t,n)=>{t in e?nt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);let ot;let st=class{constructor(e){at(this,"type","Text"),at(this,"color",16777215),at(this,"layer","0"),at(this,"position"),at(this,"rotation",0),at(this,"text"),at(this,"textHeight",12),this.type=e.type,this.color=e.color,this.layer=e.layer,this.position=e.position,this.rotation=e.rotation,this.text=e.text,this.textHeight=e.textHeight}draw(){let t=new ye(this.text,{font:ot,height:0,size:this.textHeight});this.rotation&&t.rotateZ(this.rotation);let n=new e.MeshBasicMaterial({color:this.color}),a=new e.Mesh(t,n);return a.position.x=this.position.x,a.position.y=this.position.y,a.position.z=this.position.z,tt(this.text,this.position,this.textHeight),a}};var it=Object.defineProperty,rt=(e,t,n)=>(((e,t,n)=>{t in e?it(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);let ct=class{constructor(e){rt(this,"type","Line"),rt(this,"color",16777215),rt(this,"layer","0"),rt(this,"position",[]),rt(this,"isDashed",!1),rt(this,"lineTypeScale"),rt(this,"lineTypeData"),rt(this,"shape"),rt(this,"mlineOffset"),this.type=e.type,this.color=e.color,this.layer=e.layer,this.position=e.position,this.lineTypeScale=e.lineTypeScale?e.lineTypeScale:1,this.isDashed=e.isDashed,this.lineTypeData=e.lineTypeData,this.shape=e.shape,this.mlineOffset=e.mlineOffset}draw(){let t,n=(new s).setFromPoints(this.position);if(this.isDashed){const n=Math.abs(this.lineTypeData.pattern[1]*this.lineTypeScale),a=Math.abs(this.lineTypeData.pattern[0]*this.lineTypeScale);t=new e.LineDashedMaterial({color:this.color,gapSize:n,dashSize:a})}else t=new e.LineBasicMaterial({linewidth:1,color:this.color});let a=new e.Line(n,t);return a.computeLineDistances(),a}};var lt=Object.defineProperty,ht=(e,t,n)=>(((e,t,n)=>{t in e?lt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);let ut=class{constructor(e){ht(this,"type","Arc"),ht(this,"color",16777215),ht(this,"layer","0"),ht(this,"position"),this.type=e.type,this.color=e.color,this.layer=e.layer,this.position=e.position}draw(){let t=(new s).setFromPoints(this.position),n=new e.LineBasicMaterial({linewidth:1,color:this.color});return new e.Line(t,n)}};var dt=Object.defineProperty,pt=(e,t,n)=>(((e,t,n)=>{t in e?dt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);var bt=Object.defineProperty,yt=(e,t,n)=>(((e,t,n)=>{t in e?bt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);var ft=Object.defineProperty,mt=(e,t,n)=>(((e,t,n)=>{t in e?ft(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);const xt={d:"°",c:"⌀",p:"±"},vt=(e,t)=>{e=e.replace(/%%(.)/g,((e,t)=>xt[t]||t));const n=t?.encoding;let a,o=n instanceof TextDecoder?n:void 0,s="";const i=[],r=e=>{s&&(i.push(s),s=""),i.push(e)};for(let t=0;t<e.length;t++)switch(a=e[t]){default:s+=a;break;case"\\":switch(a=e[++t]){default:s+=a;break;case"P":s+="\n";break;case"f":case"F":{let n="";for(;a=e[++t];){if(";"===a){r({f:n});break}if("|"===a){const a={f:n},o=e.indexOf(";",++t);for(const n of e.slice(t,o).split("|"))a[n[0]]=+n.slice(1);t=o,r(a);break}n+="\\"===a?e[++t]:a}break}case"S":{let n,o="",s="";for(;a=e[++t];){if(";"===a){n&&r({S:[o,n,s]});break}"\\"===a?n?s+=e[++t]:o+=e[++t]:n?s+=a:"^"===a||"/"===a||"#"===a?n=a:o+=a}break}case"H":case"W":const i=++t,[,c,l]=e.slice(i,t=e.indexOf(";",t)).match(/^(\d*(?:\.\d+)?)(\D*)$/);r({[a]:[+c,l]});break;case"Q":case"A":case"C":case"T":{const n=++t;r({[a]:+e.slice(n,t=e.indexOf(";",t))});break}case"L":case"O":case"K":r({[a]:1});break;case"l":case"o":case"k":r({[a.toUpperCase()]:0});break;case"U":case"u":"+"===e[t+1]?(s+=String.fromCodePoint(parseInt(e.substr(t+2,4),16)),t+=5):s+=a;break;case"M":case"m":n?"+"===e[t+1]&&"1"===e[t+2]?(s+=(o=o||new TextDecoder(n)).decode(new Uint8Array([parseInt(e.substr(t+3,2),16),parseInt(e.substr(t+5,2),16)])),t+=6):s+=a:s+="\\"+a}break;case"{":{let n=1;const o=t;for(;a=e[++t];)if("{"===a)n++;else if("}"===a){if(0==--n){r(vt(e.slice(o+1,t)));break}}else"\\"===a&&t++;break}}return s&&i.push(s),i};var gt=Object.defineProperty,wt=(e,t,n)=>(((e,t,n)=>{t in e?gt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);const kt=(e,t,n)=>{let a={horizontalAlignment:"left",textHeight:t},o=[];for(let n of e)if("string"==typeof n)n.startsWith("pxq")&&n.endsWith(";")?-1!==n.indexOf("c")?a.horizontalAlignment="center":-1!==n.indexOf("l")?a.horizontalAlignment="left":-1!==n.indexOf("r")?a.horizontalAlignment="right":-1!==n.indexOf("j")&&(a.horizontalAlignment="justify"):o.push(n);else if(Array.isArray(n)){let e=kt(n,t);o.push(e.text)}else"object"==typeof n&&n.S&&3===n.S.length&&o.push(n.S[0]+"/"+n.S[2]);return{text:o.join(""),style:a}};var Et=Object.defineProperty,Pt=(e,t,n)=>(((e,t,n)=>{t in e?Et(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);let Lt,Mt,Ot,Dt=new e.WebGLRenderer({antialias:!0}),St=new e.Scene,Tt=["LINE","LWPOLYLINE","POLYLINE","ELLIPSE","ARC","CIRCLE","SPLINE"],Nt={};const Ct={LINE:ct,LWPOLYLINE:ct,POLYLINE:ct,MLINE:ct,TEXT:st,ATTDEF:st,CIRCLE:ut,ARC:ut,SOLID:class{constructor(e){pt(this,"type","Solid"),pt(this,"color",16777215),pt(this,"layer","0"),pt(this,"position"),this.type=e.type,this.color=e.color,this.layer=e.layer,this.position=e.position}draw(){let t=(new s).setFromPoints(this.position),n=new e.MeshBasicMaterial({color:this.color});return new e.Mesh(t,n)}},POINT:class{constructor(e){yt(this,"type","Point"),yt(this,"color",16777215),yt(this,"layer","0"),yt(this,"position"),this.type=e.type,this.color=e.color,this.layer=e.layer,this.position=e.position}draw(){let t=new s;const{x:n,y:a,z:o}=this.position,{offsetX:r,offsetY:c}=zt([n,a,o]);if(r&&c){const s=Yt([n,a,o],r,c);t.setAttribute("position",new e.Float32BufferAttribute(s,3))}else t.setAttribute("position",new i([n,a,o],3));let l=new e.PointsMaterial({size:.1,color:this.color}),h=new e.Points(t,l);if(r&&c){let e=r?r/100:0,t=c?c/100:0;h.position.set(e,t,0);const n=.01;h.scale.set(n,n,n)}return h}},SPLINE:class{constructor(e){mt(this,"type","Spline"),mt(this,"color",16777215),mt(this,"layer","0"),mt(this,"position",[]),this.type=e.type,this.color=e.color,this.layer=e.layer,this.position=e.position}draw(){let t=(new s).setFromPoints(this.position),n=new e.LineBasicMaterial({linewidth:1,color:this.color});return new e.Line(t,n)}},MTEXT:class{constructor(t){wt(this,"type","MText"),wt(this,"color",16777215),wt(this,"layer","0"),wt(this,"position"),wt(this,"rotation",0),wt(this,"directionVector"),wt(this,"extrusionDirection"),wt(this,"attachmentPoint"),wt(this,"text"),wt(this,"style"),wt(this,"width"),wt(this,"height"),wt(this,"textHeight",12),wt(this,"createTextForScene",((t,n,a)=>{if(!t)return null;let o=new d;if(o.text=t.replaceAll("\\P","\n").replaceAll("\\X","\n"),o.font="https://api.ourbim.com:8181/CADFile/FZYTK.TTF",o.fontSize=n.textHeight,this.textHeight=n.textHeight,o.maxWidth=this.width,o.position.x=this.position.x,o.position.y=this.position.y,o.position.z=this.position.z,o.textAlign=n.horizontalAlignment,o.color=a,this.rotation&&(o.rotation.z=this.rotation*Math.PI/180),this.directionVector){let t=this.directionVector,n=new e.Vector3(1,0,0).angleTo(new e.Vector3(t.x,t.y,t.z));const{x:a,y:s}=this.directionVector;a>0&&s<0||a<0&&s<0?o.rotateZ(2*Math.PI-n):o.rotateZ(n)}switch(-1===this.extrusionDirection?.z&&o.scale.set(1,-1,1),this.attachmentPoint){case 1:o.anchorX="left",o.anchorY="top";break;case 2:o.anchorX="center",o.anchorY="top";break;case 3:o.anchorX="right",o.anchorY="top";break;case 4:o.anchorX="left",o.anchorY="middle";break;case 5:o.anchorX="center",o.anchorY="middle";break;case 6:o.anchorX="right",o.anchorY="middle";break;case 7:o.anchorX="left",o.anchorY="bottom";break;case 8:o.anchorX="center",o.anchorY="bottom";break;case 9:o.anchorX="right",o.anchorY="bottom";break;default:return}return o.sync((()=>{if("left"!==o.textAlign){o.geometry.computeBoundingBox();let e=o.geometry.boundingBox.max.x-o.geometry.boundingBox.min.x;"center"===o.textAlign&&(o.position.x+=(this.width-e)/2),"right"===o.textAlign&&(o.position.x+=this.width-e)}})),o})),this.type=t.type,this.color=t.color,this.layer=t.layer,this.position=t.position,this.rotation=t.rotation,this.text=t.text,this.directionVector=t.directionVector,this.extrusionDirection=t.extrusionDirection,this.attachmentPoint=t.attachmentPoint,this.style=t.style,this.width=t.width,this.height=t.height}draw(){let t=vt(this.text),n=kt(t,this.height,this.color),a=this.createTextForScene(n.text,n.style,this.color),o=new e.Object3D;return o.add(a),tt(a.text,this.position,this.textHeight),o}},ELLIPSE:class{constructor(e){Pt(this,"type","Ellipse"),Pt(this,"color",16777215),Pt(this,"layer","0"),Pt(this,"position",[]),this.type=e.type,this.color=e.color,this.layer=e.layer,this.position=e.position}draw(){let t=(new s).setFromPoints(this.position),n=new e.LineBasicMaterial({linewidth:1,color:this.color});return new e.Line(t,n)}}},At=(e,t)=>{let n=[];for(let a=0;a<e.length/3;a++)n.push(t.r,t.g,t.b);return n},jt=(e,t)=>{e.uuid?Nt[e.uuid]={obj:e,index:t.insertNum}:console.log("没有uuid",e)};let Ft={};const Vt=(e,t)=>{Ft[t]?Ft[t].push(e):Ft[t]=[e]},It=(t,n=!0)=>{let a=new e.Object3D;for(let e=0;e<t.length;e++){const{groupData:n,insert:o,models:s}=t[e],i=Bt(s),{scale:r,rotation:c,position:l}=n;if(r&&(r.x&&(i.scale.x=r.x),r.y&&(i.scale.y=r.y),r.z&&-1===r.z&&(i.scale.x=-i.scale.x)),c&&(r.z&&-1===r.z?i.rotation.z=-c*Math.PI/180:i.rotation.z=c*Math.PI/180),l&&(i.position.x=l.x,i.position.y=l.y,i.position.z=0),a.add(i),0!==o?.length){const e=It(o,!1);r&&(r.x&&(e.scale.x=r.x),r.y&&(e.scale.y=r.y),r.z&&-1===r.z&&(e.scale.x=-e.scale.x)),c&&(r.z&&-1===r.z?e.rotation.z=-c*Math.PI/180:e.rotation.z=c*Math.PI/180),l&&(e.position.x=l.x,e.position.y=l.y,e.position.z=l.z),a.add(e)}}return a},zt=e=>{let t=0,n=0;const a=e[0]+"",o=e[1]+"";if(a.split(".").length>1){const e=a.split(".")[0];0!==a.split(".")[1].length&&(t=100*Number(e))}if(o.split(".").length>1){const e=o.split(".")[0];0!==o.split(".")[1].length&&(n=100*Number(e))}return{offsetX:t,offsetY:n}},Yt=(e,t,n)=>e.map(((e,a)=>a%3==0?100*e-t:a%3==1?100*e-n:e)),Bt=t=>{let n=new e.Object3D,a={};for(let o=0;o<t.length;o++){const{type:s}=t[o],i=t[o];if(Tt.includes(s)){let t=new e.Color;t.set(i.color);let n=At(i.positions,t);if(n.length===i.positions.length){let e=`${i.layer}`;a[e]?(a[e].position.push(...i.positions),a[e].color.push(...n)):a[e]={position:i.positions,color:n}}}else if(Ct[s]){"MLINE"===s&&(i.color=16777215);let t=new Ct[s](i).draw();if(n.add(t),jt(t,i),Vt(t,i.layer),"MLINE"===s){const t=new e.Vector3(1,0,0),a=new e.Vector3(i.position[1].x-i.position[0].x,i.position[1].y-i.position[0].y,i.position[1].z-i.position[0].z);let o=Math.PI/2-t.angleTo(a);const r=i.scaleFactor;let c=i.mlineOffset*Math.cos(o)*r,l=-i.mlineOffset*Math.sin(o)*r;i.position[1].y-i.position[0].y<0&&(c=-c,l=-l),i.position.forEach((e=>{e.y=e.y+l,e.x=e.x+c}));let h=new Ct[s](i).draw();n.add(h),jt(h,i),Vt(h,i.layer)}}else console.log("three绘制未处理的类型",s)}for(let t in a){let o=new e.BufferGeometry;const{offsetX:s,offsetY:i}=zt(a[t].position);if(s&&i){const n=Yt(a[t].position,s,i);o.setAttribute("position",new e.Float32BufferAttribute(n,3))}else o.setAttribute("position",new e.Float32BufferAttribute(a[t].position,3));o.setAttribute("color",new e.Float32BufferAttribute(a[t].color,3));let r=new e.LineBasicMaterial;r.vertexColors=!0;let c=new e.LineSegments(o,r);if(s&&i){let e=s?s/100:0,t=i?i/100:0;c.position.set(e,t,0);const n=.01;c.scale.set(n,n,n)}n.add(c),Vt(c,t)}return n},Rt=(t,n,a)=>{console.log("解析数据",t),(e=>{ot=e})(a),Ot=t.box,St.background=new e.Color(3289655);const o=Bt(t.models);if(St.add(o),0!==t.insert?.length){const e=It(t.insert);e.position.z=1,St.add(e)}const s=window.innerWidth/window.innerHeight,i=Ot.max.x,r=Ot.max.y,c=Ot.min.x,l=Ot.min.y;let h=i-c,u=r-l,d={x:h/2+c,y:u/2+l};const p=Math.abs(h/u);s>p?h=u*s:u=h/s;const b={bottom:-u/2,left:-h/2,top:u/2,right:h/2,center:{x:d.x,y:d.y}},y=1.3;Lt=new e.OrthographicCamera(b.left*y,b.right*y,b.top*y,b.bottom*y,1,19),Lt.position.z=10,Lt.position.x=b.center.x,Lt.position.y=b.center.y,Dt.setSize(window.innerWidth,window.innerHeight),Dt.setPixelRatio(window.devicePixelRatio),Dt.setClearColor(268435455,1),n.appendChild(Dt.domElement),n.style.display="block",Mt=new $e(Lt,n),Mt.target.x=Lt.position.x,Mt.target.y=Lt.position.y,Mt.target.z=0,Mt.zoomSpeed=3;const f=()=>{Dt.render(St,Lt)};Mt.addEventListener("change",f),f(),Mt.update();window.addEventListener("resize",(()=>{const t=Mt.object.position,n=Mt.object.zoom,a=window.innerWidth/window.innerHeight;a>p?h=u*a:u=h/a;const o=-u/2,s=-h/2,i=u/2,r=h/2;Lt=new e.OrthographicCamera(s*y,r*y,i*y,o*y,1,19),Lt.position.set(t.x,t.y,t.z),Lt.zoom=n,Mt.object=Lt,Mt.object.updateProjectionMatrix(),Dt.setSize(window.innerWidth,window.innerHeight),Dt.setPixelRatio(window.devicePixelRatio),Dt.render(St,Lt)}))};new e.Vector2,new e.Raycaster;const Ht=()=>{Qe()},Xt=()=>{Ze.removeEventListener("mousedown",Ke,!1),Ze.removeEventListener("mousewheel",Je,!1),Ze.removeEventListener("DOMMouseScroll",Je,!1)};var _t=Object.defineProperty,Gt=(e,t,n)=>(((e,t,n)=>{t in e?_t(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);function Wt(e,t){return e<=9?t:e>=10&&e<=59?parseFloat(t):e>=60&&e<=99?parseInt(t):e>=100&&e<=109?t:e>=110&&e<=149?parseFloat(t):e>=160&&e<=179?parseInt(t):e>=210&&e<=239?parseFloat(t):e>=270&&e<=289?parseInt(t):e>=290&&e<=299?function(e){if("0"===e)return!1;if("1"===e)return!0;throw TypeError("String '"+e+"' cannot be cast to Boolean type")}(t):e>=300&&e<=369?t:e>=370&&e<=389?parseInt(t):e>=390&&e<=399?t:e>=400&&e<=409?parseInt(t):e>=410&&e<=419?t:e>=420&&e<=429?parseInt(t):e>=430&&e<=439?t:e>=440&&e<=459?parseInt(t):e>=460&&e<=469?parseFloat(t):e>=470&&e<=481||999===e||e>=1e3&&e<=1009?t:e>=1010&&e<=1059?parseFloat(t):e>=1060&&e<=1071?parseInt(t):(console.log("WARNING: Group code does not have a defined type: %j",{code:e,value:t}),t)}var Ut=[0,16711680,16776960,65280,65535,255,16711935,16777215,8421504,12632256,16711680,16744319,13369344,13395558,10027008,10046540,8323072,8339263,4980736,4990502,16727808,16752511,13382400,13401958,10036736,10051404,8331008,8343359,4985600,4992806,16744192,16760703,13395456,13408614,10046464,10056268,8339200,8347455,4990464,4995366,16760576,16768895,13408512,13415014,10056192,10061132,8347392,8351551,4995328,4997670,16776960,16777087,13421568,13421670,10000384,10000460,8355584,8355647,5000192,5000230,12582656,14679935,10079232,11717734,7510016,8755276,6258432,7307071,3755008,4344870,8388352,12582783,6736896,10079334,5019648,7510092,4161280,6258495,2509824,3755046,4194048,10485631,3394560,8375398,2529280,6264908,2064128,5209919,1264640,3099686,65280,8388479,52224,6736998,38912,5019724,32512,4161343,19456,2509862,65343,8388511,52275,6737023,38950,5019743,32543,4161359,19475,2509871,65407,8388543,52326,6737049,38988,5019762,32575,4161375,19494,2509881,65471,8388575,52377,6737074,39026,5019781,32607,4161391,19513,2509890,65535,8388607,52428,6737100,39064,5019800,32639,4161407,19532,2509900,49151,8380415,39372,6730444,29336,5014936,24447,4157311,14668,2507340,32767,8372223,26316,6724044,19608,5010072,16255,4153215,9804,2505036,16383,8364031,13260,6717388,9880,5005208,8063,4149119,4940,2502476,255,8355839,204,6710988,152,5000344,127,4145023,76,2500172,4129023,10452991,3342540,8349388,2490520,6245528,2031743,5193599,1245260,3089996,8323327,12550143,6684876,10053324,4980888,7490712,4128895,6242175,2490444,3745356,12517631,14647295,10027212,11691724,7471256,8735896,6226047,7290751,3735628,4335180,16711935,16744447,13369548,13395660,9961624,9981080,8323199,8339327,4980812,4990540,16711871,16744415,13369497,13395634,9961586,9981061,8323167,8339311,4980793,4990530,16711807,16744383,13369446,13395609,9961548,9981042,8323135,8339295,4980774,4990521,16711743,16744351,13369395,13395583,9961510,9981023,8323103,8339279,4980755,4990511,3355443,5987163,8684676,11382189,14079702,16777215];function qt(e){const t={};e.rewind();let n=e.next(),a=n.code;if(t.x=n.value,a+=10,n=e.next(),n.code!=a)throw new Error("Expected code for point value to be "+a+" but got "+n.code+".");return t.y=n.value,a+=10,n=e.next(),n.code!=a?(e.rewind(),t):(t.z=n.value,t)}function Zt(e,t){e.rewind();const n=[];for(let a=0;a<16;a++){const a=e.next();if(a.code!==t)throw new Error("Expected code for matrix value to be "+t+" but got "+a.code+".");n.push(a.value)}return n}function Kt(e,t,n){switch(t.code){case 0:e.type=t.value;break;case 5:e.handle=t.value;break;case 6:e.lineType=t.value;break;case 8:e.layer=t.value;break;case 48:e.lineTypeScale=t.value;break;case 60:e.visible=0===t.value;break;case 62:e.colorIndex=t.value,e.color=function(e){return Ut[e]}(Math.abs(t.value));break;case 67:e.inPaperSpace=0!==t.value;break;case 100:break;case 101:for(;0!=t.code;)t=n.next();n.rewind();break;case 330:e.ownerHandle=t.value;break;case 347:e.materialObjectHandle=t.value;break;case 370:e.lineweight=t.value;break;case 420:e.color=t.value;break;case 1e3:e.extendedData=e.extendedData||{},e.extendedData.customStrings=e.extendedData.customStrings||[],e.extendedData.customStrings.push(t.value);break;case 1001:e.extendedData=e.extendedData||{},e.extendedData.applicationName=t.value;break;default:return!1}return!0}var Jt=Object.defineProperty,$t=(e,t,n)=>(((e,t,n)=>{t in e?Jt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);let Qt=class{constructor(){$t(this,"ForEntityName","3DFACE")}parseEntity(e,t){const n={type:t.value,vertices:[]};for(t=e.next();!e.isEOF()&&0!==t.code;){switch(t.code){case 70:n.shape=1==(1&t.value),n.hasContinuousLinetypePattern=128==(128&t.value);break;case 10:n.vertices=en(e,t),t=e.lastReadGroup;break;default:Kt(n,t,e)}t=e.next()}return n}};function en(e,t){var n=[],a=!1,o=!1;for(let i=0;i<=4;i++){for(var s={};!e.isEOF()&&0!==t.code&&!o;){switch(t.code){case 10:case 11:case 12:case 13:if(a){o=!0;continue}s.x=t.value,a=!0;break;case 20:case 21:case 22:case 23:s.y=t.value;break;case 30:case 31:case 32:case 33:s.z=t.value;break;default:return n}t=e.next()}n.push(s),a=!1,o=!1}return e.rewind(),n}var tn=Object.defineProperty,nn=(e,t,n)=>(((e,t,n)=>{t in e?tn(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);let an=class{constructor(){nn(this,"ForEntityName","ARC")}parseEntity(e,t){const n={type:t.value};for(t=e.next();!e.isEOF()&&0!==t.code;){switch(t.code){case 10:n.center=qt(e);break;case 40:n.radius=t.value;break;case 50:n.startAngle=Math.PI/180*t.value;break;case 51:n.endAngle=Math.PI/180*t.value,n.angleLength=n.endAngle-n.startAngle;break;case 210:n.extrusionDirectionX=t.value;break;case 220:n.extrusionDirectionY=t.value;break;case 230:n.extrusionDirectionZ=t.value;break;default:Kt(n,t,e)}t=e.next()}return n}};var on=Object.defineProperty,sn=(e,t,n)=>(((e,t,n)=>{t in e?on(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);let rn=class{constructor(){sn(this,"ForEntityName","ATTDEF")}parseEntity(e,t){var n={type:t.value,scale:1,textStyle:"STANDARD"};for(t=e.next();!e.isEOF()&&0!==t.code;){switch(t.code){case 1:n.text=t.value;break;case 2:n.tag=t.value;break;case 3:n.prompt=t.value;break;case 7:n.textStyle=t.value;break;case 10:n.startPoint=qt(e);break;case 11:n.endPoint=qt(e);break;case 39:n.thickness=t.value;break;case 40:n.textHeight=t.value;break;case 41:n.scale=t.value;break;case 50:n.rotation=t.value;break;case 51:n.obliqueAngle=t.value;break;case 70:n.invisible=!!(1&t.value),n.constant=!!(2&t.value),n.verificationRequired=!!(4&t.value),n.preset=!!(8&t.value);break;case 71:n.backwards=!!(2&t.value),n.mirrored=!!(4&t.value);break;case 72:n.horizontalJustification=t.value;break;case 73:n.fieldLength=t.value;break;case 74:n.verticalJustification=t.value;break;case 100:break;case 210:n.extrusionDirectionX=t.value;break;case 220:n.extrusionDirectionY=t.value;break;case 230:n.extrusionDirectionZ=t.value;break;default:Kt(n,t,e)}t=e.next()}return n}};var cn=Object.defineProperty,ln=(e,t,n)=>(((e,t,n)=>{t in e?cn(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);let hn=class{constructor(){ln(this,"ForEntityName","CIRCLE")}parseEntity(e,t){const n={type:t.value};for(t=e.next();!e.isEOF()&&0!==t.code;){switch(t.code){case 10:n.center=qt(e);break;case 40:n.radius=t.value;break;case 50:n.startAngle=Math.PI/180*t.value;break;case 51:const a=Math.PI/180*t.value;a<n.startAngle?n.angleLength=a+2*Math.PI-n.startAngle:n.angleLength=a-n.startAngle,n.endAngle=a;break;default:Kt(n,t,e)}t=e.next()}return n}};var un=Object.defineProperty,dn=(e,t,n)=>(((e,t,n)=>{t in e?un(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);let pn=class{constructor(){dn(this,"ForEntityName","DIMENSION")}parseEntity(e,t){const n={type:t.value};for(t=e.next();!e.isEOF()&&0!==t.code;){switch(t.code){case 2:n.block=t.value;break;case 10:n.anchorPoint=qt(e);break;case 11:n.middleOfText=qt(e);break;case 12:n.insertionPoint=qt(e);break;case 13:n.linearOrAngularPoint1=qt(e);break;case 14:n.linearOrAngularPoint2=qt(e);break;case 15:n.diameterOrRadiusPoint=qt(e);break;case 16:n.arcPoint=qt(e);break;case 70:n.dimensionType=t.value;break;case 71:n.attachmentPoint=t.value;break;case 42:n.actualMeasurement=t.value;break;case 1:n.text=t.value;break;case 50:n.angle=t.value;break;default:Kt(n,t,e)}t=e.next()}return n}};var bn=Object.defineProperty,yn=(e,t,n)=>(((e,t,n)=>{t in e?bn(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);class fn{constructor(){yn(this,"ForEntityName","MULTILEADER")}parseEntity(e,t){const n={type:t.value};function a(){for(;!e.isEOF();){switch(t.code){case 40:n.contextData.contentScale=t.value;break;case 10:n.contextData.contentBasePosition=qt(e);break;case 145:n.contextData.landingGap=t.value;break;case 290:n.contextData.hasMText=t.value;break;case 304:n.contextData.defaultTextContents=t.value;break;case 11:n.contextData.textNormalDirection=qt(e);break;case 12:n.contextData.textLocation=qt(e);break;case 13:n.contextData.textDirection=qt(e);break;case 140:n.contextData.arrowHeadSize=t.value;break;case 41:case 44:n.contextData.textHeight=t.value;break;case 42:n.contextData.textRotation=t.value;break;case 43:n.contextData.textWidth=t.value;break;case 45:n.contextData.textLineSpacingFactor=t.value;break;case 90:n.contextData.textColor=t.value;break;case 170:n.contextData.textLineSpacingStyle=t.value;break;case 171:n.contextData.textAttachment=t.value;break;case 172:n.contextData.textFlowDirection=t.value;break;case 141:n.contextData.textBackgroundScaleFactor=t.value;break;case 92:n.contextData.textBackgroundTransparency=t.value;break;case 291:n.contextData.textBackgroundColorOn=t.value;break;case 292:n.contextData.textBackgroundFillOn=t.value;break;case 293:n.contextData.textUseAutoHeight=t.value;break;case 173:n.contextData.textColumnType=t.value;break;case 142:n.contextData.textColumnWidth=t.value;break;case 143:n.contextData.textColumnGutterWidth=t.value;break;case 144:n.contextData.textColumnHeight=t.value;break;case 295:n.contextData.textUseWordBreak=t.value;break;case 296:n.contextData.hasBlock=t.value;break;case 341:n.contextData.blockContentId=t.value;break;case 14:n.contextData.blockContentNormalDirection=qt(e);break;case 15:n.contextData.blockContentPosition=qt(e);break;case 16:n.contextData.blockContentScale=t.value;break;case 46:n.contextData.blockContentRotation=t.value;break;case 93:n.contextData.blockContentColor=t.value;break;case 47:n.contextData.blockTransformationMatrix=Zt(e,47);break;case 110:n.contextData.planeOriginPoint=qt(e);break;case 111:n.contextData.planeXAxisDirection=qt(e);break;case 112:n.contextData.planeYAxisDirection=qt(e);break;case 297:n.contextData.planeNormalReversed=t.value;break;case 301:return;case 302:o()}t=e.next()}}function o(){const a={leaderLines:[]};for(n.contextData.leaders.push(a);!e.isEOF();){switch(t.code){case 290:a.hasSetLastLeaderLinePoint=t.value;break;case 291:a.hasSetDoglegVector=t.value;break;case 10:a.lastLeaderLinePoint=qt(e);break;case 11:a.doglegVector=qt(e);break;case 90:a.leaderBranchIndex=t.value;break;case 40:a.doglegLength=t.value;break;case 303:return;case 304:s()}t=e.next()}}function s(){const a={vertices:[[]]};for(n.contextData.leaders[n.contextData.leaders.length-1].leaderLines.push(a);!e.isEOF();){switch(t.code){case 10:a.vertices[0].push(qt(e));break;case 305:return}t=e.next()}}return n.contextData={leaders:[]},t=e.next(),function(){for(;!e.isEOF();){switch(t.code){case 0:return;case 340:n.leaderStyleId=t.value;break;case 170:n.leaderLineType=t.value;break;case 91:n.leaderLineColor=t.value;break;case 341:n.leaderLineTypeId=t.value;break;case 171:n.leaderLineWeight=t.value;break;case 41:n.doglegLength=t.value;break;case 290:n.enableLanding=t.value;break;case 291:n.enableDogLeg=t.value;break;case 342:n.arrowHeadId=t.value;break;case 42:n.arrowHeadSize=t.value;break;case 172:n.contentType=t.value;break;case 173:case 95:n.textLeftAttachmentType=t.value;break;case 174:n.textAngleType=t.value;break;case 175:n.textAlignmentType=t.value;break;case 343:n.textStyleId=t.value;break;case 92:n.textColor=t.value;break;case 292:n.enableFrameText=t.value;break;case 344:n.blockContentId=t.value;break;case 93:n.blockContentColor=t.value;break;case 10:n.blockContentScale=qt(e);break;case 43:n.blockContentRotation=t.value;break;case 176:n.blockContentConnectionType=t.value;break;case 293:n.enableAnotationScale=t.value;break;case 94:n.arrowHeadIndex=t.value;break;case 330:n.blockAttributeId=t.value;break;case 177:n.blockAttributeIndex=t.value;break;case 44:n.blockAttributeWidth=t.value;break;case 302:n.blockAttributeTextString=t.value;break;case 294:n.textDirectionNegative=t.value;break;case 178:n.textAlignInIPE=t.value;break;case 179:n.textAttachmentPoint=t.value;break;case 271:n.textAttachmentDirectionMText=t.value;break;case 272:n.textAttachmentDirectionBottom=t.value;break;case 273:n.textAttachmentDirectionTop=t.value;break;case 300:a();break;default:Kt(n,t,e)}t=e.next()}}(),n}}var mn=Object.defineProperty,xn=(e,t,n)=>(((e,t,n)=>{t in e?mn(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);let vn=class{constructor(){xn(this,"ForEntityName","ELLIPSE")}parseEntity(e,t){const n={type:t.value};for(t=e.next();!e.isEOF()&&0!==t.code;){switch(t.code){case 10:n.center=qt(e);break;case 11:n.majorAxisEndPoint=qt(e);break;case 40:n.axisRatio=t.value;break;case 41:n.startAngle=t.value;break;case 42:n.endAngle=t.value;break;case 2:n.name=t.value;break;case 210:n.extrusionDirection=qt(e);break;default:Kt(n,t,e)}t=e.next()}return n}};var gn=Object.defineProperty,wn=(e,t,n)=>(((e,t,n)=>{t in e?gn(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);let kn=class{constructor(){wn(this,"ForEntityName","INSERT")}parseEntity(e,t){const n={type:t.value};for(t=e.next();!e.isEOF()&&0!==t.code;){switch(t.code){case 2:n.name=t.value;break;case 41:n.xScale=t.value;break;case 42:n.yScale=t.value;break;case 43:n.zScale=t.value;break;case 10:n.position=qt(e);break;case 50:n.rotation=t.value;break;case 70:n.columnCount=t.value;break;case 71:n.rowCount=t.value;break;case 44:n.columnSpacing=t.value;break;case 45:n.rowSpacing=t.value;break;case 210:n.extrusionDirection=qt(e);break;default:Kt(n,t,e)}t=e.next()}return n.extrusionDirection&&-1===n.extrusionDirection.z&&(n.position.x=-n.position.x),n}};var En=Object.defineProperty,Pn=(e,t,n)=>(((e,t,n)=>{t in e?En(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);let Ln=class{constructor(){Pn(this,"ForEntityName","LINE")}parseEntity(e,t){const n={type:t.value,vertices:[]};for(t=e.next();!e.isEOF()&&0!==t.code;){switch(t.code){case 10:n.vertices.unshift(qt(e));break;case 11:n.vertices.push(qt(e));break;case 210:n.extrusionDirection=qt(e);break;case 100:break;default:Kt(n,t,e)}0!==n.vertices.length&&n.vertices.forEach(((e,t)=>{if(0===t){const t=e.x+"",a=e.y+"";if(t.split(".").length>1){const e=t.split(".")[0];if(0!==t.split(".")[1].length){const t=100*Number(e);n.offsetX=t}}if(a.split(".").length>1){const e=a.split(".")[0];if(0!==a.split(".")[1].length){const t=100*Number(e);n.offsetY=t}}}})),t=e.next()}return n}};var Mn=Object.defineProperty,On=(e,t,n)=>(((e,t,n)=>{t in e?Mn(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);let Dn=class{constructor(){On(this,"ForEntityName","LWPOLYLINE")}parseEntity(e,t){const n={type:t.value,vertices:[]};let a=0;for(t=e.next();!e.isEOF()&&0!==t.code;){switch(t.code){case 38:n.elevation=t.value;break;case 39:n.depth=t.value;break;case 70:n.shape=1==(1&t.value),n.hasContinuousLinetypePattern=128==(128&t.value);break;case 90:a=t.value;break;case 10:n.vertices=Sn(a,e);break;case 43:0!==t.value&&(n.width=t.value);break;case 210:n.extrusionDirectionX=t.value;break;case 220:n.extrusionDirectionY=t.value;break;case 230:n.extrusionDirectionZ=t.value;break;default:Kt(n,t,e)}if(0!==n.vertices.length){let e=null,t=null;n.vertices.forEach(((n,a)=>{const o=n.x+"",s=n.y+"";if(o.split(".").length>1){const t=o.split(".")[0];0!==o.split(".")[1].length&&(!e||e<100*Number(t))&&(e=100*Number(t))}if(s.split(".").length>1){const e=s.split(".")[0];0!==s.split(".")[1].length&&(!t||t<100*Number(e))&&(t=100*Number(e))}})),n.offsetX=e,n.offsetY=t}t=e.next()}return n}};function Sn(e,t){if(!e||e<=0)throw Error("n must be greater than 0 verticies");const n=[];let a=!1,o=!1,s=t.lastReadGroup;for(let i=0;i<e;i++){const e={};for(;!t.isEOF()&&0!==s.code&&!o;){switch(s.code){case 10:if(a){o=!0;continue}e.x=s.value,a=!0;break;case 20:e.y=s.value;break;case 30:e.z=s.value;break;case 40:e.startWidth=s.value;break;case 41:e.endWidth=s.value;break;case 42:0!=s.value&&(e.bulge=s.value);break;default:return t.rewind(),a&&n.push(e),t.rewind(),n}s=t.next()}n.push(e),a=!1,o=!1}return t.rewind(),n}var Tn=Object.defineProperty,Nn=(e,t,n)=>(((e,t,n)=>{t in e?Tn(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);let Cn=class{constructor(){Nn(this,"ForEntityName","MTEXT")}parseEntity(e,t){const n={type:t.value};for(t=e.next();!e.isEOF()&&0!==t.code;){switch(t.code){case 3:case 1:n.text?n.text+=t.value:n.text=t.value;break;case 7:n.textStyleName=t.value;break;case 10:n.position=qt(e);break;case 11:n.directionVector=qt(e);break;case 40:n.height=t.value;break;case 41:n.width=t.value;break;case 50:n.rotation=t.value;break;case 71:n.attachmentPoint=t.value;break;case 72:n.drawingDirection=t.value;break;case 90:n.backgroundFillSetting=t.value;break;case 100:n.subClassMarker=t.value;break;case 210:n.extrusionDirection=qt(e);break;default:Kt(n,t,e)}t=e.next()}return n}};var An=Object.defineProperty,jn=(e,t,n)=>(((e,t,n)=>{t in e?An(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);let Fn=class{constructor(){jn(this,"ForEntityName","POINT")}parseEntity(e,t){const n={type:t.value};for(t=e.next();!e.isEOF()&&0!==t.code;){switch(t.code){case 10:n.position=qt(e);break;case 39:n.thickness=t.value;break;case 210:n.extrusionDirection=qt(e);break;case 100:break;default:Kt(n,t,e)}t=e.next()}return n}};var Vn=Object.defineProperty,In=(e,t,n)=>(((e,t,n)=>{t in e?Vn(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);var zn=Object.defineProperty,Yn=(e,t,n)=>(((e,t,n)=>{t in e?zn(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);let Bn=class{constructor(){Yn(this,"ForEntityName","POLYLINE")}parseEntity(e,t){var n={type:t.value,vertices:[]};for(t=e.next();!e.isEOF()&&0!==t.code;){switch(t.code){case 10:case 20:case 30:case 40:case 41:case 71:case 72:case 73:case 74:case 75:break;case 39:n.thickness=t.value;break;case 70:n.shape=0!=(1&t.value),n.includesCurveFitVertices=0!=(2&t.value),n.includesSplineFitVertices=0!=(4&t.value),n.is3dPolyline=0!=(8&t.value),n.is3dPolygonMesh=0!=(16&t.value),n.is3dPolygonMeshClosed=0!=(32&t.value),n.isPolyfaceMesh=0!=(64&t.value),n.hasContinuousLinetypePattern=0!=(128&t.value);break;case 210:n.extrusionDirection=qt(e);break;default:Kt(n,t,e)}0!==n.vertices.length&&n.vertices.some(((e,t)=>{if(0===t){const t=e.x+"",a=e.y+"";if(t.split(".").length>1){const e=t.split(".")[0];if(0!==t.split(".")[1].length){const t=100*Number(e);n.offsetX=t}}if(a.split(".").length>1){const e=a.split(".")[0];if(0!==a.split(".")[1].length){const t=100*Number(e);n.offsetY=t}}}if(e.bulge)return n.offsetX=null,n.offsetY=null,!0})),t=e.next()}return n.vertices=function(e,t){const n=new class{constructor(){In(this,"ForEntityName","VERTEX")}parseEntity(e,t){var n={type:t.value};for(t=e.next();!e.isEOF()&&0!==t.code;){switch(t.code){case 10:n.x=t.value;break;case 20:n.y=t.value;break;case 30:n.z=t.value;break;case 40:case 41:case 50:break;case 42:0!=t.value&&(n.bulge=t.value);break;case 70:n.curveFittingVertex=0!=(1&t.value),n.curveFitTangent=0!=(2&t.value),n.splineVertex=0!=(8&t.value),n.splineControlPoint=0!=(16&t.value),n.threeDPolylineVertex=0!=(32&t.value),n.threeDPolylineMesh=0!=(64&t.value),n.polyfaceMeshVertex=0!=(128&t.value);break;case 71:n.faceA=t.value;break;case 72:n.faceB=t.value;break;case 73:n.faceC=t.value;break;case 74:n.faceD=t.value;break;default:Kt(n,t,e)}t=e.next()}return n}},a=[];for(;!e.isEOF();)if(0===t.code)if("VERTEX"===t.value)a.push(n.parseEntity(e,t)),t=e.lastReadGroup;else if("SEQEND"===t.value){Rn(e,t);break}return a}(e,t),n}};function Rn(e,t){const n={type:t.value};for(t=e.next();!e.isEOF()&&0!=t.code;)Kt(n,t,e),t=e.next();return n}var Hn=Object.defineProperty,Xn=(e,t,n)=>(((e,t,n)=>{t in e?Hn(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);let _n=class{constructor(){Xn(this,"ForEntityName","SOLID")}parseEntity(e,t){const n={type:t.value,points:[]};for(t=e.next();!e.isEOF()&&0!==t.code;){switch(t.code){case 10:n.points[0]=qt(e);break;case 11:n.points[1]=qt(e);break;case 12:n.points[2]=qt(e);break;case 13:n.points[3]=qt(e);break;case 210:n.extrusionDirection=qt(e);break;default:Kt(n,t,e)}t=e.next()}return n}};var Gn=Object.defineProperty,Wn=(e,t,n)=>(((e,t,n)=>{t in e?Gn(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);let Un=class{constructor(){Wn(this,"ForEntityName","SPLINE")}parseEntity(e,t){const n={type:t.value};for(t=e.next();!e.isEOF()&&0!==t.code;){switch(t.code){case 10:n.controlPoints||(n.controlPoints=[]),n.controlPoints.push(qt(e));break;case 11:n.fitPoints||(n.fitPoints=[]),n.fitPoints.push(qt(e));break;case 12:n.startTangent=qt(e);break;case 13:n.endTangent=qt(e);break;case 40:n.knotValues||(n.knotValues=[]),n.knotValues.push(t.value);break;case 70:1&t.value&&(n.closed=!0),2&t.value&&(n.periodic=!0),4&t.value&&(n.rational=!0),8&t.value&&(n.planar=!0),16&t.value&&(n.planar=!0,n.linear=!0);break;case 71:n.degreeOfSplineCurve=t.value;break;case 72:n.numberOfKnots=t.value;break;case 73:n.numberOfControlPoints=t.value;break;case 74:n.numberOfFitPoints=t.value;break;case 210:n.normalVector=qt(e);break;default:Kt(n,t,e)}t=e.next()}return n}};var qn=Object.defineProperty,Zn=(e,t,n)=>(((e,t,n)=>{t in e?qn(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);class Kn{constructor(){Zn(this,"ForEntityName","TEXT")}parseEntity(e,t){const n={type:t.value};for(t=e.next();!e.isEOF()&&0!==t.code;){switch(t.code){case 10:n.startPoint=qt(e);break;case 11:n.endPoint=qt(e);break;case 40:n.textHeight=t.value;break;case 41:n.xScale=t.value;break;case 50:n.rotation=t.value;break;case 1:n.text=t.value;break;case 72:n.halign=t.value;break;case 73:n.valign=t.value;break;default:Kt(n,t,e)}t=e.next()}return n}}var Jn=Object.defineProperty,$n=(e,t,n)=>(((e,t,n)=>{t in e?Jn(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);let Qn=class{constructor(){$n(this,"ForEntityName","MLINE")}parseEntity(e,t){const n={type:t.value,startPoint:[],vertices:[],directionVector:[],miterDirectionVector:[]};for(t=e.next();!e.isEOF()&&0!==t.code;){switch(t.code){case 2:n.mlineStype=t.value;break;case 10:n.startPoint.push(qt(e));break;case 11:n.vertices.push(qt(e));break;case 12:n.directionVector.push(qt(e));break;case 13:n.miterDirectionVector.push(qt(e));break;case 40:n.scaleFactor=t.value;break;case 70:n.justification=t.value;break;case 71:n.flags=t.value;break;case 72:n.verticesNum=t.value;break;case 73:n.elementsNum=t.value;break;case 210:n.extrusionDirection=qt(e);break;case 100:break;default:Kt(n,t,e)}0!==n.vertices.length&&n.vertices.forEach(((e,t)=>{if(0===t){const t=e.x+"",a=e.y+"";if(t.split(".").length>1){const e=t.split(".")[0];if(0!==t.split(".")[1].length){const t=100*Number(e);n.offsetX=t}}if(a.split(".").length>1){const e=a.split(".")[0];if(0!==a.split(".")[1].length){const t=100*Number(e);n.offsetY=t}}}})),t=e.next()}return n}};var ea=Object.defineProperty,ta=(e,t,n)=>(((e,t,n)=>{t in e?ea(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);function na(e){e.registerEntityHandler(Qt),e.registerEntityHandler(an),e.registerEntityHandler(rn),e.registerEntityHandler(hn),e.registerEntityHandler(pn),e.registerEntityHandler(fn),e.registerEntityHandler(vn),e.registerEntityHandler(kn),e.registerEntityHandler(Ln),e.registerEntityHandler(Dn),e.registerEntityHandler(Cn),e.registerEntityHandler(Fn),e.registerEntityHandler(Bn),e.registerEntityHandler(_n),e.registerEntityHandler(Un),e.registerEntityHandler(Kn),e.registerEntityHandler(Qn)}class aa{constructor(){ta(this,"_entityHandlers",{}),na(this)}parse(e){return"string"==typeof e?this._parse(e):(console.error("Cannot read dxf source of type `"+typeof e),null)}registerEntityHandler(e){const t=new e;this._entityHandlers[t.ForEntityName]=t}parseSync(e){return this.parse(e)}parseStream(e){let t="";const n=this;return new Promise(((a,o)=>{e.on("data",(e=>{t+=e})),e.on("end",(()=>{try{a(n._parse(t))}catch(e){o(e)}})),e.on("error",(e=>{o(e)}))}))}_parse(e){const t={};let n=0;const a=e.split(/\r\n|\r|\n/g),o=new class{constructor(e){Gt(this,"_pointer",0),Gt(this,"_eof",!1),Gt(this,"lastReadGroup"),Gt(this,"_data"),this._data=e}next(){if(!this.hasNext())throw this._eof?new Error("Cannot call 'next' after EOF group has been read"):new Error("Unexpected end of input: EOF group not read before end of file. Ended on code "+this._data[this._pointer]);const e={code:parseInt(this._data[this._pointer])};return this._pointer++,e.value=Wt(e.code,this._data[this._pointer].trim()),this._pointer++,0===e.code&&"EOF"===e.value&&(this._eof=!0),this.lastReadGroup=e,e}peek(){if(!this.hasNext())throw this._eof?new Error("Cannot call 'next' after EOF group has been read"):new Error("Unexpected end of input: EOF group not read before end of file. Ended on code "+this._data[this._pointer]);const e={code:parseInt(this._data[this._pointer])};return e.value=Wt(e.code,this._data[this._pointer+1].trim()),e}rewind(e=1){this._pointer=this._pointer-2*e}hasNext(){return!(this._eof||this._pointer>this._data.length-2)}isEOF(){return this._eof}}(a);if(!o.hasNext())throw Error("Empty file");const s=this;let i;function r(){let e=null,t=null;const n={};for(i=o.next();;){if(oa(i,0,"ENDSEC")){e&&(n[e]=t);break}9===i.code?(e&&(n[e]=t),e=i.value):10===i.code?t={x:i.value}:20===i.code?t.y=i.value:30===i.code?t.z=i.value:t=i.value,i=o.next()}return i=o.next(),n}function c(){const e={mlineStyle:{}};for(i=o.next();"ENDSEC"!==i.value;)if(oa(i,0,"MLINESTYLE")){i=o.next();let t={mlineData:[]};for(;;){switch(i.code){case 2:t.mlineStyleName=i.value;break;case 49:t.mlineData.push(l(i));break;case 51:t.startAngle=i.value;break;case 52:t.endAngle=i.value;break;case 70:t.flags=i.value}if(0===i.code){e.mlineStyle[t.mlineStyleName]=t;break}i=o.next()}}else i=o.next();return e}function l(e){let t={};return e.code,t.elementOffset=e.value,e=o.next(),t.fillColor=e.value,e=o.next(),t.lineType=e.value,t}function h(){const e={};for(i=o.next();"EOF"!==i.value&&!oa(i,0,"ENDSEC");)if(oa(i,0,"BLOCK")){const t=u();x(t),t.name?e[t.name]=t:console.log('block with handle "'+t.handle+'" is missing a name.')}else i=o.next();return e}function u(){const e={};for(i=o.next();"EOF"!==i.value;){switch(i.code){case 1:e.xrefPath=i.value,i=o.next();break;case 2:e.name=i.value,i=o.next();break;case 3:e.name2=i.value,i=o.next();break;case 5:e.handle=i.value,i=o.next();break;case 8:e.layer=i.value,i=o.next();break;case 10:e.position=m(i),i=o.next();break;case 67:e.paperSpace=!(!i.value||1!=i.value),i=o.next();break;case 70:0!=i.value&&(e.type=i.value),i=o.next();break;case 100:default:i=o.next();break;case 330:e.ownerHandle=i.value,i=o.next();break;case 0:if("ENDBLK"==i.value)break;e.entities=f(!0)}if(oa(i,0,"ENDBLK")){i=o.next();break}}for(let t=0;t<e.entities?.length;t++)if(e.position&&0!==e.position.x){const n={x:e.position.x,y:e.position.y};e.entities[t].vertices&&e.entities[t].vertices.forEach((e=>{e.x=n.x-e.x,e.y=n.y-e.y,e.z=n.z-e.z})),e.entities[t].center&&(e.entities[t].center.x=n.x-e.entities[t].center.x,e.entities[t].center.y=n.y-e.entities[t].center.y)}return e}function d(){const e={};for(i=o.next();"EOF"!==i.value&&!oa(i,0,"ENDSEC");)oa(i,0,"TABLE")?(i=o.next(),y[i.value]&&(e[y[i.value].tableName]=b(i))):i=o.next();return i=o.next(),e}const p="ENDTAB";function b(e){const t=y[e.value],n={};for(i=o.next();!oa(i,0,p);)switch(i.code){case 5:n.handle=i.value,i=o.next();break;case 330:n.ownerHandle=i.value,i=o.next();break;case 100:case 70:i.value,i=o.next();break;case 0:i.value===t.dxfSymbolName?n[t.tableRecordsProperty]=t.parseTableRecords():i=o.next();break;default:i=o.next()}const a=n[t.tableRecordsProperty];return a&&(a.constructor===Array?a.length:"object"==typeof a&&Object.keys(a).length),i=o.next(),n}const y={VPORT:{tableRecordsProperty:"viewPorts",tableName:"viewPort",dxfSymbolName:"VPORT",parseTableRecords:function(){const e=[];let t={};for(i=o.next();!oa(i,0,p);)switch(i.code){case 2:t.name=i.value,i=o.next();break;case 10:t.lowerLeftCorner=m(i),i=o.next();break;case 11:t.upperRightCorner=m(i),i=o.next();break;case 12:t.center=m(i),i=o.next();break;case 13:t.snapBasePoint=m(i),i=o.next();break;case 14:t.snapSpacing=m(i),i=o.next();break;case 15:t.gridSpacing=m(i),i=o.next();break;case 16:t.viewDirectionFromTarget=m(i),i=o.next();break;case 17:t.viewTarget=m(i),i=o.next();break;case 42:t.lensLength=i.value,i=o.next();break;case 43:t.frontClippingPlane=i.value,i=o.next();break;case 44:t.backClippingPlane=i.value,i=o.next();break;case 45:t.viewHeight=i.value,i=o.next();break;case 50:t.snapRotationAngle=i.value,i=o.next();break;case 51:t.viewTwistAngle=i.value,i=o.next();break;case 79:t.orthographicType=i.value,i=o.next();break;case 110:t.ucsOrigin=m(i),i=o.next();break;case 111:t.ucsXAxis=m(i),i=o.next();break;case 112:t.ucsYAxis=m(i),i=o.next();break;case 281:t.renderMode=i.value,i=o.next();break;case 282:t.defaultLightingType=i.value,i=o.next();break;case 292:t.defaultLightingOn=i.value,i=o.next();break;case 330:t.ownerHandle=i.value,i=o.next();break;case 63:case 421:case 431:t.ambientColor=i.value,i=o.next();break;case 0:"VPORT"===i.value&&(e.push(t),t={},i=o.next());break;default:i=o.next()}return e.push(t),e}},LTYPE:{tableRecordsProperty:"lineTypes",tableName:"lineType",dxfSymbolName:"LTYPE",parseTableRecords:function(){const e={};let t,n={},a=0;for(i=o.next();!oa(i,0,"ENDTAB");)switch(i.code){case 2:n.name=i.value,t=i.value,i=o.next();break;case 3:n.description=i.value,i=o.next();break;case 73:a=i.value,a>0&&(n.pattern=[]),i=o.next();break;case 40:n.patternLength=i.value,i=o.next();break;case 49:n.pattern.push(i.value),i=o.next();break;case 0:a>0&&a!==n.pattern.length&&console.log("lengths do not match on LTYPE pattern"),e[t]=n,n={},i=o.next();break;default:i=o.next()}return e[t]=n,e}},LAYER:{tableRecordsProperty:"layers",tableName:"layer",dxfSymbolName:"LAYER",parseTableRecords:function(){const e={};let t,n={};for(i=o.next();!oa(i,0,"ENDTAB");)switch(i.code){case 2:n.name=i.value,t=i.value,i=o.next();break;case 62:n.visible=i.value>=0,n.colorIndex=Math.abs(i.value),n.color=(a=n.colorIndex,Ut[a]),i=o.next();break;case 70:n.frozen=0!=(1&i.value)||0!=(2&i.value),i=o.next();break;case 420:n.color=Math.abs(i.value),i=o.next();break;case 0:"LAYER"===i.value&&(e[t]=n,n={},t=void 0,i=o.next());break;default:i=o.next()}var a;return e[t]=n,e}}};function f(e){const t=[],n=e?"ENDBLK":"ENDSEC";for(e||(i=o.next());;)if(0===i.code){if(i.value===n)break;const e=s._entityHandlers[i.value];if(null==e){i=o.next();continue}{const n=e.parseEntity(o,i);i=o.lastReadGroup,x(n),t.push(n)}}else i=o.next();return"ENDSEC"==n&&(i=o.next()),t}function m(e){const t={};let n=e.code;if(t.x=e.value,n+=10,(e=o.next()).code!=n)throw new Error("Expected code for point value to be "+n+" but got "+e.code+".");return t.y=e.value,n+=10,(e=o.next()).code!=n?(o.rewind(),t):(t.z=e.value,t)}function x(e){if(!e)throw new TypeError("entity cannot be undefined or null");e.handle||(e.handle=n++)}return function(){for(i=o.next();!o.isEOF();)if(0===i.code&&"SECTION"===i.value){if(i=o.next(),2!==i.code){console.error("Unexpected code %s after 0:SECTION",(e=i).code+":"+e.value),i=o.next();continue}"HEADER"===i.value?t.header=r():"BLOCKS"===i.value?t.blocks=h():"ENTITIES"===i.value?t.entities=f(!1):"TABLES"===i.value?t.tables=d():"EOF"===i.value?console.log("EOF"):"OBJECTS"===i.value&&(t.objects=c())}else i=o.next();var e}(),t}}function oa(e,t,n){return e.code===t&&e.value===n}var sa=Object.defineProperty,ia=(e,t,n)=>(((e,t,n)=>{t in e?sa(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);const ra=(e,t)=>{let n=null;if(e.color)n=e.color;else if(0===e.colorIndex)n=16777215;else if(t.tables&&t.tables.layer&&t.tables.layer.layers[e.layer]){const{visible:a,frozen:o}=t.tables.layer.layers[e.layer];if(!a||o)return null;n=t.tables.layer.layers[e.layer].color}const{type:a,extendColor:o,blockColor:s,layerColor:i,layer:r}=e;return(0===e.color||"MTEXT"===a)&&(o&&"byBlock"===o?n=s:o&&"byLayer"===o&&(n=i)),void 0===e.color&&void 0===e.colorIndex&&"0"===r&&i&&(n=i),n};class ca{constructor(e=0,t=0){ia(this,"x"),ia(this,"y"),this.x=e,this.y=t}distanceTo(e){return Math.sqrt(this.distanceToSquared(e))}distanceToSquared(e){const t=this.x-e.x,n=this.y-e.y;return t*t+n*n}sub(e){return this.x-=e.x,this.y-=e.y,this}normalize(){return this.divideScalar(this.length()||1)}divideScalar(e){return this.multiplyScalar(1/e)}multiplyScalar(e){return this.x*=e,this.y*=e,this}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}}class la extends ca{constructor(e=0,t=0,n=0){super(e,t),ia(this,"z"),this.z=n}distanceTo(e){return Math.sqrt(this.distanceToSquared(e))}distanceToSquared(e){const t=this.x-e.x,n=this.y-e.y,a=this.z-e.z;return t*t+n*n+a*a}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this}normalize(){return this.divideScalar(this.length()||1)}divideScalar(e){return this.multiplyScalar(1/e)}multiplyScalar(e){return this.x*=e,this.y*=e,this.z*=e,this}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this}cross(e){return this.crossVectors(this,e)}crossVectors(e,t){const n=e.x,a=e.y,o=e.z,s=t.x,i=t.y,r=t.z;return this.x=a*r-o*i,this.y=o*s-n*r,this.z=n*i-a*s,this}}var ha=Object.defineProperty,ua=(e,t,n)=>(((e,t,n)=>{t in e?ha(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);let da=class{constructor(){ua(this,"position",[]),ua(this,"color",16777215),ua(this,"positions",[]),ua(this,"colors",[])}flatPosition(){let e=[];this.position.forEach((t=>{e.push(t.x,t.y,0)})),this.positions=e}changeToLineSegments(){if(this.positions.length>6){const e=this.positions.length/3;let t=0;for(let n=1;n<e-1;n++){const e=3*n+3*t;this.positions.splice(e,0,this.positions[e],this.positions[e+1],this.positions[e+2]),t++}}}getMaxOrMinPositionArray(){let e={max:new ca(0,0),min:new ca(0,0)};return this.position.forEach(((t,n)=>{0===n?(e.max.x=t.x,e.min.x=t.x,e.max.y=t.y,e.min.y=t.y):(e.min.x>t.x&&(e.min.x=t.x),e.min.y>t.y&&(e.min.y=t.y),e.max.x<t.x&&(e.max.x=t.x),e.max.y<t.y&&(e.max.y=t.y))})),e}};var pa=Object.defineProperty,ba=(e,t,n)=>(((e,t,n)=>{t in e?pa(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);const ya=(e,t)=>{let n=new ca(e.x,e.y),a=new ca(t.x,t.y);return a.sub(n),a.normalize(),a.y<0?-Math.acos(a.x):Math.acos(a.x)},fa=(e,t,n)=>{let a=new ca;return a.x=e.x+t*Math.cos(n),a.y=e.y+t*Math.sin(n),a},ma=(e,t,n,a)=>{let o=e?new la(e.x,e.y,0):new la(0,0,0),s=t?new la(t.x,t.y,0):new la(1,0,0);n=n||1;let i=4*Math.atan(n),r=o.distanceTo(s)/2/Math.sin(i/2),c=fa(e,r,ya(o,s)+(Math.PI/2-i/2));a=a||Math.max(Math.abs(Math.ceil(i/(Math.PI/18))),6);let l=ya(c,o),h=i/a,u=[];u.push(new la(o.x,o.y,0));for(let e=1;e<=a-1;e++){let t=fa(c,Math.abs(r),l+h*e);u.push(new la(t.x,t.y,0))}return[e,...u,t]};let xa=class extends da{constructor(e,t,n){if(super(),ba(this,"type","Line"),ba(this,"color",16777215),ba(this,"layer","0"),ba(this,"position",[]),ba(this,"isDashed",!1),ba(this,"box"),ba(this,"offsetX"),ba(this,"offsetY"),ba(this,"insertNum",-1),ba(this,"lineTypeScale"),ba(this,"lineTypeData"),ba(this,"shape"),ba(this,"mlineOffset",1),ba(this,"scaleFactor"),this.color=ra(e,t),this.type=e.type,this.offsetX=e.offsetX,this.offsetY=e.offsetY,this.insertNum=n,this.layer=e.layer,this.lineTypeScale=e.lineTypeScale,this.shape=e.shape,this.mlineOffset=e.mlineOffset,this.scaleFactor=e.scaleFactor,e.vertices)for(let t=0;t<e.vertices.length;t++)if(e.vertices[t].bulge){let n=e.vertices[t].bulge;if(t+1===e.vertices.length&&!e.shape)break;let a=new la(e.vertices[t].x,e.vertices[t].y,0),o=t+1<e.vertices.length?e.vertices[t+1]:e.vertices[0];o.z=0;let s=ma(a,o,n);this.position.push.apply(this.position,s)}else{let n=e.vertices[t];this.position.push(new la(n.x,n.y,0))}let a;e.shape&&0!==this.position.length&&this.position.push(this.position[0]),e.lineType&&(a=t.tables.lineType.lineTypes[e.lineType]),a&&a.pattern&&0!==a.pattern.length&&(this.lineTypeData=a,this.isDashed=!0),this.box=this.getMaxOrMinPositionArray(),this.flatPosition(),this.changeToLineSegments()}};var va=Object.defineProperty,ga=(e,t,n)=>(((e,t,n)=>{t in e?va(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);let wa=class{constructor(e,t,n){ga(this,"type","Text"),ga(this,"color",16777215),ga(this,"layer","0"),ga(this,"position"),ga(this,"rotation",0),ga(this,"text"),ga(this,"textHeight",12),ga(this,"box"),ga(this,"insertNum",-1),this.color=ra(e,t),this.type=e.type,this.insertNum=n,this.layer=e.layer,e.rotation&&(this.rotation=e.rotation*Math.PI/180),"ATTDEF"===this.type?this.text=e.tag:this.text=e.text,this.textHeight=e.textHeight,this.position=e.startPoint,this.box=this.getMaxOrMinPosition()}getMaxOrMinPosition(){let e={max:new ca(0,0),min:new ca(0,0)};return e.max.x=this.position.x,e.min.x=this.position.x,e.max.y=this.position.y,e.min.y=this.position.y,e}};var ka=Object.defineProperty,Ea=(e,t,n)=>(((e,t,n)=>{t in e?ka(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);class Pa{constructor(e=0,t=0,n=1,a=1,o=0,s=2*Math.PI){Ea(this,"aX"),Ea(this,"aY"),Ea(this,"xRadius"),Ea(this,"yRadius"),Ea(this,"aStartAngle"),Ea(this,"aEndAngle"),this.aX=e,this.aY=t,this.xRadius=n,this.yRadius=a,this.aStartAngle=o,this.aEndAngle=s}getPoint(e){const t=2*Math.PI;let n=this.aEndAngle-this.aStartAngle;const a=Math.abs(n)<Number.EPSILON;for(;n<0;)n+=t;for(;n>t;)n-=t;n<Number.EPSILON&&(n=a?0:t);const o=this.aStartAngle+e*n;let s=this.aX+this.xRadius*Math.cos(o),i=this.aY+this.yRadius*Math.sin(o);return new la(s,i)}getPoints(e=5){const t=[];for(let n=0;n<=e;n++)t.push(this.getPoint(n/e));return t}}let La=class extends da{constructor(e,t,n){let a,o;super(),Ea(this,"type","Arc"),Ea(this,"color",16777215),Ea(this,"layer","0"),Ea(this,"position",[]),Ea(this,"offsetX"),Ea(this,"offsetY"),Ea(this,"box"),Ea(this,"insertNum",-1),this.color=ra(e,t),this.type=e.type,this.offsetX=e.offsetX,this.offsetY=e.offsetY,this.insertNum=n,this.layer=e.layer,"CIRCLE"===this.type?(a=e.startAngle||0,o=a+2*Math.PI):(a=e.startAngle,o=e.endAngle);let s=new Pa(0,0,e.radius,e.radius,a,o);this.position=s.getPoints(50),this.position.forEach((t=>{e.center&&(t.x=t.x+e.center.x,t.y=t.y+e.center.y),-1===e.extrusionDirectionZ&&(t.x=-t.x)})),this.box=this.getMaxOrMinPositionArray(),this.flatPosition(),this.changeToLineSegments()}};var Ma=Object.defineProperty,Oa=(e,t,n)=>(((e,t,n)=>{t in e?Ma(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);const Da=(e,t,n,a)=>{let o=new la,s=new la;o.subVectors(n,t),s.subVectors(a,t),o.cross(s);let i=new la(t.x,t.y,t.z),r=new la(n.x,n.y,n.z),c=new la(a.x,a.y,a.z);o.z<0?e.push(c,r,i):e.push(i,r,c)};var Sa=Object.defineProperty,Ta=(e,t,n)=>(((e,t,n)=>{t in e?Sa(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);var Na=Object.defineProperty,Ca=(e,t,n)=>(((e,t,n)=>{t in e?Na(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);const Aa=(e,t)=>typeof t>"u"||0==+t?Math.round(e):(e=+e,t=+t,isNaN(e)||"number"!=typeof t||t%1!=0?NaN:(e=e.toString().split("e"),+((e=(e=Math.round(+(e[0]+"e"+(e[1]?+e[1]-t:-t)))).toString().split("e"))[0]+"e"+(e[1]?+e[1]+t:t)))),ja=(e,t,n,a,o)=>{const s=n.length,i=n[0].length;if(e<0||e>1)throw new Error("t out of bounds [0,1]: "+e);if(t<1)throw new Error("degree must be at least 1 (linear)");if(t>s-1)throw new Error("degree must be less than or equal to point count - 1");if(!o){o=[];for(let e=0;e<s;e++)o[e]=1}if(a){if(a.length!==s+t+1)throw new Error("bad knot vector length")}else{a=[];for(let e=0;e<s+t+1;e++)a[e]=e}const r=[t,a.length-1-t],c=a[r[0]],l=a[r[1]];let h;for(e=e*(l-c)+c,e=Math.max(e,c),e=Math.min(e,l),h=r[0];h<r[1]&&!(e>=a[h]&&e<=a[h+1]);h++);const u=[];for(let e=0;e<s;e++){u[e]=[];for(let t=0;t<i;t++)u[e][t]=n[e][t]*o[e];u[e][i]=o[e]}let d;for(let n=1;n<=t+1;n++)for(let o=h;o>h-t-1+n;o--){d=(e-a[o])/(a[o+t+1-n]-a[o]);for(let e=0;e<i+1;e++)u[o][e]=(1-d)*u[o-1][e]+d*u[o][e]}const p=[];for(let e=0;e<i;e++)p[e]=Aa(u[h][e]/u[h][i],-9);return p};var Fa=Object.defineProperty,Va=(e,t,n)=>(((e,t,n)=>{t in e?Fa(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);var Ia=Object.defineProperty,za=(e,t,n)=>(((e,t,n)=>{t in e?Ia(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);class Ya{constructor(e=0,t=0,n=1,a=1,o=0,s=2*Math.PI,i=!1,r=0){za(this,"aX"),za(this,"aY"),za(this,"xRadius"),za(this,"yRadius"),za(this,"aStartAngle"),za(this,"aEndAngle"),za(this,"aClockwise"),za(this,"aRotation"),this.aX=e,this.aY=t,this.xRadius=n,this.yRadius=a,this.aStartAngle=o,this.aEndAngle=s,this.aClockwise=i,this.aRotation=r}getPoint(e){const t=2*Math.PI;let n=this.aEndAngle-this.aStartAngle;const a=Math.abs(n)<Number.EPSILON;for(;n<0;)n+=t;for(;n>t;)n-=t;n<Number.EPSILON&&(n=a?0:t),!0===this.aClockwise&&!a&&(n===t?n=-t:n-=t);const o=this.aStartAngle+e*n;let s=this.aX+this.xRadius*Math.cos(o),i=this.aY+this.yRadius*Math.sin(o);if(0!==this.aRotation){const e=Math.cos(this.aRotation),t=Math.sin(this.aRotation),n=s-this.aX,a=i-this.aY;s=n*e-a*t+this.aX,i=n*t+a*e+this.aY}return new la(s,i)}getPoints(e=5){const t=[];for(let n=0;n<=e;n++)t.push(this.getPoint(n/e));return t}}const Ba=(e,t)=>{if(!ra(e,t))return;const{center:n,majorAxisEndPoint:a,axisRatio:o,startAngle:s,endAngle:i}=e;let r=((e,t,n,a,o,s)=>{let i,r=[];i=a<0?{x:t.x*Math.cos(Math.abs(a))-t.y*Math.sin(Math.abs(a)),y:t.x*Math.sin(Math.abs(a))+t.y*Math.cos(Math.abs(a))}:{x:t.x*Math.cos(2*Math.PI-a)-t.y*Math.sin(2*Math.PI-a),y:t.x*Math.sin(2*Math.PI-a)+t.y*Math.cos(2*Math.PI-a)};for(let e=0;e<=50;e++){let t=e/50*Math.abs(o-a);const s=new la;let c=2*Math.PI-t;const{x:l,y:h}=i;s.x=l*Math.cos(c)-h*Math.sin(c),s.y=(l*Math.sin(c)+h*Math.cos(c))*n,s.z=0,r.push(s)}return r})(0,a,o,s,i);return r.forEach((t=>{e.center&&(t.x=t.x+e.center.x,t.y=t.y+e.center.y),e.offsetX&&e.offsetY&&(t.x=100*t.x-e.offsetX,t.y=100*t.y-e.offsetY)})),r};const Ra={LINE:xa,LWPOLYLINE:xa,POLYLINE:xa,MLINE:xa,TEXT:wa,ATTDEF:wa,CIRCLE:La,ARC:La,SOLID:class{constructor(e,t,n){Oa(this,"type","Solid"),Oa(this,"color",16777215),Oa(this,"layer","0"),Oa(this,"position",[]),Oa(this,"box"),Oa(this,"offsetX"),Oa(this,"offsetY"),Oa(this,"insertNum",-1),this.color=ra(e,t),this.type=e.type,this.offsetX=e.offsetX,this.offsetY=e.offsetY,this.insertNum=n,this.layer=e.layer;let a=e.points;0!==a?.length&&(Da(this.position,a[0],a[1],a[2]),Da(this.position,a[1],a[2],a[3])),this.box=this.getMaxOrMinPosition()}getMaxOrMinPosition(){let e={max:new ca(0,0),min:new ca(0,0)};return this.position.forEach(((t,n)=>{0===n?(e.max.x=t.x,e.min.x=t.x,e.max.y=t.y,e.min.y=t.y):(e.min.x>t.x&&(e.min.x=t.x),e.min.y>t.y&&(e.min.y=t.y),e.max.x<t.x&&(e.max.x=t.x),e.max.y<t.y&&(e.max.y=t.y))})),e}},POINT:class{constructor(e,t,n){Ta(this,"type","Point"),Ta(this,"color",16777215),Ta(this,"layer","0"),Ta(this,"position"),Ta(this,"box"),Ta(this,"offsetX"),Ta(this,"offsetY"),Ta(this,"insertNum",-1),this.color=ra(e,t),this.type=e.type,this.offsetX=e.offsetX,this.offsetY=e.offsetY,this.position=e.position,this.insertNum=n,this.layer=e.layer,this.box=this.getMaxOrMinPosition()}getMaxOrMinPosition(){let e={max:new ca(0,0),min:new ca(0,0)};return e.max.x=this.position.x,e.min.x=this.position.x,e.max.y=this.position.y,e.min.y=this.position.y,e}},SPLINE:class extends da{constructor(e,t,n){super(),Ca(this,"type","Spline"),Ca(this,"color",16777215),Ca(this,"layer","0"),Ca(this,"position",[]),Ca(this,"box"),Ca(this,"offsetX"),Ca(this,"offsetY"),Ca(this,"insertNum",-1),this.color=ra(e,t),this.type=e.type,this.offsetX=e.offsetX,this.offsetY=e.offsetY,this.insertNum=n,this.layer=e.layer,this.position=((e,t,n,a)=>{const o=[],s=e.map((function(e){return[e.x,e.y]})),i=[n[t]],r=[n[t],n[n.length-1-t]];for(let e=t+1;e<n.length-t;++e)i[i.length-1]!==n[e]&&i.push(n[e]);a=a||25;for(let e=1;e<i.length;++e){const c=i[e-1],l=i[e];for(let e=0;e<=a;++e){let i=(e/a*(l-c)+c-r[0])/(r[1]-r[0]);i=Math.max(i,0),i=Math.min(i,1);const h=ja(i,t,s,n);o.push(new la(h[0],h[1]))}}return o})(e.controlPoints,e.degreeOfSplineCurve,e.knotValues,100),this.box=this.getMaxOrMinPositionArray(),this.flatPosition(),this.changeToLineSegments()}},MTEXT:class{constructor(e,t,n){Va(this,"type","MText"),Va(this,"color",16777215),Va(this,"layer","0"),Va(this,"width"),Va(this,"position"),Va(this,"rotation"),Va(this,"directionVector"),Va(this,"extrusionDirection"),Va(this,"attachmentPoint"),Va(this,"text"),Va(this,"style"),Va(this,"box"),Va(this,"insertNum",-1),Va(this,"height"),this.color=ra(e,t),this.type=e.type,this.width=e.width,this.position=e.position,this.directionVector=e.directionVector,this.extrusionDirection=e.extrusionDirection,this.position=e.position,this.rotation=e.rotation,this.attachmentPoint=e.attachmentPoint,this.insertNum=n,this.layer=e.layer,this.text=e.text,this.height=e.height,this.box=this.getMaxOrMinPosition()}getMaxOrMinPosition(){let e={max:new ca(0,0),min:new ca(0,0)};return e.max.x=this.position.x,e.min.x=this.position.x,e.max.y=this.position.y,e.min.y=this.position.y,e}},ELLIPSE:class extends da{constructor(e,t,n){if(super(),za(this,"type","Ellipse"),za(this,"color",16777215),za(this,"layer","0"),za(this,"position",[]),za(this,"box"),za(this,"offsetX"),za(this,"offsetY"),za(this,"insertNum",-1),this.color=ra(e,t),this.type=e.type,this.offsetX=e.offsetX,this.offsetY=e.offsetY,this.insertNum=n,this.layer=e.layer,e.extrusionDirection&&1===e.extrusionDirection.z){let t,n,a;e.majorAxisEndPoint&&e.axisRatio&&(t=Math.sqrt(Math.pow(e.majorAxisEndPoint.x,2)+Math.pow(e.majorAxisEndPoint.y,2)),n=t*e.axisRatio,a=Math.atan2(e.majorAxisEndPoint.y,e.majorAxisEndPoint.x));let o=new Ya(0,0,t,n,e.startAngle,e.endAngle,!1,a);this.position=o.getPoints(50),this.position.forEach((t=>{e.center&&(t.x=t.x+e.center.x,t.y=t.y+e.center.y)}))}else this.position=Ba(e,t);this.box=this.getMaxOrMinPositionArray(),this.flatPosition(),this.changeToLineSegments()}}};let Ha;const Xa=(e,t=-1)=>{Ha=e,console.log("原始dxf数据",e);let n=[],a=[],o=null;for(let t=0;t<e.entities?.length;t++){const{type:s,dimensionType:i}=e.entities[t],r=e.entities[t];if(!1===r.visible||r.inPaperSpace)continue;const{visible:c,frozen:l}=Ha.tables.layer.layers[r.layer];if(!1===c||!0===l)continue;let h=null;if("DIMENSION"===s){if(!(7&i)){const e=_a(r,t);e&&a.push(e)}}else if("INSERT"===s){const e=_a(r,t);e&&a.push(e)}else if(Ra[s]){if("MLINE"===s){const e=Ha.objects.mlineStyle[r.mlineStype];r.mlineOffset=Math.abs(e.mlineData[0].elementOffset-e.mlineData[1].elementOffset)}const e=new Ra[s](r,Ha,t);h=e.box,n.push(e)}else console.log("解析到shape过程未处理的类型",s);null===o?o=h:h&&(o.min.x>h.min.x&&(o.min.x=h.min.x),o.min.y>h.min.y&&(o.min.y=h.min.y),o.max.x<h.max.x&&(o.max.x=h.max.x),o.max.y<h.max.y&&(o.max.y=h.max.y))}return{models:n,box:o,insert:a}},_a=(e,t)=>{let n,a;n="0"===e.layer&&e.layerColor?e.layerColor:Ha.tables.layer.layers[e.layer].color,a=void 0!==e.color||void 0!==e.colorIndex||e.blockColor?e.color?e.color:e.blockColor:n;let o={scale:{x:null,y:null,z:null},rotation:null,position:null};e.xScale&&(o.scale.x=e.xScale),e.yScale&&(o.scale.y=e.yScale),e.zScale&&(o.scale.z=e.zScale),e.rotation&&(o.rotation=e.rotation),e.position&&(o.position=e.position);let s,i=[],r=[];s="INSERT"===e.type?Ha.blocks[e.name]:Ha.blocks[e.block];for(let o=0;o<s.entities?.length;o++){const c=s.entities[o],{type:l,dimensionType:h,colorIndex:u,color:d}=c;if(!1===c.visible)continue;const{visible:p,frozen:b}=Ha.tables.layer.layers[c.layer];if(!1!==p&&!0!==b)if((!d||"MTEXT"===l)&&(0===u&&a?(c.blockColor=a,c.extendColor="byBlock"):0!==u||a?(c.layerColor=n,c.extendColor="byLayer"):(c.blockColor=16777215,c.extendColor="byBlock")),"0"===c.layer&&(e.layer.includes(" @ ")?c.layer=e.layer.split(" @ ")[0]:c.layer=e.layer),"DIMENSION"===l){if(!(7&h)){const e=_a(c,t);e&&r.push(e)}}else if("INSERT"===l){const e=_a(c,t);e&&r.push(e)}else{const e=new Ra[l](c,Ha,t);i.push(e)}}return 0===i.length&&0===r.length?null:{models:i,groupData:o,insert:r,insertNum:t}};var Ga=Object.defineProperty,Wa=(e,t,n)=>(((e,t,n)=>{t in e?Ga(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);class Ua{constructor(t,n){Wa(this,"font",null),Wa(this,"cadUrl"),Wa(this,"container"),Wa(this,"renderer",new e.WebGLRenderer({antialias:!0})),Wa(this,"scene",new e.Scene),Wa(this,"camera",null),Wa(this,"controls",null),Wa(this,"addMoveEvent",(()=>{})),Wa(this,"deleteMoveEvent",(()=>{})),Wa(this,"modelGroupByLayer",{}),Wa(this,"textData",[]),Wa(this,"finishCallBack",(()=>{})),Wa(this,"progressCallBack",(()=>{})),Wa(this,"progress",0),Wa(this,"isLoadingLocal"),Wa(this,"isLoadingFinish"),n.includes(".dxf")?this.isLoadingLocal=!0:this.isLoadingLocal=!1,this.isLoadingFinish=!1,this.container=t,this.cadUrl=n+"",this.initViewer()}initViewer(){return new Promise((async(e,t)=>{(new de).load("https://api.ourbim.com:8181/CADFile/FZYaoTi_Regular.json",(e=>{this.font=e})),this.changeProgress(10),this.isLoadingLocal?await this.loadLocalFile():await this.loadOurBimCADFile(),this.changeProgress(100),this.renderer=Dt,this.scene=St,this.camera=Lt,this.controls=Mt,this.addMoveEvent=Ht,this.deleteMoveEvent=Xt,this.modelGroupByLayer=Ft,this.textData=et,this.isLoadingFinish=!0,this.finishCallBack(),e(!0)}))}loadOurBimCADFile(){return new Promise(((e,t)=>{fetch(`http://1.183.136.226:5024/dxfParse?fileName=${this.cadUrl}`,{method:"GET"}).then((e=>e.json())).then((t=>{if(200===t.code){this.changeProgress(55);const n=Number(t.fileName);let a=[];for(let e=0;e<n;e++)a.push(this.getJsonFile(this.cadUrl,e));Promise.all(a).then((async t=>{let n,a="";t.forEach(((e,t)=>{"string"==typeof e?a+=e:a=e})),this.changeProgress(70),n="string"==typeof a?JSON.parse(a):a;const o=Xa(n);this.changeProgress(90),await this.draw(o),e(!0)}))}}))}))}getJsonFile(e,t){return new Promise(((n,a)=>{fetch(`https://api.ourbim.com:8181/CADFile/${e}/${t}.json`).then((e=>e.text())).then((e=>{n(e)}))}))}loadLocalFile(){return new Promise(((t,n)=>{(new e.FileLoader).load(this.cadUrl,(async e=>{this.changeProgress(40);const n=(new aa).parseSync(e);this.changeProgress(70);const a=Xa(n);this.changeProgress(90),await this.draw(a),t(!0)}),(function(e){}),(function(e){console.error("文件加载异常，请检测文件是否存在")}))}))}draw(e){return new Promise(((t,n)=>{null!==this.font?(Rt(e,this.container,this.font),t(!0)):setTimeout((async()=>{await this.draw(e),t(!0)}),200)}))}changeProgress(e){this.progress=e,this.progressCallBack()}registFinishCallBack(e){e&&"function"==typeof e?this.finishCallBack=e:console.warn("加载完成回调函数注册异常，请检查参数是否为响应函数")}registProgressCallBack(e){e&&"function"==typeof e?this.progressCallBack=e:console.warn("进度回调函数注册异常，请检查参数是否为响应函数")}update(){this.renderer=Dt,this.scene=St,this.camera=Lt,this.controls=Mt}}export{Ge as Controller,Ua as Viewer};
